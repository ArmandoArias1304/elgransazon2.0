<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>El Sabor - Dashboard</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#38e07b",
              "primary-dark": "#2bc866",
              "background-light": "#f8faf9",
              "background-dark": "#0f1713",
            },
            fontFamily: {
              display: ["Work Sans"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              xl: "1rem",
              "2xl": "1.5rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700"
      rel="stylesheet"
    />
    <!-- Sistema de Temas (Modo Claro/Oscuro) -->
    <div th:replace="~{fragments/theme :: themeResources}"></div>
    <!-- Sidebar Styles Fragment -->
    <div th:replace="~{fragments/sidebar :: sidebarStyles}"></div>
    <style>
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.7;
        }
      }

      .animate-slide-in {
        animation: slideIn 0.5s ease-out forwards;
      }

      .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      .stat-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(56, 224, 123, 0.1),
          0 10px 10px -5px rgba(56, 224, 123, 0.04);
      }

      .progress-bar {
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .shadow-glow {
        box-shadow: 0 0 20px rgba(56, 224, 123, 0.15);
      }
    </style>
  </head>

  <body
    class="bg-gradient-to-br from-background-light to-gray-50 dark:from-background-dark dark:to-gray-900 font-display text-gray-800 dark:text-gray-200 overflow-hidden"
  >
    <!-- Menu Controls Fragment -->
    <div th:replace="~{fragments/sidebar :: menuControls}"></div>

    <div class="flex min-h-screen h-screen overflow-hidden">
      <!-- SIDEBAR - Using Fragment -->
      <div
        th:replace="~{fragments/sidebar :: sidebar(activeMenu='dashboard')}"
      ></div>

      <main class="flex-1 overflow-y-auto h-screen">
        <div class="p-4 sm:p-6 lg:p-8 pt-20 lg:pt-8">
          <header
            class="mb-6 sm:mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
          >
            <div>
              <h2
                class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white mb-1"
              >
                Dashboard Principal
              </h2>
              <p class="text-sm sm:text-base text-gray-600 dark:text-gray-400">
                Bienvenido de vuelta, aquí está tu resumen del día
              </p>
            </div>
            <div class="flex items-center gap-3 sm:gap-4 w-full sm:w-auto">
              <div
                class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-white dark:bg-gray-900 rounded-xl shadow-md flex-1 sm:flex-none"
              >
                <div
                  class="w-2 h-2 bg-primary rounded-full animate-pulse-slow"
                ></div>
                <p
                  class="text-xs sm:text-sm text-gray-600 dark:text-gray-300 font-medium"
                >
                  En vivo
                </p>
              </div>
              <button
                class="w-10 h-10 bg-white dark:bg-gray-900 rounded-xl shadow-md flex items-center justify-center hover:shadow-lg transition-shadow"
              >
                <span class="material-symbols-outlined text-primary">sync</span>
              </button>
            </div>
          </header>

          <section
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8"
          >
            <!-- Ventas Totales -->
            <div
              class="stat-card bg-gradient-to-br from-white to-gray-50 dark:from-gray-900 dark:to-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-800"
            >
              <div class="flex justify-between items-start mb-3 sm:mb-4">
                <div
                  class="w-10 h-10 sm:w-12 sm:h-12 bg-primary/10 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-primary text-xl sm:text-2xl"
                    >payments</span
                  >
                </div>
                <div
                  th:classappend="${stats.salesIncreased} ? 'bg-green-500/10' : 'bg-red-500/10'"
                  class="flex items-center gap-1 px-2 sm:px-3 py-1 rounded-full"
                >
                  <span
                    th:classappend="${stats.salesIncreased} ? 'text-green-500' : 'text-red-500'"
                    class="material-symbols-outlined text-sm"
                    th:text="${stats.salesIncreased} ? 'arrow_upward' : 'arrow_downward'"
                  ></span>
                  <span
                    th:classappend="${stats.salesIncreased} ? 'text-green-500' : 'text-red-500'"
                    class="font-semibold text-xs"
                    th:text="${stats.salesChangePercentage != null ? '+' + #numbers.formatDecimal(stats.salesChangePercentage, 1, 0) + '%' : '+0%'}"
                  ></span>
                </div>
              </div>
              <div>
                <p
                  class="text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"
                >
                  Ventas Totales
                </p>
                <p
                  class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white"
                  th:text="${stats.todaySales != null ? '$' + #numbers.formatDecimal(stats.todaySales, 1, 2) : '$0.00'}"
                >
                  $3,150
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                  vs ayer
                </p>
              </div>
            </div>

            <!-- Órdenes -->
            <div
              class="stat-card bg-gradient-to-br from-white to-gray-50 dark:from-gray-900 dark:to-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-800"
            >
              <div class="flex justify-between items-start mb-3 sm:mb-4">
                <div
                  class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-500/10 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-blue-500 text-xl sm:text-2xl"
                    >shopping_cart</span
                  >
                </div>
                <div
                  th:classappend="${stats.ordersIncreased} ? 'bg-green-500/10' : 'bg-red-500/10'"
                  class="flex items-center gap-1 px-2 sm:px-3 py-1 rounded-full"
                >
                  <span
                    th:classappend="${stats.ordersIncreased} ? 'text-green-500' : 'text-red-500'"
                    class="material-symbols-outlined text-sm"
                    th:text="${stats.ordersIncreased} ? 'arrow_upward' : 'arrow_downward'"
                  ></span>
                  <span
                    th:classappend="${stats.ordersIncreased} ? 'text-green-500' : 'text-red-500'"
                    class="font-semibold text-xs"
                    th:text="${stats.ordersChangePercentage != null ? '+' + #numbers.formatDecimal(stats.ordersChangePercentage, 1, 0) + '%' : '+0%'}"
                  ></span>
                </div>
              </div>
              <div>
                <p
                  class="text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"
                >
                  Órdenes
                </p>
                <p
                  class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white"
                  th:text="${stats.todayOrders != null ? stats.todayOrders : 0}"
                >
                  152
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                  vs ayer
                </p>
              </div>
            </div>

            <!-- Clientes -->
            <div
              class="stat-card bg-gradient-to-br from-white to-gray-50 dark:from-gray-900 dark:to-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-800"
            >
              <div class="flex justify-between items-start mb-3 sm:mb-4">
                <div
                  class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-500/10 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-purple-500 text-xl sm:text-2xl"
                    >person</span
                  >
                </div>
                <div
                  th:classappend="${stats.customersIncreased} ? 'bg-green-500/10' : 'bg-red-500/10'"
                  class="flex items-center gap-1 px-2 sm:px-3 py-1 rounded-full"
                >
                  <span
                    th:classappend="${stats.customersIncreased} ? 'text-green-500' : 'text-red-500'"
                    class="material-symbols-outlined text-sm"
                    th:text="${stats.customersIncreased} ? 'arrow_upward' : 'arrow_downward'"
                  ></span>
                  <span
                    th:classappend="${stats.customersIncreased} ? 'text-green-500' : 'text-red-500'"
                    class="font-semibold text-xs"
                    th:text="${stats.customersChangePercentage != null ? '+' + #numbers.formatDecimal(stats.customersChangePercentage, 1, 0) + '%' : '+0%'}"
                  ></span>
                </div>
              </div>
              <div>
                <p
                  class="text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"
                >
                  Clientes
                </p>
                <p
                  class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white"
                  th:text="${stats.todayCustomers != null ? stats.todayCustomers : 0}"
                >
                  89
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                  vs ayer
                </p>
              </div>
            </div>

            <!-- Ingresos Totales (Histórico) -->
            <div
              class="stat-card bg-gradient-to-br from-primary to-primary-dark p-4 sm:p-6 rounded-2xl shadow-lg shadow-primary/30 text-white"
            >
              <div class="flex justify-between items-start mb-3 sm:mb-4">
                <div
                  class="w-10 h-10 sm:w-12 sm:h-12 bg-white/20 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-white text-xl sm:text-2xl"
                    >account_balance</span
                  >
                </div>
                <div
                  class="flex items-center gap-1 px-2 sm:px-3 py-1 bg-white/20 rounded-full"
                >
                  <span class="material-symbols-outlined text-white text-sm"
                    >trending_up</span
                  >
                </div>
              </div>
              <div>
                <p class="text-xs sm:text-sm font-medium text-white/80 mb-1">
                  Ingresos Totales
                </p>
                <p
                  class="text-2xl sm:text-3xl font-bold text-white"
                  th:text="${stats.totalHistoricalRevenue != null ? '$' + #numbers.formatDecimal(stats.totalHistoricalRevenue, 1, 2) : '$0.00'}"
                >
                  $4,500
                </p>
                <p class="text-xs text-white/70 mt-1">Desde el inicio</p>
              </div>
            </div>
          </section>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <div class="lg:col-span-2">
              <div
                class="bg-white dark:bg-gray-900 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-800 p-4 sm:p-6"
              >
                <div
                  class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-3"
                >
                  <div>
                    <h3
                      class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white"
                    >
                      Platos Más Populares
                    </h3>
                    <p
                      class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 mt-1"
                    >
                      Ranking de ventas de hoy
                    </p>
                  </div>
                  <select
                    id="popularItemsFilter"
                    class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-gray-100 dark:bg-gray-800 border-none rounded-xl text-xs sm:text-sm text-gray-700 dark:text-gray-300 font-medium focus:ring-2 focus:ring-primary"
                  >
                    <option value="today">Hoy</option>
                    <option value="week">Esta semana</option>
                    <option value="month">Este mes</option>
                  </select>
                </div>

                <div id="popularItemsContainer" class="space-y-4 sm:space-y-5">
                  <!-- Loop through popular items from database -->
                  <div
                    th:each="item, iterStat : ${stats.popularItems}"
                    class="flex items-center gap-3 sm:gap-4"
                  >
                    <div
                      th:class="'w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br ' + ${item.badgeGradient} + ' rounded-xl flex items-center justify-center text-white font-bold shadow-lg flex-shrink-0'"
                      th:classappend="${item.rank == 1} ? 'shadow-primary/30' : (${item.rank == 2} ? 'shadow-blue-500/30' : (${item.rank == 3} ? 'shadow-purple-500/30' : 'shadow-orange-500/30'))"
                    >
                      <span th:text="${item.rank}">1</span>
                    </div>
                    <div class="flex-1 min-w-0">
                      <p
                        class="font-semibold text-sm sm:text-base text-gray-800 dark:text-gray-200 mb-2"
                        th:text="${item.itemName}"
                      >
                        Nombre del plato
                      </p>
                      <div
                        class="relative w-full bg-gray-200 dark:bg-gray-800 rounded-full h-2.5 sm:h-3 overflow-hidden"
                      >
                        <div
                          th:class="'progress-bar absolute top-0 left-0 h-full rounded-full ' + (${item.rank == 1} ? 'bg-gradient-to-r from-primary to-primary-dark shadow-glow' : (${item.rank == 2} ? 'bg-gradient-to-r from-blue-400 to-blue-600' : (${item.rank == 3} ? 'bg-gradient-to-r from-purple-400 to-purple-600' : 'bg-gradient-to-r from-orange-400 to-orange-600')))"
                          th:style="'width: ' + ${item.percentage} + '%'"
                        ></div>
                      </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                      <p
                        th:class="'text-xl sm:text-2xl font-bold text-' + ${item.color}"
                        th:text="${item.orderCount}"
                      >
                        0
                      </p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">
                        órdenes
                      </p>
                    </div>
                  </div>

                  <!-- Show message if no popular items -->
                  <div
                    th:if="${#lists.isEmpty(stats.popularItems)}"
                    class="flex flex-col items-center justify-center p-8 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700"
                  >
                    <span
                      class="material-symbols-outlined text-gray-400 text-5xl mb-3"
                      >restaurant_menu</span
                    >
                    <p
                      class="text-sm text-gray-500 dark:text-gray-400 text-center"
                    >
                      No hay órdenes registradas aún
                    </p>
                    <p
                      class="text-xs text-gray-400 dark:text-gray-500 text-center mt-1"
                    >
                      Los platos más populares aparecerán aquí
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="space-y-4 sm:space-y-6">
              <div
                class="bg-white dark:bg-gray-900 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-800 p-4 sm:p-6"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white"
                  >
                    Inventario
                  </h3>
                  <div
                    class="w-8 h-8 sm:w-10 sm:h-10 bg-primary/10 rounded-xl flex items-center justify-center"
                  >
                    <span
                      class="material-symbols-outlined text-primary text-lg sm:text-xl"
                      >inventory_2</span
                    >
                  </div>
                </div>

                <div class="space-y-2.5 sm:space-y-3">
                  <!-- Display inventory alerts from database (max 5) -->

                  <!-- Red alert - Out of stock -->
                  <div
                    th:each="alert, iterStat : ${stats.inventoryAlerts}"
                    th:if="${iterStat.index < 5 and alert.status == 'out-of-stock'}"
                    class="flex justify-between items-center p-2.5 sm:p-3 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-200 dark:border-red-800"
                  >
                    <div class="flex items-center gap-2 sm:gap-3 min-w-0">
                      <span
                        class="material-symbols-outlined text-red-600 dark:text-red-500 text-lg sm:text-xl flex-shrink-0"
                        >error</span
                      >
                      <p
                        class="font-medium text-sm sm:text-base text-gray-800 dark:text-gray-200 truncate"
                        th:text="${alert.ingredientName}"
                      >
                        Ingredient Name
                      </p>
                    </div>
                    <span
                      class="text-red-600 dark:text-red-500 font-semibold text-xs sm:text-sm whitespace-nowrap ml-2"
                      >Agotado</span
                    >
                  </div>

                  <!-- Yellow alert - Low stock -->
                  <div
                    th:each="alert, iterStat : ${stats.inventoryAlerts}"
                    th:if="${iterStat.index < 5 and alert.status == 'low-stock'}"
                    class="flex justify-between items-center p-2.5 sm:p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl border border-yellow-200 dark:border-yellow-800"
                  >
                    <div class="flex items-center gap-2 sm:gap-3 min-w-0">
                      <span
                        class="material-symbols-outlined text-yellow-600 dark:text-yellow-500 text-lg sm:text-xl flex-shrink-0"
                        >warning</span
                      >
                      <p
                        class="font-medium text-sm sm:text-base text-gray-800 dark:text-gray-200 truncate"
                        th:text="${alert.ingredientName}"
                      >
                        Ingredient Name
                      </p>
                    </div>
                    <span
                      class="text-yellow-600 dark:text-yellow-500 font-semibold text-xs sm:text-sm whitespace-nowrap ml-2"
                      >Bajo stock</span
                    >
                  </div>

                  <!-- Green alert - Healthy stock -->
                  <div
                    th:each="alert, iterStat : ${stats.inventoryAlerts}"
                    th:if="${iterStat.index < 5 and alert.status == 'healthy'}"
                    class="flex justify-between items-center p-2.5 sm:p-3 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800"
                  >
                    <div class="flex items-center gap-2 sm:gap-3 min-w-0">
                      <span
                        class="material-symbols-outlined text-green-600 dark:text-green-500 text-lg sm:text-xl flex-shrink-0"
                        >check_circle</span
                      >
                      <p
                        class="font-medium text-sm sm:text-base text-gray-800 dark:text-gray-200 truncate"
                        th:text="${alert.ingredientName}"
                      >
                        Ingredient Name
                      </p>
                    </div>
                    <span
                      class="text-green-600 dark:text-green-500 font-semibold text-xs sm:text-sm whitespace-nowrap ml-2"
                      >En stock</span
                    >
                  </div>

                  <!-- Show message if no alerts -->
                  <div
                    th:if="${#lists.isEmpty(stats.inventoryAlerts)}"
                    class="flex justify-center items-center p-4 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700"
                  >
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                      No hay alertas de inventario
                    </p>
                  </div>
                </div>

                <a
                  class="flex items-center justify-center gap-2 mt-4 py-2 text-primary hover:text-primary-dark font-semibold text-xs sm:text-sm transition-colors"
                  th:href="@{/admin/ingredients}"
                >
                  Ver inventario completo
                  <span class="material-symbols-outlined text-sm"
                    >arrow_forward</span
                  >
                </a>
              </div>

              <div
                class="bg-gradient-to-br from-primary to-primary-dark rounded-2xl shadow-lg shadow-primary/30 p-4 sm:p-6 text-white"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg sm:text-xl font-bold">
                    Empleados Activos
                  </h3>
                  <div
                    class="w-8 h-8 sm:w-10 sm:h-10 bg-white/20 rounded-xl flex items-center justify-center"
                  >
                    <span class="material-symbols-outlined text-lg sm:text-xl"
                      >group</span
                    >
                  </div>
                </div>

                <div class="flex items-end justify-between mb-4">
                  <div>
                    <p class="text-xs sm:text-sm text-white/80 mb-1">
                      Total en turno
                    </p>
                    <p
                      class="text-3xl sm:text-4xl font-bold"
                      th:text="${stats.activeEmployees != null ? stats.activeEmployees : 0}"
                    >
                      8
                    </p>
                  </div>
                  <div class="text-right">
                    <p class="text-xs sm:text-sm text-white/80">Capacidad</p>
                    <p
                      class="text-lg sm:text-xl font-semibold"
                      th:text="${stats.capacityPercentage != null ? #numbers.formatDecimal(stats.capacityPercentage, 1, 0) + '%' : '0%'}"
                    >
                      80%
                    </p>
                  </div>
                </div>

                <div class="flex -space-x-2 sm:-space-x-3 mb-4">
                  <div
                    th:each="initials, iterStat : ${stats.employeeInitials}"
                    th:class="'w-10 h-10 sm:w-12 sm:h-12 rounded-full ring-2 sm:ring-4 ring-primary flex items-center justify-center text-white font-bold text-xs sm:text-sm shadow-lg ' + (${iterStat.index == 0} ? 'bg-gradient-to-br from-blue-400 to-blue-600' : (${iterStat.index == 1} ? 'bg-gradient-to-br from-purple-400 to-purple-600' : (${iterStat.index == 2} ? 'bg-gradient-to-br from-pink-400 to-pink-600' : 'bg-gradient-to-br from-orange-400 to-orange-600')))"
                    th:text="${initials}"
                  >
                    JD
                  </div>
                  <button
                    th:if="${stats.activeEmployees > 4}"
                    class="w-10 h-10 sm:w-12 sm:h-12 rounded-full ring-2 sm:ring-4 ring-primary bg-white/20 hover:bg-white/30 flex items-center justify-center text-white font-bold text-xs sm:text-sm transition-colors"
                    th:text="'+' + (${stats.activeEmployees} - 4)"
                  >
                    +4
                  </button>
                </div>

                <a
                  th:href="@{/admin/employees}"
                  class="w-full py-2 bg-white/20 hover:bg-white/30 rounded-xl font-semibold text-xs sm:text-sm transition-colors block text-center"
                >
                  Ver todos los empleados
                </a>
              </div>
            </div>
          </div>

          <!-- NEW: Additional Dashboard Widgets -->
          <div
            class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mt-6 sm:mt-8"
          >
            <!-- Hourly Sales Chart -->
            <div
              class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-4 sm:p-6"
            >
              <div class="flex items-center justify-between mb-4">
                <h3
                  class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white"
                >
                  Ventas por Hora
                </h3>
                <div
                  class="w-8 h-8 sm:w-10 sm:h-10 bg-primary/10 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-lg sm:text-xl text-primary"
                    >show_chart</span
                  >
                </div>
              </div>
              <canvas
                id="hourlySalesChart"
                class="w-full"
                style="max-height: 300px"
              ></canvas>
            </div>

            <!-- Real-time Table Status -->
            <div
              class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-4 sm:p-6"
            >
              <div class="flex items-center justify-between mb-4">
                <h3
                  class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white"
                >
                  Estado de Mesas
                </h3>
                <div
                  class="w-8 h-8 sm:w-10 sm:h-10 bg-primary/10 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-lg sm:text-xl text-primary"
                    >table_restaurant</span
                  >
                </div>
              </div>

              <div class="grid grid-cols-2 gap-3 sm:gap-4">
                <div
                  class="bg-green-50 dark:bg-green-900/20 rounded-xl p-3 sm:p-4 border border-green-200 dark:border-green-800"
                >
                  <div class="flex items-center gap-2 mb-2">
                    <span
                      class="material-symbols-outlined text-green-600 dark:text-green-500"
                      >check_circle</span
                    >
                    <p
                      class="text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300"
                    >
                      Disponibles
                    </p>
                  </div>
                  <p
                    class="text-2xl sm:text-3xl font-bold text-green-600 dark:text-green-500"
                    th:text="${stats.tableStatus != null ? stats.tableStatus.available : 0}"
                  >
                    0
                  </p>
                </div>

                <div
                  class="bg-red-50 dark:bg-red-900/20 rounded-xl p-3 sm:p-4 border border-red-200 dark:border-red-800"
                >
                  <div class="flex items-center gap-2 mb-2">
                    <span
                      class="material-symbols-outlined text-red-600 dark:text-red-500"
                      >group</span
                    >
                    <p
                      class="text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300"
                    >
                      Ocupadas
                    </p>
                  </div>
                  <p
                    class="text-2xl sm:text-3xl font-bold text-red-600 dark:text-red-500"
                    th:text="${stats.tableStatus != null ? stats.tableStatus.occupied : 0}"
                  >
                    0
                  </p>
                </div>

                <div
                  class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-3 sm:p-4 border border-blue-200 dark:border-blue-800"
                >
                  <div class="flex items-center gap-2 mb-2">
                    <span
                      class="material-symbols-outlined text-blue-600 dark:text-blue-500"
                      >event</span
                    >
                    <p
                      class="text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300"
                    >
                      Reservadas
                    </p>
                  </div>
                  <p
                    class="text-2xl sm:text-3xl font-bold text-blue-600 dark:text-blue-500"
                    th:text="${stats.tableStatus != null ? stats.tableStatus.reserved : 0}"
                  >
                    0
                  </p>
                </div>

                <div
                  class="bg-gray-50 dark:bg-gray-700 rounded-xl p-3 sm:p-4 border border-gray-200 dark:border-gray-600"
                >
                  <div class="flex items-center gap-2 mb-2">
                    <span
                      class="material-symbols-outlined text-gray-600 dark:text-gray-400"
                      >block</span
                    >
                    <p
                      class="text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300"
                    >
                      Fuera de servicio
                    </p>
                  </div>
                  <p
                    class="text-2xl sm:text-3xl font-bold text-gray-600 dark:text-gray-400"
                    th:text="${stats.tableStatus != null ? stats.tableStatus.outOfService : 0}"
                  >
                    0
                  </p>
                </div>
              </div>

              <div
                class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700"
              >
                <div class="flex justify-between items-center">
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    Total de mesas
                  </p>
                  <p
                    class="text-lg font-bold text-gray-900 dark:text-white"
                    th:text="${stats.tableStatus != null ? stats.tableStatus.totalTables : 0}"
                  >
                    0
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Orders & Today's Reservations -->
          <div
            class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mt-6 sm:mt-8"
          >
            <!-- Pending Orders -->
            <div
              class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-4 sm:p-6"
            >
              <div class="flex items-center justify-between mb-4">
                <h3
                  class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white"
                >
                  Pedidos en Proceso
                </h3>
                <div
                  class="w-8 h-8 sm:w-10 sm:h-10 bg-primary/10 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-lg sm:text-xl text-primary"
                    >pending_actions</span
                  >
                </div>
              </div>

              <div class="grid grid-cols-2 gap-3 mb-4">
                <div
                  class="bg-yellow-50 dark:bg-yellow-900/20 rounded-xl p-3 border border-yellow-200 dark:border-yellow-800"
                >
                  <p
                    class="text-xs font-medium text-yellow-700 dark:text-yellow-400 mb-1"
                  >
                    Pendientes
                  </p>
                  <p
                    id="pending-orders-count"
                    class="text-2xl font-bold text-yellow-600 dark:text-yellow-500"
                    th:text="${stats.pendingOrders != null ? stats.pendingOrders.pending : 0}"
                  >
                    0
                  </p>
                </div>

                <div
                  class="bg-orange-50 dark:bg-orange-900/20 rounded-xl p-3 border border-orange-200 dark:border-orange-800"
                >
                  <p
                    class="text-xs font-medium text-orange-700 dark:text-orange-400 mb-1"
                  >
                    En preparación
                  </p>
                  <p
                    id="in-preparation-orders-count"
                    class="text-2xl font-bold text-orange-600 dark:text-orange-500"
                    th:text="${stats.pendingOrders != null ? stats.pendingOrders.inPreparation : 0}"
                  >
                    0
                  </p>
                </div>

                <div
                  class="bg-green-50 dark:bg-green-900/20 rounded-xl p-3 border border-green-200 dark:border-green-800"
                >
                  <p
                    class="text-xs font-medium text-green-700 dark:text-green-400 mb-1"
                  >
                    Listos
                  </p>
                  <p
                    id="ready-orders-count"
                    class="text-2xl font-bold text-green-600 dark:text-green-500"
                    th:text="${stats.pendingOrders != null ? stats.pendingOrders.ready : 0}"
                  >
                    0
                  </p>
                </div>

                <div
                  class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-3 border border-blue-200 dark:border-blue-800"
                >
                  <p
                    class="text-xs font-medium text-blue-700 dark:text-blue-400 mb-1"
                  >
                    En camino
                  </p>
                  <p
                    id="on-the-way-orders-count"
                    class="text-2xl font-bold text-blue-600 dark:text-blue-500"
                    th:text="${stats.pendingOrders != null ? stats.pendingOrders.onTheWay : 0}"
                  >
                    0
                  </p>
                </div>
              </div>

              <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-3">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span
                      class="material-symbols-outlined text-gray-600 dark:text-gray-400 text-lg"
                      >schedule</span
                    >
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                      Tiempo promedio
                    </p>
                  </div>
                  <p class="text-lg font-bold text-gray-900 dark:text-white">
                    <span
                      id="avg-preparation-time"
                      th:text="${stats.pendingOrders != null ? #numbers.formatDecimal(stats.pendingOrders.avgPreparationTime, 1, 0) : 0}"
                      >0</span
                    >
                    min
                  </p>
                </div>
              </div>
            </div>

            <!-- Today's Reservations -->
            <div
              class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-4 sm:p-6"
            >
              <div class="flex items-center justify-between mb-4">
                <h3
                  class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white"
                >
                  Reservaciones de Hoy
                </h3>
                <div
                  class="w-8 h-8 sm:w-10 sm:h-10 bg-primary/10 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-lg sm:text-xl text-primary"
                    >event_available</span
                  >
                </div>
              </div>

              <div class="space-y-3 max-h-80 overflow-y-auto">
                <div
                  th:if="${stats.todayReservations == null or stats.todayReservations.isEmpty()}"
                  class="flex flex-col items-center justify-center py-8 text-gray-400"
                >
                  <span class="material-symbols-outlined text-4xl mb-2"
                    >event_busy</span
                  >
                  <p class="text-sm">No hay reservaciones próximas</p>
                </div>

                <div
                  th:each="reservation : ${stats.todayReservations}"
                  class="bg-gray-50 dark:bg-gray-700 rounded-xl p-3 border border-gray-200 dark:border-gray-600"
                >
                  <div class="flex items-start justify-between mb-2">
                    <div class="flex-1 min-w-0">
                      <p
                        class="font-semibold text-gray-900 dark:text-white truncate"
                        th:text="${reservation.customerName}"
                      >
                        Cliente
                      </p>
                      <div class="flex items-center gap-2 mt-1">
                        <span
                          class="material-symbols-outlined text-sm text-gray-500"
                          >schedule</span
                        >
                        <p
                          class="text-sm text-gray-600 dark:text-gray-400"
                          th:text="${reservation.time}"
                        >
                          15:30
                        </p>
                      </div>
                    </div>
                    <span
                      th:class="'px-2 py-1 rounded-lg text-xs font-medium ' + ${reservation.statusColor}"
                      th:text="${reservation.status}"
                      >Confirmada</span
                    >
                  </div>
                  <div
                    class="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400"
                  >
                    <div class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-sm"
                        >group</span
                      >
                      <span th:text="${reservation.partySize} + ' personas'"
                        >2 personas</span
                      >
                    </div>
                    <div class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-sm"
                        >table_restaurant</span
                      >
                      <span th:text="'Mesa ' + ${reservation.tableNumber}"
                        >Mesa 5</span
                      >
                    </div>
                  </div>
                </div>
              </div>

              <a
                th:href="@{/admin/reservations}"
                class="flex items-center justify-center gap-2 mt-4 py-2 text-primary hover:text-primary-dark font-semibold text-xs sm:text-sm transition-colors"
              >
                Ver todas las reservaciones
                <span class="material-symbols-outlined text-sm"
                  >arrow_forward</span
                >
              </a>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Sidebar Scripts Fragment -->
    <div th:replace="~{fragments/sidebar :: sidebarScripts}"></div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Hourly Sales Chart Script -->
    <script th:inline="javascript">
      /*<![CDATA[*/
      document.addEventListener("DOMContentLoaded", function () {
        const hourlySalesData = /*[[${stats.hourlySales}]]*/ [];

        if (hourlySalesData && hourlySalesData.length > 0) {
          const ctx = document
            .getElementById("hourlySalesChart")
            .getContext("2d");

          const hours = hourlySalesData.map((item) => item.hour + ":00");
          const sales = hourlySalesData.map((item) => item.sales);
          const orderCounts = hourlySalesData.map((item) => item.orderCount);

          new Chart(ctx, {
            type: "bar",
            data: {
              labels: hours,
              datasets: [
                {
                  label: "Ventas ($)",
                  data: sales,
                  backgroundColor: "rgba(56, 224, 123, 0.6)",
                  borderColor: "rgba(56, 224, 123, 1)",
                  borderWidth: 2,
                  borderRadius: 8,
                  yAxisID: "y",
                },
                {
                  label: "Pedidos",
                  data: orderCounts,
                  type: "line",
                  borderColor: "rgba(59, 130, 246, 1)",
                  backgroundColor: "rgba(59, 130, 246, 0.1)",
                  borderWidth: 2,
                  tension: 0.4,
                  yAxisID: "y1",
                  pointRadius: 4,
                  pointHoverRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: "index",
                intersect: false,
              },
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                  labels: {
                    usePointStyle: true,
                    padding: 15,
                    font: {
                      size: 12,
                    },
                  },
                },
                tooltip: {
                  backgroundColor: "rgba(0, 0, 0, 0.8)",
                  padding: 12,
                  titleFont: {
                    size: 14,
                  },
                  bodyFont: {
                    size: 13,
                  },
                  callbacks: {
                    label: function (context) {
                      let label = context.dataset.label || "";
                      if (label) {
                        label += ": ";
                      }
                      if (context.datasetIndex === 0) {
                        label += "$" + context.parsed.y.toFixed(2);
                      } else {
                        label += context.parsed.y;
                      }
                      return label;
                    },
                  },
                },
              },
              scales: {
                x: {
                  grid: {
                    display: false,
                  },
                  ticks: {
                    maxRotation: 45,
                    minRotation: 0,
                    font: {
                      size: 11,
                    },
                  },
                },
                y: {
                  type: "linear",
                  display: true,
                  position: "left",
                  title: {
                    display: true,
                    text: "Ventas ($)",
                    font: {
                      size: 12,
                    },
                  },
                  grid: {
                    color: "rgba(0, 0, 0, 0.05)",
                  },
                },
                y1: {
                  type: "linear",
                  display: true,
                  position: "right",
                  title: {
                    display: true,
                    text: "Pedidos",
                    font: {
                      size: 12,
                    },
                  },
                  grid: {
                    drawOnChartArea: false,
                  },
                },
              },
            },
          });
        }
      });
      /*]]>*/
    </script>

    <!-- Popular Items Filter Script -->
    <script th:inline="javascript">
      /*<![CDATA[*/
      document.addEventListener("DOMContentLoaded", function () {
        const filterSelect = document.getElementById("popularItemsFilter");
        const container = document.getElementById("popularItemsContainer");

        // Initial data from Thymeleaf
        const initialItems = /*[[${stats.popularItems}]]*/ [];

        // Render initial items
        renderPopularItems(initialItems);

        // Add change event listener
        filterSelect.addEventListener("change", function () {
          const period = this.value;
          fetchPopularItems(period);
        });

        function fetchPopularItems(period) {
          // Show loading state
          container.innerHTML = `
            <div class="flex items-center justify-center p-8">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            </div>
          `;

          // Fetch data from server
          fetch("/admin/dashboard/popular-items?period=" + period)
            .then((response) => response.json())
            .then((data) => {
              renderPopularItems(data);
            })
            .catch((error) => {
              console.error("Error fetching popular items:", error);
              container.innerHTML = `
                <div class="flex items-center justify-center p-8 text-red-500">
                  <p>Error al cargar los datos</p>
                </div>
              `;
            });
        }

        function renderPopularItems(items) {
          if (!items || items.length === 0) {
            container.innerHTML = `
              <div class="flex flex-col items-center justify-center p-8 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                <span class="material-symbols-outlined text-gray-400 text-5xl mb-3">restaurant_menu</span>
                <p class="text-sm text-gray-500 dark:text-gray-400 text-center">
                  No hay órdenes registradas para este período
                </p>
                <p class="text-xs text-gray-400 dark:text-gray-500 text-center mt-1">
                  Los platos más populares aparecerán aquí
                </p>
              </div>
            `;
            return;
          }

          const colors = [
            "primary",
            "blue-500",
            "purple-500",
            "orange-500",
            "pink-500",
            "indigo-500",
            "teal-500",
            "amber-500",
            "rose-500",
            "cyan-500",
          ];
          const gradients = [
            "from-primary to-primary-dark",
            "from-blue-400 to-blue-600",
            "from-purple-400 to-purple-600",
            "from-orange-400 to-orange-600",
            "from-pink-400 to-pink-600",
            "from-indigo-400 to-indigo-600",
            "from-teal-400 to-teal-600",
            "from-amber-400 to-amber-600",
            "from-rose-400 to-rose-600",
            "from-cyan-400 to-cyan-600",
          ];
          const shadows = [
            "shadow-primary/30",
            "shadow-blue-500/30",
            "shadow-purple-500/30",
            "shadow-orange-500/30",
            "shadow-pink-500/30",
            "shadow-indigo-500/30",
            "shadow-teal-500/30",
            "shadow-amber-500/30",
            "shadow-rose-500/30",
            "shadow-cyan-500/30",
          ];

          let html = "";
          items.forEach((item, index) => {
            const rank = item.rank;
            const colorIndex = (rank - 1) % colors.length;
            const color = colors[colorIndex];
            const gradient = gradients[colorIndex];
            const shadow = shadows[colorIndex];

            // Define progress gradient based on rank
            const progressGradients = [
              "bg-gradient-to-r from-primary to-primary-dark shadow-glow",
              "bg-gradient-to-r from-blue-400 to-blue-600",
              "bg-gradient-to-r from-purple-400 to-purple-600",
              "bg-gradient-to-r from-orange-400 to-orange-600",
              "bg-gradient-to-r from-pink-400 to-pink-600",
              "bg-gradient-to-r from-indigo-400 to-indigo-600",
              "bg-gradient-to-r from-teal-400 to-teal-600",
              "bg-gradient-to-r from-amber-400 to-amber-600",
              "bg-gradient-to-r from-rose-400 to-rose-600",
              "bg-gradient-to-r from-cyan-400 to-cyan-600",
            ];
            const progressGradient = progressGradients[colorIndex];

            html += `
              <div class="flex items-center gap-3 sm:gap-4">
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br ${gradient} ${shadow} rounded-xl flex items-center justify-center text-white font-bold shadow-lg flex-shrink-0">
                  <span>${rank}</span>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="font-semibold text-sm sm:text-base text-gray-800 dark:text-gray-200 mb-2">
                    ${item.itemName}
                  </p>
                  <div class="relative w-full bg-gray-200 dark:bg-gray-800 rounded-full h-2.5 sm:h-3 overflow-hidden">
                    <div class="progress-bar absolute top-0 left-0 h-full rounded-full ${progressGradient}" style="width: ${item.percentage}%"></div>
                  </div>
                </div>
                <div class="text-right flex-shrink-0">
                  <p class="text-xl sm:text-2xl font-bold text-${color}">
                    ${item.orderCount}
                  </p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">
                    órdenes
                  </p>
                </div>
              </div>
            `;
          });

          container.innerHTML = html;
        }
      });
      /*]]>*/
    </script>

    <!-- WebSocket for Real-time Updates -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
      let stompClient = null;
      let updateTimeout = null;
      let pendingUpdate = false;
      const UPDATE_DELAY = 3000; // Wait 3 seconds before updating

      // Reconnection control
      let reconnectAttempts = 0;
      let maxReconnectAttempts = 10;
      let reconnectDelay = 1000;
      let maxReconnectDelay = 30000;
      let isIntentionalDisconnect = false;

      function connectAdminDashboardWebSocket() {
        if (reconnectAttempts >= maxReconnectAttempts) {
          console.warn(
            "⛔ ADMIN: Máximo de intentos de reconexión alcanzado. Deteniendo..."
          );
          return;
        }

        console.log(
          `🔄 ADMIN Dashboard: Intento de conexión #${reconnectAttempts + 1}`
        );
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // Disable console logging

        stompClient.connect(
          {},
          function (frame) {
            console.log("✅ Admin Dashboard WebSocket Connected");
            reconnectAttempts = 0;
            reconnectDelay = 1000;

            // Subscribe to admin kitchen channel for order updates
            stompClient.subscribe("/topic/admin/kitchen", function (message) {
              const notification = JSON.parse(message.body);
              console.log(
                "📦 Notification received - Type:",
                notification.notificationType
              );
              handleDashboardOrderUpdate(notification);
            });
          },
          function (error) {
            if (isIntentionalDisconnect) {
              console.log("👋 ADMIN Dashboard: Desconexión intencional");
              return;
            }

            reconnectAttempts++;
            console.error(
              `❌ ADMIN Dashboard: WebSocket Error (${reconnectAttempts}/${maxReconnectAttempts}):`,
              error
            );

            if (reconnectAttempts < maxReconnectAttempts) {
              const delay = Math.min(
                reconnectDelay * Math.pow(2, reconnectAttempts - 1),
                maxReconnectDelay
              );
              console.log(
                `⏱️ ADMIN Dashboard: Reintentando en ${delay / 1000}s...`
              );
              setTimeout(connectAdminDashboardWebSocket, delay);
            }
          }
        );
      }

      function handleDashboardOrderUpdate(notification) {
        // Debounce: Cancel previous timeout and set new one
        if (updateTimeout) {
          clearTimeout(updateTimeout);
          console.log("⏳ Debouncing update...");
        }

        pendingUpdate = true;

        // Only update after 3 seconds of no new notifications
        updateTimeout = setTimeout(() => {
          if (pendingUpdate) {
            console.log("🔄 Updating dashboard stats (debounced)...");
            pendingUpdate = false;
            fetchAndUpdateStats();
          }
        }, UPDATE_DELAY);
      }

      function fetchAndUpdateStats() {
        fetch("/admin/dashboard/stats")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Stats fetch failed: " + response.status);
            }
            return response.json();
          })
          .then((data) => {
            console.log("📊 Stats received, updating UI...");
            updateDashboardStats(data);
          })
          .catch((error) => console.error("❌ Error updating stats:", error));
      }

      function updateDashboardStats(stats) {
        let updatedCount = 0;

        // Update Today's Sales
        const todaySalesEl = document.querySelector(
          '[th\\:text*="todaySales"]'
        );
        if (todaySalesEl && stats.todaySales != null) {
          todaySalesEl.textContent = "$" + stats.todaySales.toFixed(2);
          updatedCount++;
        }

        // Update Today's Orders
        const todayOrdersEl = document.querySelector(
          '[th\\:text*="todayOrders"]'
        );
        if (todayOrdersEl && stats.todayOrders != null) {
          todayOrdersEl.textContent = stats.todayOrders;
          updatedCount++;
        }

        // Update Today's Customers
        const todayCustomersEl = document.querySelector(
          '[th\\:text*="todayCustomers"]'
        );
        if (todayCustomersEl && stats.todayCustomers != null) {
          todayCustomersEl.textContent = stats.todayCustomers;
          updatedCount++;
        }

        // Update Total Revenue
        const totalRevenueEl = document.querySelector(
          '[th\\:text*="totalHistoricalRevenue"]'
        );
        if (totalRevenueEl && stats.totalHistoricalRevenue != null) {
          totalRevenueEl.textContent =
            "$" + stats.totalHistoricalRevenue.toFixed(2);
          updatedCount++;
        }

        // Update Pending Orders Section using IDs
        if (stats.pendingOrders) {
          // Pending
          const pendingEl = document.getElementById("pending-orders-count");
          if (pendingEl && stats.pendingOrders.pending != null) {
            pendingEl.textContent = stats.pendingOrders.pending;
            updatedCount++;
          }

          // In Preparation
          const inPrepEl = document.getElementById(
            "in-preparation-orders-count"
          );
          if (inPrepEl && stats.pendingOrders.inPreparation != null) {
            inPrepEl.textContent = stats.pendingOrders.inPreparation;
            updatedCount++;
          }

          // Ready
          const readyEl = document.getElementById("ready-orders-count");
          if (readyEl && stats.pendingOrders.ready != null) {
            readyEl.textContent = stats.pendingOrders.ready;
            updatedCount++;
          }

          // On The Way
          const onTheWayEl = document.getElementById("on-the-way-orders-count");
          if (onTheWayEl && stats.pendingOrders.onTheWay != null) {
            onTheWayEl.textContent = stats.pendingOrders.onTheWay;
            updatedCount++;
          }

          // Average Preparation Time
          const avgTimeEl = document.getElementById("avg-preparation-time");
          if (avgTimeEl && stats.pendingOrders.avgPreparationTime != null) {
            avgTimeEl.textContent = Math.round(
              stats.pendingOrders.avgPreparationTime
            );
            updatedCount++;
          }
        }

        // Add subtle visual feedback only if something was updated
        if (updatedCount > 0) {
          document.body.classList.add("bg-primary/5");
          setTimeout(() => {
            document.body.classList.remove("bg-primary/5");
          }, 500);
          console.log("✅ Dashboard updated -", updatedCount, "fields changed");
        }
      }

      // Connect on page load
      document.addEventListener("DOMContentLoaded", function () {
        connectAdminDashboardWebSocket();
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", function () {
        console.log("👋 ADMIN Dashboard: Página cerrándose...");
        isIntentionalDisconnect = true;

        if (updateTimeout) {
          clearTimeout(updateTimeout);
        }
        if (stompClient !== null && stompClient.connected) {
          stompClient.disconnect();
        }
      });
    </script>

    <!-- Script del Sistema de Temas -->
    <div th:replace="~{fragments/theme :: themeScript}"></div>
  </body>
</html>
