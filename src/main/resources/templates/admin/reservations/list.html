<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Gran Sazón - Reservaciones</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700"
      rel="stylesheet"
    />
    
    <!-- Sistema de Temas (Modo Claro/Oscuro) -->
    <div th:replace="~{fragments/theme :: themeResources}"></div>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: { display: ["Work Sans", "system-ui", "sans-serif"] },
            colors: {
              primary: "#38e07b",
              "primary-dark": "#2bc866",
              "background-light": "#f8faf9",
              "background-dark": "#0f1713",
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              xl: "1rem",
              "2xl": "1.5rem",
              full: "9999px",
            },
          },
        },
      };
    </script>

    <!-- Sidebar Styles Fragment -->
    <div th:replace="~{fragments/sidebar :: sidebarStyles}"></div>

    <style>
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .table-responsive::-webkit-scrollbar {
        height: 8px;
      }

      .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .table-responsive::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      /* Calendar Styles */
      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 0.75rem;
        transition: all 0.2s ease;
        position: relative;
        font-weight: 500;
      }

      .calendar-day:hover {
        background: rgba(56, 224, 123, 0.1);
        transform: scale(1.05);
      }

      .calendar-day.today {
        background: rgba(56, 224, 123, 0.2);
        font-weight: bold;
      }

      .calendar-day.selected {
        background: linear-gradient(135deg, #38e07b 0%, #2bc866 100%);
        color: white;
        font-weight: bold;
        box-shadow: 0 4px 6px -1px rgba(56, 224, 123, 0.3);
      }

      .calendar-day.has-reservations::after {
        content: "";
        position: absolute;
        bottom: 4px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: #38e07b;
        border-radius: 50%;
      }

      .calendar-day.selected.has-reservations::after {
        background: white;
      }

      .calendar-day.other-month {
        color: #9ca3af;
        cursor: default;
      }

      .calendar-day.other-month:hover {
        background: transparent;
        transform: none;
      }

      .action-btn {
        transition: all 0.2s ease;
      }

      .action-btn:hover {
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-background-light to-gray-50 dark:from-background-dark dark:to-gray-900 font-display text-gray-800 dark:text-gray-200 overflow-hidden"
  >
    <!-- Menu Controls Fragment -->
    <div th:replace="~{fragments/sidebar :: menuControls}"></div>

    <div class="flex min-h-screen h-screen overflow-hidden">
      <!-- SIDEBAR - Using Fragment -->
      <div
        th:replace="~{fragments/sidebar :: sidebar(activeMenu='reservations')}"
      ></div>

      <!-- MAIN CONTENT -->
      <main class="flex-1 overflow-y-auto h-screen">
        <div class="p-4 sm:p-6 lg:p-8 pt-20 lg:pt-8">
          <!-- Header -->
          <div
            class="flex flex-col md:flex-row md:items-center justify-between mb-6"
          >
            <div>
              <h2
                class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white mb-1"
              >
                Reservaciones
              </h2>
              <p class="text-sm sm:text-base text-gray-600 dark:text-gray-400">
                Gestiona y administra todas las reservaciones
              </p>
            </div>
            <a
              href="/admin/reservations/new"
              class="flex items-center justify-center gap-2 px-4 py-2 mt-4 md:mt-0 rounded-xl bg-primary text-white font-semibold hover:bg-primary-dark transition-colors shadow-md"
            >
              <span class="material-symbols-outlined">add</span>
              <span class="truncate">Nueva Reservación</span>
            </a>
          </div>

          <!-- Success/Error Messages -->
          <div
            th:if="${successMessage}"
            class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl flex items-center gap-3"
          >
            <span class="material-symbols-outlined text-green-600"
              >check_circle</span
            >
            <p
              class="text-green-800 dark:text-green-200"
              th:text="${successMessage}"
            ></p>
          </div>
          <div
            th:if="${errorMessage}"
            class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl flex items-center gap-3"
          >
            <span class="material-symbols-outlined text-red-600">error</span>
            <p
              class="text-red-800 dark:text-red-200"
              th:text="${errorMessage}"
            ></p>
          </div>

          <!-- TABS -->
          <div class="mb-6">
            <div class="border-b border-gray-200 dark:border-gray-700"></div>
          </div>

          <!-- Statistics Cards -->
          <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6"
          >
            <div
              class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 dark:text-gray-400 text-sm">
                    Total Hoy
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900 dark:text-white mt-1"
                    th:text="${todayCount}"
                  >
                    0
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-blue-100 dark:bg-blue-500/20 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-blue-600 dark:text-blue-400"
                    >today</span
                  >
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 dark:text-gray-400 text-sm">
                    Activas Hoy
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900 dark:text-white mt-1"
                    th:text="${todayActiveCount}"
                  >
                    0
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-green-100 dark:bg-green-500/20 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-green-600 dark:text-green-400"
                    >event_available</span
                  >
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 dark:text-gray-400 text-sm">
                    Reservadas
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900 dark:text-white mt-1"
                    th:text="${reservedCount}"
                  >
                    0
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-yellow-100 dark:bg-yellow-500/20 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-yellow-600 dark:text-yellow-400"
                    >schedule</span
                  >
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 dark:text-gray-400 text-sm">
                    Ocupadas
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900 dark:text-white mt-1"
                    th:text="${occupiedCount}"
                  >
                    0
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-red-100 dark:bg-red-500/20 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-red-600 dark:text-red-400"
                    >person</span
                  >
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 dark:text-gray-400 text-sm">
                    Canceladas
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900 dark:text-white mt-1"
                    th:text="${cancelledCount}"
                  >
                    0
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-orange-100 dark:bg-orange-500/20 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-orange-600 dark:text-orange-400"
                    >cancel</span
                  >
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 dark:text-gray-400 text-sm">
                    No Show
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900 dark:text-white mt-1"
                    th:text="${noShowCount}"
                  >
                    0
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-purple-100 dark:bg-purple-500/20 rounded-xl flex items-center justify-center"
                >
                  <span
                    class="material-symbols-outlined text-purple-600 dark:text-purple-400"
                    >person_off</span
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- TOP SECTION: CALENDAR + RESERVATIONS TODAY -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- CALENDAR -->
            <div
              class="bg-white dark:bg-gray-900 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-800"
            >
              <div class="flex items-center justify-between mb-6">
                <button
                  id="prevMonth"
                  class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400"
                >
                  <span class="material-symbols-outlined">chevron_left</span>
                </button>
                <p
                  id="currentMonth"
                  class="text-lg font-bold text-gray-800 dark:text-gray-100"
                ></p>
                <button
                  id="nextMonth"
                  class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400"
                >
                  <span class="material-symbols-outlined">chevron_right</span>
                </button>
              </div>

              <!-- Calendar Grid -->
              <div class="grid grid-cols-7 gap-1 text-center">
                <!-- Days of week headers -->
                <p
                  class="h-8 flex items-center justify-center text-xs font-bold text-gray-500 dark:text-gray-400"
                >
                  D
                </p>
                <p
                  class="h-8 flex items-center justify-center text-xs font-bold text-gray-500 dark:text-gray-400"
                >
                  L
                </p>
                <p
                  class="h-8 flex items-center justify-center text-xs font-bold text-gray-500 dark:text-gray-400"
                >
                  M
                </p>
                <p
                  class="h-8 flex items-center justify-center text-xs font-bold text-gray-500 dark:text-gray-400"
                >
                  M
                </p>
                <p
                  class="h-8 flex items-center justify-center text-xs font-bold text-gray-500 dark:text-gray-400"
                >
                  J
                </p>
                <p
                  class="h-8 flex items-center justify-center text-xs font-bold text-gray-500 dark:text-gray-400"
                >
                  V
                </p>
                <p
                  class="h-8 flex items-center justify-center text-xs font-bold text-gray-500 dark:text-gray-400"
                >
                  S
                </p>

                <!-- Calendar days will be inserted here by JavaScript -->
                <div
                  id="calendarDays"
                  class="col-span-7 grid grid-cols-7 gap-2"
                ></div>
              </div>
            </div>

            <!-- TODAY'S RESERVATIONS CARDS -->
            <div
              class="bg-white dark:bg-gray-900 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-800"
            >
              <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                Reservaciones de Hoy
              </h3>

              <div
                th:if="${#lists.isEmpty(groupedTodayReservations)}"
                class="flex flex-col items-center justify-center py-8 text-gray-500 dark:text-gray-400"
              >
                <span class="material-symbols-outlined text-6xl mb-2"
                  >event_busy</span
                >
                <p>No hay reservaciones para hoy</p>
              </div>

              <div
                th:unless="${#lists.isEmpty(groupedTodayReservations)}"
                class="space-y-3 overflow-y-auto max-h-[400px]"
              >
                <div
                  th:each="group : ${groupedTodayReservations}"
                  class="p-4 rounded-xl border-l-4 transition-all hover:shadow-md"
                  th:classappend="${group.status.name() == 'RESERVED' ? 'bg-green-50 dark:bg-green-900/20 border-green-500' :
                                 (reservation.status.name() == 'OCCUPIED' ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-500' :
                                 (reservation.status.name() == 'COMPLETED' ? 'bg-gray-50 dark:bg-gray-900/20 border-gray-500' :
                                 (reservation.status.name() == 'CANCELLED' ? 'bg-red-50 dark:bg-red-900/20 border-red-500' :
                                 'bg-purple-50 dark:bg-purple-900/20 border-purple-500')))}"
                >
                  <div class="flex items-center justify-between mb-2">
                    <h4
                      class="font-bold text-gray-900 dark:text-white"
                      th:text="${group.customerName}"
                    >
                      Nombre Cliente
                    </h4>
                    <span
                      class="text-sm font-semibold"
                      th:classappend="${group.status.name() == 'RESERVED' ? 'text-green-600 dark:text-green-400' :
                                     (reservation.status.name() == 'OCCUPIED' ? 'text-yellow-600 dark:text-yellow-400' :
                                     (reservation.status.name() == 'COMPLETED' ? 'text-gray-600 dark:text-gray-400' :
                                     (reservation.status.name() == 'CANCELLED' ? 'text-red-600 dark:text-red-400' :
                                     'text-purple-600 dark:text-purple-400')))}"
                      th:text="${group.formattedReservationTime}"
                    >
                      18:00
                    </span>
                  </div>
                  <div
                    class="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400"
                  >
                    <div class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-base"
                        >group</span
                      >
                      <span
                        th:text="${group.guestsDisplay}"
                        >4 personas</span
                      >
                    </div>
                    <div class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-base"
                        >table_restaurant</span
                      >
                      <span th:text="${group.tableDisplay}"
                        >Mesa 5</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div
            id="filtersSection"
            class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800 mb-6"
          >
            <h3
              class="text-lg font-semibold text-gray-900 dark:text-white mb-4"
            >
              Filtros
            </h3>
            <form
              id="filterForm"
              method="get"
              action="/admin/reservations"
              class="grid grid-cols-1 md:grid-cols-3 gap-4"
            >
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                >
                  Fecha
                </label>
                <input
                  type="date"
                  id="dateFilter"
                  name="date"
                  th:value="${selectedDate}"
                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
                />
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                >
                  Estado
                </label>
                <select
                  id="statusFilter"
                  name="status"
                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
                >
                  <option value="">Todos los estados</option>
                  <option
                    th:each="status : ${statuses}"
                    th:value="${status}"
                    th:text="${status.displayName}"
                    th:selected="${status == selectedStatus}"
                  ></option>
                </select>
              </div>
              <div class="flex items-end gap-2">
                <button
                  type="submit"
                  class="flex-1 px-6 py-2 bg-primary text-white rounded-lg font-semibold hover:bg-primary-dark transition-colors"
                >
                  Filtrar
                </button>
                <button
                  type="button"
                  id="clearFiltersBtn"
                  class="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
                >
                  Limpiar
                </button>
              </div>
            </form>
          </div>

          <!-- Reservations Table -->
          <div id="reservationsTableSection">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
              Todas las Reservaciones
            </h3>
            <div
              class="overflow-x-auto bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 shadow-lg"
            >
              <table class="w-full text-sm text-left">
                <thead
                  class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-800"
                >
                  <tr>
                    <th class="px-6 py-4" scope="col">Hora</th>
                    <th class="px-6 py-4" scope="col">Nombre</th>
                    <th class="px-6 py-4 text-center" scope="col">Personas</th>
                    <th class="px-6 py-4 text-center" scope="col">Mesa</th>
                    <th class="px-6 py-4" scope="col">Estado</th>
                    <th class="px-6 py-4" scope="col">Acciones</th>
                  </tr>
                </thead>
                <tbody
                  class="divide-y divide-gray-200 dark:divide-gray-800"
                  id="reservationsTableBody"
                >
                  <tr
                    th:if="${#lists.isEmpty(reservations)}"
                    class="text-center"
                  >
                    <td colspan="6" class="px-6 py-12">
                      <div
                        class="flex flex-col items-center justify-center gap-3"
                      >
                        <span
                          class="material-symbols-outlined text-gray-400 text-6xl"
                          >event_busy</span
                        >
                        <p class="text-gray-500 dark:text-gray-400">
                          No hay reservaciones disponibles
                        </p>
                      </div>
                    </td>
                  </tr>
                  <tr
                    th:each="reservation : ${reservations}"
                    class="hover:bg-gray-50 dark:hover:bg-gray-800 transition"
                  >
                    <td
                      class="px-6 py-4 font-medium text-gray-600 dark:text-gray-300"
                    >
                      <div
                        class="text-sm font-medium text-gray-900 dark:text-white"
                        th:text="${reservation.formattedReservationDate}"
                      ></div>
                      <div
                        class="text-sm text-gray-500 dark:text-gray-400"
                        th:text="${reservation.formattedReservationTime}"
                      ></div>
                    </td>
                    <td
                      class="px-6 py-4 font-semibold text-gray-900 dark:text-white"
                    >
                      <div
                        class="text-sm font-medium text-gray-900 dark:text-white"
                        th:text="${reservation.customerName}"
                      ></div>
                      <div
                        class="text-sm text-gray-500 dark:text-gray-400"
                        th:text="${reservation.customerPhone}"
                      ></div>
                    </td>
                    <td
                      class="px-6 py-4 text-center text-gray-600 dark:text-gray-300"
                      th:text="${reservation.numberOfGuests}"
                    ></td>
                    <td
                      class="px-6 py-4 text-center text-gray-600 dark:text-gray-300"
                      th:text="${reservation.tableDisplayName}"
                    ></td>
                    <td class="px-6 py-4">
                      <span
                        class="px-2.5 py-1 text-xs font-semibold rounded-full"
                        th:classappend="${reservation.status.name() == 'RESERVED' ? 'bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300' :
                                       (reservation.status.name() == 'OCCUPIED' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-300' :
                                       (reservation.status.name() == 'COMPLETED' ? 'bg-gray-100 text-gray-800 dark:bg-gray-500/20 dark:text-gray-300' :
                                       (reservation.status.name() == 'CANCELLED' ? 'bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300' :
                                       'bg-purple-100 text-purple-800 dark:bg-purple-500/20 dark:text-purple-300')))}"
                        th:text="${reservation.statusDisplayName}"
                      ></span>
                    </td>
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-2">
                        <button
                          th:onclick="'viewReservationDetails(' + ${reservation.id} + ')'"
                          class="action-btn p-2 rounded-lg bg-blue-100 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-500/30 shadow-sm"
                          title="Ver detalles"
                        >
                          <span class="material-symbols-outlined text-lg"
                            >visibility</span
                          >
                        </button>
                        <a
                          th:if="${reservation.isEditable()}"
                          th:href="@{'/admin/reservations/' + ${reservation.id} + '/edit'}"
                          class="action-btn p-2 rounded-lg bg-amber-100 dark:bg-amber-500/20 text-amber-600 dark:text-amber-400 hover:bg-amber-200 dark:hover:bg-amber-500/30 shadow-sm"
                          title="Editar"
                        >
                          <span class="material-symbols-outlined text-lg"
                            >edit</span
                          >
                        </a>
                        <button
                          th:if="${reservation.status.name() == 'RESERVED'}"
                          th:onclick="'checkInReservation(' + ${reservation.id} + ')'"
                          class="action-btn p-2 rounded-lg bg-purple-100 dark:bg-purple-500/20 text-purple-600 dark:text-purple-400 hover:bg-purple-200 dark:hover:bg-purple-500/30 shadow-sm"
                          title="Check-in"
                        >
                          <span class="material-symbols-outlined text-lg"
                            >login</span
                          >
                        </button>
                        <button
                          th:if="${reservation.status.name() == 'OCCUPIED'}"
                          th:onclick="'checkOutReservation(' + ${reservation.id} + ')'"
                          class="action-btn p-2 rounded-lg bg-green-100 dark:bg-green-500/20 text-green-600 dark:text-green-400 hover:bg-green-200 dark:hover:bg-green-500/30 shadow-sm"
                          title="Check-out"
                        >
                          <span class="material-symbols-outlined text-lg"
                            >logout</span
                          >
                        </button>
                        <button
                          th:if="${reservation.isCancellable()}"
                          th:onclick="'cancelReservation(' + ${reservation.id} + ')'"
                          class="action-btn p-2 rounded-lg bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-500/30 shadow-sm"
                          title="Cancelar"
                        >
                          <span class="material-symbols-outlined text-lg"
                            >cancel</span
                          >
                        </button>
                        <button
                          th:if="${reservation.status.name() == 'RESERVED'}"
                          th:onclick="'markAsNoShow(' + ${reservation.id} + ')'"
                          class="action-btn p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 shadow-sm"
                          title="No se presentó"
                        >
                          <span class="material-symbols-outlined text-lg"
                            >person_off</span
                          >
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Reservation Details Modal -->
    <div
      id="reservationModal"
      class="hidden fixed inset-0 bg-gray-900/50 backdrop-blur-sm overflow-y-auto h-full w-full z-[60]"
    >
      <div
        class="relative top-20 mx-auto p-5 border-0 w-full max-w-2xl shadow-2xl rounded-2xl bg-white dark:bg-gray-900 mb-20"
      >
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
            Detalles de la Reservación
          </h3>
          <button
            onclick="closeReservationModal()"
            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
          >
            <span class="material-symbols-outlined text-3xl">close</span>
          </button>
        </div>

        <div id="reservationDetails" class="space-y-4">
          <!-- Details will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Calendar Day Reservations Modal -->
    <div
      id="calendarModal"
      class="hidden fixed inset-0 bg-gray-900/50 backdrop-blur-sm h-full w-full z-50 flex items-center justify-center p-4"
      onclick="closeCalendarModal(event)"
    >
      <div
        class="relative w-full max-w-3xl max-h-[90vh] shadow-2xl rounded-2xl bg-white dark:bg-gray-900 flex flex-col"
        onclick="event.stopPropagation()"
      >
        <div
          class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0"
        >
          <div class="flex items-center gap-3">
            <div
              class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center"
            >
              <span class="material-symbols-outlined text-primary text-2xl"
                >calendar_month</span
              >
            </div>
            <div>
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
                Reservaciones del día
              </h3>
              <p
                id="modalDateTitle"
                class="text-sm text-gray-500 dark:text-gray-400"
              ></p>
            </div>
          </div>
          <button
            onclick="closeCalendarModal()"
            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
          >
            <span class="material-symbols-outlined text-3xl">close</span>
          </button>
        </div>

        <div
          id="modalReservationsList"
          class="space-y-3 p-6 overflow-y-auto flex-1"
        >
          <!-- Reservations will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Sidebar Scripts Fragment -->
    <div th:replace="~{fragments/sidebar :: sidebarScripts}"></div>

    <script>
      // ==================== FILTER FUNCTIONALITY ====================
      document.addEventListener("DOMContentLoaded", () => {
        const filterForm = document.getElementById("filterForm");
        const clearFiltersBtn = document.getElementById("clearFiltersBtn");
        const dateFilter = document.getElementById("dateFilter");
        const statusFilter = document.getElementById("statusFilter");

        // Handle form submission with AJAX
        if (filterForm) {
          filterForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Save current scroll position
            const scrollPosition = window.scrollY;

            const dateValue = dateFilter.value;
            const statusValue = statusFilter.value;

            // Build query parameters
            const params = new URLSearchParams();
            if (dateValue) params.append("date", dateValue);
            if (statusValue) params.append("status", statusValue);

            try {
              // Show loading state
              const tableBody = document.getElementById(
                "reservationsTableBody"
              );
              if (tableBody) {
                tableBody.innerHTML = `
                  <tr class="text-center">
                    <td colspan="6" class="px-6 py-12">
                      <div class="flex flex-col items-center justify-center gap-3">
                        <div class="animate-spin inline-block w-12 h-12 border-4 border-primary border-t-transparent rounded-full"></div>
                        <p class="text-gray-500 dark:text-gray-400">Cargando reservaciones...</p>
                      </div>
                    </td>
                  </tr>
                `;
              }

              // Fetch filtered data
              const response = await fetch(
                `/admin/reservations?${params.toString()}`
              );
              const html = await response.text();

              // Parse the HTML response
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, "text/html");

              // Update the table body
              const newTableBody = doc.getElementById("reservationsTableBody");
              if (tableBody && newTableBody) {
                tableBody.innerHTML = newTableBody.innerHTML;
              }

              // Restore scroll position
              window.scrollTo(0, scrollPosition);

              // Update URL without reloading
              const newUrl = params.toString()
                ? `/admin/reservations?${params.toString()}`
                : `/admin/reservations`;
              window.history.pushState({}, "", newUrl);
            } catch (error) {
              console.error("Error filtering reservations:", error);
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "Error al filtrar las reservaciones",
                confirmButtonColor: "#38e07b",
              });
            }
          });
        }

        // Handle clear filters
        if (clearFiltersBtn) {
          clearFiltersBtn.addEventListener("click", () => {
            // Save current scroll position
            const scrollPosition = window.scrollY;

            dateFilter.value = "";
            statusFilter.value = "";

            // Trigger form submission to reload all data
            filterForm.dispatchEvent(new Event("submit"));

            // Restore scroll position after a short delay
            setTimeout(() => {
              window.scrollTo(0, scrollPosition);
            }, 100);
          });
        }
      });

      // View reservation details
      async function viewReservationDetails(id) {
        try {
          const response = await fetch(`/admin/reservations/${id}/details`);
          const data = await response.json();

          if (data.success) {
            document.getElementById("reservationDetails").innerHTML = `
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Cliente</p>
                  <p class="font-semibold text-gray-900 dark:text-white">${data.customerName}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Teléfono</p>
                  <p class="font-semibold text-gray-900 dark:text-white">${data.customerPhone}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Email</p>
                  <p class="font-semibold text-gray-900 dark:text-white">${data.customerEmail}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Personas</p>
                  <p class="font-semibold text-gray-900 dark:text-white">${data.numberOfGuests}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Fecha</p>
                  <p class="font-semibold text-gray-900 dark:text-white">${data.reservationDate}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Hora</p>
                  <p class="font-semibold text-gray-900 dark:text-white">${data.reservationTime}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Mesa</p>
                  <p class="font-semibold text-gray-900 dark:text-white">${data.table}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Estado</p>
                  <p class="font-semibold text-gray-900 dark:text-white">${data.status}</p>
                </div>
                <div class="col-span-2">
                  <p class="text-sm text-gray-500 dark:text-gray-400">Peticiones Especiales</p>
                  <p class="font-semibold text-gray-900 dark:text-white">${data.specialRequests}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Creado por</p>
                  <p class="font-semibold text-gray-900 dark:text-white">${data.createdBy}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Fecha de creación</p>
                  <p class="font-semibold text-gray-900 dark:text-white">${data.createdAt}</p>
                </div>
              </div>
            `;
            document
              .getElementById("reservationModal")
              .classList.remove("hidden");
          } else {
            Swal.fire("Error", data.message, "error");
          }
        } catch (error) {
          console.error("Error:", error);
          Swal.fire("Error", "No se pudieron cargar los detalles", "error");
        }
      }

      function closeReservationModal() {
        document.getElementById("reservationModal").classList.add("hidden");
      }

      // Check-in reservation
      async function checkInReservation(id) {
        const result = await Swal.fire({
          title: "¿Registrar llegada?",
          text: "El cliente está presente y listo para ser atendido",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#38e07b",
          cancelButtonColor: "#ef476f",
          confirmButtonText: "Sí, registrar",
          cancelButtonText: "Cancelar",
        });

        if (result.isConfirmed) {
          performAction(
            `/admin/reservations/${id}/checkin`,
            "Cliente registrado"
          );
        }
      }

      // Check-out reservation
      async function checkOutReservation(id) {
        const result = await Swal.fire({
          title: "¿Completar reservación?",
          text: "El cliente ha terminado y se retira",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#38e07b",
          cancelButtonColor: "#ef476f",
          confirmButtonText: "Sí, completar",
          cancelButtonText: "Cancelar",
        });

        if (result.isConfirmed) {
          performAction(
            `/admin/reservations/${id}/checkout`,
            "Reservación completada"
          );
        }
      }

      // Cancel reservation
      async function cancelReservation(id) {
        const result = await Swal.fire({
          title: "¿Cancelar reservación?",
          text: "Esta acción no se puede deshacer",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#ef476f",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Sí, cancelar",
          cancelButtonText: "No",
        });

        if (result.isConfirmed) {
          performAction(
            `/admin/reservations/${id}/cancel`,
            "Reservación cancelada"
          );
        }
      }

      // Mark as no-show
      async function markAsNoShow(id) {
        const result = await Swal.fire({
          title: "¿Cliente no se presentó?",
          text: "Marcar que el cliente no llegó a su reservación",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#6c757d",
          cancelButtonColor: "#ef476f",
          confirmButtonText: "Sí, marcar",
          cancelButtonText: "Cancelar",
        });

        if (result.isConfirmed) {
          performAction(
            `/admin/reservations/${id}/no-show`,
            "Marcado como no show"
          );
        }
      }

      // Perform action
      async function performAction(url, successMsg) {
        try {
          const response = await fetch(url, { method: "POST" });
          const data = await response.json();

          if (data.success) {
            await Swal.fire("Éxito", successMsg, "success");
            location.reload();
          } else {
            Swal.fire("Error", data.message, "error");
          }
        } catch (error) {
          console.error("Error:", error);
          Swal.fire("Error", "Ocurrió un error al procesar la acción", "error");
        }
      }

      // ==================== CALENDAR FUNCTIONALITY ====================
      let currentDate = new Date();
      let selectedDate = null;
      let reservationsData = {};

      // Initialize calendar
      document.addEventListener("DOMContentLoaded", () => {
        renderCalendar();
        loadMonthReservations();

        // Event listeners for month navigation
        document.getElementById("prevMonth").addEventListener("click", () => {
          currentDate.setMonth(currentDate.getMonth() - 1);
          renderCalendar();
          loadMonthReservations();
        });

        document.getElementById("nextMonth").addEventListener("click", () => {
          currentDate.setMonth(currentDate.getMonth() + 1);
          renderCalendar();
          loadMonthReservations();
        });
      });

      // Render calendar
      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // Set month title
        const monthNames = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];
        document.getElementById(
          "currentMonth"
        ).textContent = `${monthNames[month]} ${year}`;

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();

        // Get days from previous month
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        const prevMonthDays = startingDayOfWeek;

        // Clear calendar
        const calendarDays = document.getElementById("calendarDays");
        calendarDays.innerHTML = "";

        // Add days from previous month
        for (let i = prevMonthDays - 1; i >= 0; i--) {
          const day = prevMonthLastDay - i;
          const dayEl = createDayElement(day, "other-month");
          calendarDays.appendChild(dayEl);
        }

        // Add days of current month
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const isToday =
            date.getDate() === today.getDate() &&
            date.getMonth() === today.getMonth() &&
            date.getFullYear() === today.getFullYear();

          const dateStr = formatDate(date);
          const hasReservations =
            reservationsData[dateStr] && reservationsData[dateStr].count > 0;

          const dayEl = createDayElement(
            day,
            isToday ? "today" : "",
            date,
            hasReservations
          );
          calendarDays.appendChild(dayEl);
        }

        // Add days from next month to complete the grid
        const totalCells = calendarDays.children.length;
        const remainingCells = 35 - totalCells; // 5 weeks * 7 days
        for (let day = 1; day <= remainingCells; day++) {
          const dayEl = createDayElement(day, "other-month");
          calendarDays.appendChild(dayEl);
        }
      }

      // Create day element
      function createDayElement(
        day,
        className = "",
        date = null,
        hasReservations = false
      ) {
        const dayEl = document.createElement("div");
        dayEl.className = `calendar-day text-sm ${className}`;
        dayEl.textContent = day;

        if (hasReservations) {
          dayEl.classList.add("has-reservations");
        }

        if (date && !className.includes("other-month")) {
          dayEl.addEventListener("click", () => openCalendarModal(date));
        }

        return dayEl;
      }

      // Open calendar modal with day reservations
      async function openCalendarModal(date) {
        const dateStr = formatDate(date);
        const container = document.getElementById("modalReservationsList");
        const modal = document.getElementById("calendarModal");
        const dateTitle = document.getElementById("modalDateTitle");

        // Update date title
        dateTitle.textContent = formatDateDisplay(date);

        // Show modal
        modal.classList.remove("hidden");

        // Show loading state
        container.innerHTML = `
          <div class="text-center text-gray-500 dark:text-gray-400 py-8">
            <div class="animate-spin inline-block w-12 h-12 border-4 border-current border-t-transparent rounded-full mb-3"></div>
            <p class="text-sm">Cargando reservaciones...</p>
          </div>
        `;

        try {
          // Fetch reservations for the specific date
          const response = await fetch(
            `/admin/reservations/api/by-date?date=${dateStr}`
          );
          const data = await response.json();

          if (data.success) {
            if (data.reservations.length === 0) {
              container.innerHTML = `
                <div class="text-center text-gray-500 dark:text-gray-400 py-12">
                  <span class="material-symbols-outlined text-6xl mb-3">event_busy</span>
                  <p class="text-lg font-semibold mb-1">No hay reservaciones para este día</p>
                  <p class="text-sm">Intenta seleccionar otro día en el calendario</p>
                </div>
              `;
            } else {
              // Display reservations
              container.innerHTML = data.reservations
                .map(
                  (res) => `
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 rounded-xl p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-all cursor-pointer"
                     onclick="viewReservationDetails(${res.id})">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                      <h4 class="font-bold text-lg text-gray-900 dark:text-white mb-1">${
                        res.customerName
                      }</h4>
                      <p class="text-sm text-gray-500 dark:text-gray-400">${
                        res.customerPhone
                      }</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold
                      ${
                        res.statusName === "RESERVED"
                          ? "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300"
                          : res.statusName === "OCCUPIED"
                          ? "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300"
                          : res.statusName === "COMPLETED"
                          ? "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                          : res.statusName === "CANCELLED"
                          ? "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300"
                          : "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300"
                      }">
                      ${res.status}
                    </span>
                  </div>
                  <div class="grid grid-cols-3 gap-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-primary text-lg">schedule</span>
                      <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Hora</p>
                        <p class="text-sm font-semibold text-gray-900 dark:text-white">${
                          res.reservationTime
                        }</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-primary text-lg">group</span>
                      <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Personas</p>
                        <p class="text-sm font-semibold text-gray-900 dark:text-white">${
                          res.numberOfGuests
                        }</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-primary text-lg">table_restaurant</span>
                      <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Mesa</p>
                        <p class="text-sm font-semibold text-gray-900 dark:text-white">${
                          res.table
                        }</p>
                      </div>
                    </div>
                  </div>
                </div>
              `
                )
                .join("");
            }
          } else {
            throw new Error(data.message || "Error loading reservations");
          }
        } catch (error) {
          console.error("Error loading day reservations:", error);
          container.innerHTML = `
            <div class="text-center text-red-500 dark:text-red-400 py-8">
              <span class="material-symbols-outlined text-6xl mb-3">error</span>
              <p class="text-lg font-semibold mb-1">Error al cargar las reservaciones</p>
              <p class="text-sm">Por favor, intenta de nuevo más tarde</p>
            </div>
          `;
        }
      }

      // Close calendar modal
      function closeCalendarModal(event) {
        if (event && event.target.id !== "calendarModal") return;
        document.getElementById("calendarModal").classList.add("hidden");
      }

      // Load month reservations
      async function loadMonthReservations() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1; // JavaScript months are 0-based

        try {
          // Fetch reservation counts for the month
          const response = await fetch(
            `/admin/reservations/api/counts-by-month?year=${year}&month=${month}`
          );
          const data = await response.json();

          if (data.success) {
            // Store counts by date
            reservationsData = {};
            for (const [dateStr, count] of Object.entries(data.counts)) {
              reservationsData[dateStr] = { count };
            }
            renderCalendar();
          }
        } catch (error) {
          console.error("Error loading month reservations:", error);
          renderCalendar();
        }
      }

      // Format date as YYYY-MM-DD
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // Format date for display
      function formatDateDisplay(date) {
        const days = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];
        const months = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];

        const dayName = days[date.getDay()];
        const day = date.getDate();
        const month = months[date.getMonth()];
        const year = date.getFullYear();

        return `${dayName} ${day} de ${month} ${year}`;
      }
    </script>
      
    <!-- Script del Sistema de Temas -->
    <div th:replace="~{fragments/theme :: themeScript}"></div>
  </body>
</html>
