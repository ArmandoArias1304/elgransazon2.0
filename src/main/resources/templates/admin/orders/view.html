<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Gran Sazón - Ver Pedido</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700"
      rel="stylesheet"
    />

    <!-- Sistema de Temas (Modo Claro/Oscuro) -->
    <div th:replace="~{fragments/theme :: themeResources}"></div>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#38e07b",
              "primary-dark": "#2bc866",
              "background-light": "#f8faf9",
              "background-dark": "#0f1713",
            },
            fontFamily: {
              display: ["Work Sans"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              xl: "1rem",
              "2xl": "1.5rem",
              full: "9999px",
            },
          },
        },
      };
    </script>

    <style>
      @media print {
        .no-print {
          display: none !important;
        }
        body {
          background: white !important;
        }
      }

      /* Animaciones suaves */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fadeIn {
        animation: fadeIn 0.4s ease-out;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-background-light to-gray-50 dark:from-background-dark dark:to-gray-900 font-display text-gray-800 dark:text-gray-200"
  >
    <div class="container mx-auto px-4 py-6 sm:py-8 max-w-7xl">
      <!-- HEADER -->
      <div class="mb-6 sm:mb-8 no-print">
        <a
          th:href="@{/admin/orders}"
          class="inline-flex items-center gap-2 text-primary hover:text-primary-dark font-semibold mb-4 transition-colors"
        >
          <span class="material-symbols-outlined">arrow_back</span>
          Volver a Pedidos
        </a>
        <div
          class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
        >
          <div>
            <h1
              class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white mb-1"
            >
              Detalle del Pedido
            </h1>
            <p class="text-sm sm:text-base text-gray-600 dark:text-gray-400">
              Pedido
              <span
                class="font-mono font-semibold text-primary"
                th:text="${order.orderNumber}"
              ></span>
            </p>
          </div>
          <div>
            <span
              class="inline-flex items-center gap-2 px-4 py-2.5 text-sm font-semibold rounded-xl"
              th:classappend="${order.status.name() == 'PENDING'} ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400' : 
                                         (${order.status.name() == 'IN_PREPARATION'} ? 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400' : 
                                         (${order.status.name() == 'READY'} ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400' :
                                         (${order.status.name() == 'ON_THE_WAY'} ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400' :
                                         (${order.status.name() == 'DELIVERED'} ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' :
                                         (${order.status.name() == 'PAID'} ? 'bg-primary/20 text-primary' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400')))))"
              th:text="${order.status.displayName}"
            >
            </span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- LEFT COLUMN: Order Details -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Order Information -->
          <div
            class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-lg animate-fadeIn"
          >
            <div class="flex items-center gap-2 mb-4">
              <span
                class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-2xl"
                >info</span
              >
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                Información del Pedido
              </h3>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <p
                  class="text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-1"
                >
                  Tipo de Pedido
                </p>
                <span
                  class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs rounded-full font-medium"
                  th:classappend="${order.orderType.name() == 'DINE_IN'} ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400' : (${order.orderType.name() == 'TAKEOUT'} ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400' : 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400')"
                >
                  <i
                    class="fas"
                    th:classappend="${order.orderType.name() == 'DINE_IN'} ? 'fa-utensils' : (${order.orderType.name() == 'TAKEOUT'} ? 'fa-shopping-bag' : 'fa-truck')"
                  ></i>
                  <span th:text="${order.orderType.displayName}"></span>
                </span>
              </div>

              <div th:if="${order.table != null}">
                <p
                  class="text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-1"
                >
                  Mesa
                </p>
                <p
                  class="font-semibold text-gray-900 dark:text-white"
                  th:text="${'Mesa #' + order.table.tableNumber}"
                ></p>
              </div>

              <div>
                <p
                  class="text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-1"
                >
                  Fecha y Hora
                </p>
                <p class="font-semibold text-gray-900 dark:text-white">
                  <span
                    th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy')}"
                  ></span>
                  <span
                    class="text-sm text-gray-600 dark:text-gray-400 ml-1"
                    th:text="${#temporals.format(order.createdAt, 'HH:mm')}"
                  ></span>
                </p>
              </div>

              <div>
                <p
                  class="text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-1"
                >
                  Atendido por
                </p>
                <p
                  class="font-semibold text-gray-900 dark:text-white"
                  th:text="${order.employee != null ? (order.employee.nombre + ' ' + order.employee.apellido) : 'Pedido Web'}"
                ></p>
              </div>
            </div>
          </div>

          <!-- Customer Information -->
          <div
            class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-lg animate-fadeIn"
            style="animation-delay: 0.1s"
          >
            <div class="flex items-center gap-2 mb-4">
              <span class="material-symbols-outlined text-primary text-2xl"
                >person</span
              >
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                Información del Cliente
              </h3>
            </div>

            <div class="space-y-4">
              <div>
                <p
                  class="text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-1"
                >
                  Nombre Completo
                </p>
                <p
                  class="font-semibold text-gray-900 dark:text-white"
                  th:text="${order.customerName}"
                ></p>
              </div>

              <div>
                <p
                  class="text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-1"
                >
                  Teléfono
                </p>
                <p
                  class="font-semibold text-gray-900 dark:text-white"
                  th:text="${order.customerPhone}"
                ></p>
              </div>

              <div
                th:if="${order.deliveryAddress != null && !#strings.isEmpty(order.deliveryAddress)}"
              >
                <p
                  class="text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-1"
                >
                  Dirección de Entrega
                </p>
                <p
                  class="font-semibold text-gray-900 dark:text-white flex items-start gap-2"
                >
                  <span class="material-symbols-outlined text-orange-500"
                    >location_on</span
                  >
                  <span th:text="${order.deliveryAddress}"></span>
                </p>
              </div>

              <div
                th:if="${order.deliveryReferences != null && !#strings.isEmpty(order.deliveryReferences)}"
              >
                <p
                  class="text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-1"
                >
                  Referencias
                </p>
                <p
                  class="text-gray-700 dark:text-gray-300 italic"
                  th:text="${order.deliveryReferences}"
                ></p>
              </div>
            </div>
          </div>

          <!-- Order Items -->
          <div
            class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-lg animate-fadeIn"
            style="animation-delay: 0.2s"
          >
            <div class="flex items-center gap-2 mb-4">
              <span
                class="material-symbols-outlined text-orange-600 dark:text-orange-400 text-2xl"
                >restaurant_menu</span
              >
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                Items del Pedido
              </h3>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="border-b border-gray-200 dark:border-gray-700">
                  <tr>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase"
                    >
                      Item
                    </th>
                    <th
                      class="text-center py-3 px-3 text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase"
                    >
                      Estado
                    </th>
                    <th
                      class="text-center py-3 px-3 text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase"
                    >
                      Cant.
                    </th>
                    <th
                      class="text-right py-3 px-3 text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase"
                    >
                      P. Unit.
                    </th>
                    <th
                      class="text-right py-3 px-3 text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase"
                    >
                      Subtotal
                    </th>
                    <th
                      class="text-center py-3 px-3 text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase no-print"
                    >
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    th:each="detail : ${orderDetails}"
                    class="border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors"
                  >
                    <td class="py-4 px-3">
                      <div class="flex flex-col gap-2">
                        <p
                          class="font-semibold text-gray-900 dark:text-white"
                          th:text="${detail.itemMenu.name}"
                        ></p>

                        <!-- NEW ITEM Badge -->
                        <div
                          th:if="${detail.isNewItem != null && detail.isNewItem}"
                        >
                          <span
                            class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold bg-gradient-to-r from-amber-400 to-orange-500 text-white shadow-lg"
                          >
                            <span class="material-symbols-outlined !text-xs"
                              >fiber_new</span
                            >
                            NUEVO ITEM
                          </span>
                        </div>

                        <p
                          th:if="${detail.comments != null && !#strings.isEmpty(detail.comments)}"
                          class="text-xs text-gray-500 dark:text-gray-400 italic mt-1 flex items-start gap-1"
                        >
                          <span class="material-symbols-outlined text-xs"
                            >comment</span
                          >
                          <span th:text="${detail.comments}"></span>
                        </p>

                        <!-- Added At (for new items) -->
                        <p
                          th:if="${detail.isNewItem != null && detail.isNewItem && detail.addedAt != null}"
                          class="text-xs text-gray-500 dark:text-gray-400 italic flex items-center gap-1"
                        >
                          <span class="material-symbols-outlined !text-xs"
                            >schedule</span
                          >
                          Agregado:
                          <span
                            th:text="${#temporals.format(detail.addedAt, 'HH:mm')}"
                          ></span>
                        </p>
                      </div>
                    </td>
                    <td class="py-4 px-3 text-center">
                      <!-- Item Status Badge -->
                      <span
                        th:if="${detail.itemStatus != null && detail.itemStatus.name() == 'PENDING'}"
                        class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300"
                      >
                        <span class="material-symbols-outlined !text-xs"
                          >schedule</span
                        >
                        Pendiente
                      </span>
                      <span
                        th:if="${detail.itemStatus != null && detail.itemStatus.name() == 'IN_PREPARATION'}"
                        class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300"
                      >
                        <span class="material-symbols-outlined !text-xs"
                          >cooking</span
                        >
                        Preparando
                      </span>
                      <span
                        th:if="${detail.itemStatus != null && detail.itemStatus.name() == 'READY'}"
                        class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300"
                      >
                        <span class="material-symbols-outlined !text-xs"
                          >check_circle</span
                        >
                        Listo
                      </span>
                      <span
                        th:if="${detail.itemStatus != null && detail.itemStatus.name() == 'DELIVERED'}"
                        class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300"
                      >
                        <span class="material-symbols-outlined !text-xs"
                          >done_all</span
                        >
                        Entregado
                      </span>
                    </td>
                    <td class="py-4 px-3 text-center">
                      <span
                        class="inline-flex items-center justify-center w-10 h-10 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-400 rounded-full font-bold text-sm"
                        th:text="${detail.quantity}"
                      >
                      </span>
                    </td>
                    <td
                      class="py-4 px-3 text-right text-gray-700 dark:text-gray-300"
                      th:text="${detail.getFormattedUnitPrice()}"
                    ></td>
                    <td
                      class="py-4 px-3 text-right font-semibold text-gray-900 dark:text-white"
                      th:text="${detail.getFormattedSubtotal()}"
                    ></td>
                    <td class="py-4 px-3 text-center no-print">
                      <!-- Delete Item Button (only if not DELIVERED) -->
                      <button
                        th:if="${detail.itemStatus != null && detail.itemStatus.name() != 'DELIVERED'}"
                        class="btn-delete-item p-2 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/40 transition-all"
                        th:data-order-id="${order.idOrder}"
                        th:data-item-id="${detail.idOrderDetail}"
                        th:data-item-name="${detail.itemMenu.name}"
                        th:data-item-status="${detail.itemStatus.name()}"
                        th:data-requires-preparation="${detail.itemMenu.requiresPreparation}"
                        title="Eliminar item"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                      <span
                        th:if="${detail.itemStatus != null && detail.itemStatus.name() == 'DELIVERED'}"
                        class="text-xs text-gray-400 dark:text-gray-600 italic"
                      >
                        Entregado
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Timestamps -->
          <div
            class="rounded-xl bg-gray-100 dark:bg-gray-800/50 p-4 animate-fadeIn"
            style="animation-delay: 0.3s"
          >
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="text-xs text-gray-600 dark:text-gray-400">
                <p class="mb-1">
                  <span class="font-semibold text-gray-700 dark:text-gray-300"
                    >Creado:</span
                  >
                  <span
                    th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"
                  ></span>
                </p>
                <p>
                  <span class="font-semibold text-gray-700 dark:text-gray-300"
                    >Por:</span
                  >
                  <span th:text="${order.createdBy}"></span>
                </p>
              </div>
              <div
                th:if="${order.updatedAt != null}"
                class="text-xs text-gray-600 dark:text-gray-400"
              >
                <p class="mb-1">
                  <span class="font-semibold text-gray-700 dark:text-gray-300"
                    >Actualizado:</span
                  >
                  <span
                    th:text="${#temporals.format(order.updatedAt, 'dd/MM/yyyy HH:mm')}"
                  ></span>
                </p>
                <p th:if="${order.updatedBy != null}">
                  <span class="font-semibold text-gray-700 dark:text-gray-300"
                    >Por:</span
                  >
                  <span th:text="${order.updatedBy}"></span>
                </p>
              </div>
              <div
                th:if="${order.cancelledAt != null}"
                class="text-xs text-red-600 dark:text-red-400"
              >
                <p>
                  <span class="font-semibold">Cancelado:</span>
                  <span
                    th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm')}"
                  ></span>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN: Summary & Actions -->
        <div class="space-y-6">
          <!-- Payment Information -->
          <div
            class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-lg animate-fadeIn"
            style="animation-delay: 0.15s"
          >
            <div class="flex items-center gap-2 mb-4">
              <span
                class="material-symbols-outlined text-purple-600 dark:text-purple-400 text-2xl"
                >payments</span
              >
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                Información de Pago
              </h3>
            </div>

            <div>
              <p
                class="text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-2"
              >
                Método de Pago
              </p>
              <div
                class="flex items-center gap-2 px-4 py-3 bg-purple-50 dark:bg-purple-900/20 rounded-xl"
              >
                <span class="material-symbols-outlined text-purple-600"
                  >credit_card</span
                >
                <p
                  class="font-semibold text-gray-900 dark:text-white"
                  th:text="${order.paymentMethod.displayName}"
                ></p>
              </div>
            </div>
          </div>

          <!-- Order Summary -->
          <div
            class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-lg animate-fadeIn"
            style="animation-delay: 0.25s"
          >
            <div class="flex items-center gap-2 mb-4">
              <span
                class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-2xl"
                >receipt_long</span
              >
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                Resumen del Pedido
              </h3>
            </div>

            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600 dark:text-gray-400"
                  >Subtotal:</span
                >
                <span
                  class="font-semibold text-gray-900 dark:text-white"
                  th:text="${order.getFormattedSubtotal()}"
                ></span>
              </div>

              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600 dark:text-gray-400">
                  Impuesto (<span th:text="${order.taxRate}">0</span>%):
                </span>
                <span
                  class="font-semibold text-gray-900 dark:text-white"
                  th:text="${order.getFormattedTaxAmount()}"
                ></span>
              </div>

              <div
                class="border-t border-gray-200 dark:border-gray-700 pt-3 flex justify-between items-center"
              >
                <span class="font-bold text-lg text-gray-900 dark:text-white"
                  >Total:</span
                >
                <span
                  class="font-bold text-2xl text-primary"
                  th:text="${order.getFormattedTotal()}"
                ></span>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div
            class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-lg no-print animate-fadeIn"
            style="animation-delay: 0.35s"
          >
            <div class="flex items-center gap-2 mb-4">
              <span class="material-symbols-outlined text-primary text-2xl"
                >settings</span
              >
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                Acciones
              </h3>
            </div>

            <div class="space-y-3">
              <!-- Add Items (only for DINE_IN and TAKEOUT orders that can accept new items) -->
              <a
                th:if="${order.canAcceptNewItems()}"
                th:href="@{/admin/orders/{id}/add-items(id=${order.idOrder})}"
                class="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-semibold transition-all shadow-md hover:shadow-lg"
              >
                <span class="material-symbols-outlined">add_circle</span>
                Agregar Items al Pedido
              </a>

              <!-- Edit (only PENDING) -->
              <a
                th:if="${order.status.name() == 'PENDING'}"
                th:href="@{/admin/orders/edit/{id}(id=${order.idOrder})}"
                class="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-semibold transition-all shadow-md hover:shadow-lg"
              >
                <span class="material-symbols-outlined">edit</span>
                Editar Pedido
              </a>
              <!-- Print Receipt -->
              <button
                onclick="window.print()"
                class="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-xl bg-gray-600 dark:bg-gray-700 hover:bg-gray-700 dark:hover:bg-gray-600 text-white font-semibold transition-all shadow-md hover:shadow-lg"
              >
                <span class="material-symbols-outlined">print</span>
                Imprimir Ticket
              </button>

              <!-- Back to List -->
              <a
                th:href="@{/admin/orders}"
                class="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-xl bg-gradient-to-r from-primary to-primary-dark text-white font-semibold hover:shadow-lg hover:shadow-primary/30 transition-all shadow-md"
              >
                <span class="material-symbols-outlined">list</span>
                Volver al Listado
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script th:inline="javascript">
      /*<![CDATA[*/

      // Format currency
      function formatCurrency(amount) {
        return new Intl.NumberFormat("es-CO", {
          style: "currency",
          currency: "COP",
          minimumFractionDigits: 0,
        }).format(amount);
      }

      // ========== DELETE ITEM FUNCTIONS ==========

      // Delete item from order
      async function deleteOrderItem(
        orderId,
        itemId,
        itemName,
        itemStatus,
        requiresPrep
      ) {
        // Build warning message based on item status
        let stockWarning = "";

        if (itemStatus === "PENDING") {
          stockWarning =
            '<p class="text-sm text-green-600 dark:text-green-400 mt-3">✅ El stock será devuelto automáticamente (item nunca fue preparado)</p>';
        } else if (itemStatus === "READY" && requiresPrep === "false") {
          stockWarning =
            '<p class="text-sm text-green-600 dark:text-green-400 mt-3">✅ El stock será devuelto automáticamente (item no requiere preparación)</p>';
        } else if (itemStatus === "READY" && requiresPrep === "true") {
          stockWarning =
            '<p class="text-sm text-orange-600 dark:text-orange-400 mt-3">⚠️ El stock debe ser devuelto manualmente (chef ya preparó el item)</p>';
        } else if (itemStatus === "IN_PREPARATION") {
          stockWarning =
            '<p class="text-sm text-orange-600 dark:text-orange-400 mt-3">⚠️ El stock debe ser devuelto manualmente (item estaba en preparación)</p>';
        }

        const result = await Swal.fire({
          title: "¿Eliminar item?",
          html: `<p>¿Estás seguro de que deseas eliminar <strong>${itemName}</strong> de este pedido?</p>${stockWarning}`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#ef4444",
          cancelButtonColor: "#6b7280",
          confirmButtonText: "Sí, eliminar",
          cancelButtonText: "Cancelar",
          reverseButtons: true,
          showLoaderOnConfirm: true,
          customClass: {
            popup: "rounded-2xl",
            confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
            cancelButton: "rounded-xl px-6 py-2.5 font-semibold",
          },
          preConfirm: async () => {
            try {
              const response = await fetch(
                `/admin/orders/${orderId}/items/${itemId}`,
                {
                  method: "DELETE",
                  headers: {
                    "Content-Type": "application/json",
                  },
                }
              );

              const data = await response.json();

              if (!data.success) {
                // Check if this is the last item scenario
                if (data.isLastItem) {
                  return { isLastItem: true, message: data.message };
                }
                throw new Error(data.message);
              }

              return data;
            } catch (error) {
              Swal.showValidationMessage(`Error: ${error.message}`);
            }
          },
          allowOutsideClick: () => !Swal.isLoading(),
        });

        // Handle last item scenario
        if (result.isConfirmed && result.value && result.value.isLastItem) {
          const cancelResult = await Swal.fire({
            title: "Último Item",
            html:
              `<p>${result.value.message}</p>` +
              `<p class="text-sm text-gray-600 dark:text-gray-400 mt-3">` +
              `El sistema analizará cada item y devolverá el stock según corresponda.` +
              `</p>`,
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#ef4444",
            cancelButtonColor: "#6b7280",
            confirmButtonText: "Sí, cancelar orden",
            cancelButtonText: "No, mantener orden",
            reverseButtons: true,
            showLoaderOnConfirm: true,
            customClass: {
              popup: "rounded-2xl",
              confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
              cancelButton: "rounded-xl px-6 py-2.5 font-semibold",
            },
            preConfirm: async () => {
              try {
                const response = await fetch(
                  `/admin/orders/${orderId}/cancel`,
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                  }
                );

                const data = await response.json();

                if (!data.success) {
                  throw new Error(data.message);
                }

                return data;
              } catch (error) {
                Swal.showValidationMessage(`Error: ${error.message}`);
              }
            },
            allowOutsideClick: () => !Swal.isLoading(),
          });

          if (cancelResult.isConfirmed && cancelResult.value) {
            let message = cancelResult.value.message;

            // Add stock info if available
            if (cancelResult.value.stockInfo) {
              message += `<br><br><p class="text-sm mt-2">${cancelResult.value.stockInfo}</p>`;
            }

            if (cancelResult.value.warning) {
              message +=
                '<br><br><strong class="text-orange-600">⚠️ ' +
                cancelResult.value.warning +
                "</strong>";
            }

            Swal.fire({
              icon: "success",
              title: "¡Pedido Cancelado!",
              html: message,
              confirmButtonColor: "#38e07b",
              confirmButtonText: "Aceptar",
              customClass: {
                popup: "rounded-2xl",
                confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
              },
            }).then(() => {
              window.location.reload();
            });
          }
          return;
        }

        if (result.isConfirmed && result.value) {
          let message = result.value.message;

          // Add stock info
          if (result.value.stockInfo) {
            message += `<br><br><p class="text-sm mt-2">${result.value.stockInfo}</p>`;
          }

          // Add order summary
          if (result.value.remainingItems !== undefined) {
            message += `<br><br><p class="text-xs text-gray-600 dark:text-gray-400 mt-2">Items restantes: ${result.value.remainingItems}</p>`;
            message += `<p class="text-xs text-gray-600 dark:text-gray-400">Nuevo total: ${formatCurrency(
              result.value.orderTotal
            )}</p>`;
          }

          Swal.fire({
            icon: "success",
            title: "¡Item Eliminado!",
            html: message,
            confirmButtonColor: "#38e07b",
            confirmButtonText: "Aceptar",
            customClass: {
              popup: "rounded-2xl",
              confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
            },
          }).then(() => {
            window.location.reload();
          });
        }
      }

      // Event listeners for delete buttons
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".btn-delete-item").forEach((button) => {
          button.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            const itemId = this.getAttribute("data-item-id");
            const itemName = this.getAttribute("data-item-name");
            const itemStatus = this.getAttribute("data-item-status");
            const requiresPrep = this.getAttribute("data-requires-preparation");
            deleteOrderItem(
              orderId,
              itemId,
              itemName,
              itemStatus,
              requiresPrep
            );
          });
        });
      });

      /*]]>*/
    </script>

    <!-- Script del Sistema de Temas -->
    <div th:replace="~{fragments/theme :: themeScript}"></div>
  </body>
</html>
