<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Gran Sazón - Pedidos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700"
      rel="stylesheet"
    />

    <!-- Sistema de Temas (Modo Claro/Oscuro) -->
    <div th:replace="~{fragments/theme :: themeResources}"></div>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#38e07b",
              "primary-dark": "#2bc866",
              "background-light": "#f8faf9",
              "background-dark": "#0f1713",
            },
            fontFamily: {
              display: ["Work Sans"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              xl: "1rem",
              "2xl": "1.5rem",
              full: "9999px",
            },
          },
        },
      };
    </script>

    <!-- Sidebar Styles Fragment -->
    <div th:replace="~{fragments/sidebar :: sidebarStyles}"></div>

    <style>
      .table-responsive {
        overflow-x: auto;
        max-width: 100%;
      }

      .table-responsive::-webkit-scrollbar {
        height: 8px;
      }

      .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      .table-responsive::-webkit-scrollbar-thumb {
        background: #38e07b;
        border-radius: 10px;
      }

      .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #2bc866;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-background-light to-gray-50 dark:from-background-dark dark:to-gray-900 font-display text-gray-800 dark:text-gray-200 overflow-hidden"
  >
    <!-- Menu Controls Fragment -->
    <div th:replace="~{fragments/sidebar :: menuControls}"></div>

    <div class="flex min-h-screen h-screen overflow-hidden">
      <!-- SIDEBAR - Using Fragment -->
      <div
        th:replace="~{fragments/sidebar :: sidebar(activeMenu='orders')}"
      ></div>

      <!-- MAIN CONTENT -->
      <main class="flex-1 overflow-y-auto h-screen">
        <div class="p-4 sm:p-6 lg:p-8 pt-20 lg:pt-8">
          <!-- HEADER -->
          <div
            class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 sm:mb-8"
          >
            <div>
              <h2
                class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white mb-1"
              >
                Gestión de Pedidos
              </h2>
              <p class="text-sm sm:text-base text-gray-600 dark:text-gray-400">
                Administra todos los pedidos del restaurante
              </p>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
              <a
                th:href="@{/admin/orders/select-table}"
                class="flex items-center justify-center gap-2 px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl bg-gradient-to-r from-primary to-primary-dark text-white font-semibold hover:shadow-lg hover:shadow-primary/30 transition-all shadow-md text-sm sm:text-base"
              >
                <span class="material-symbols-outlined text-lg">add</span>
                Nuevo Pedido
              </a>
            </div>
          </div>

          <!-- Alerts -->
          <div
            th:if="${successMessage}"
            class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl"
          >
            <p
              class="text-green-800 dark:text-green-300"
              th:text="${successMessage}"
            ></p>
          </div>

          <div
            th:if="${errorMessage}"
            class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl"
          >
            <p
              class="text-red-800 dark:text-red-300"
              th:text="${errorMessage}"
            ></p>
          </div>

          <!-- STATS -->
          <div
            class="mb-6 sm:mb-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 sm:gap-6"
          >
            <!-- Paid Orders -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg"
            >
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-medium text-gray-600 dark:text-gray-400"
                >
                  Pedidos Pagados
                </h3>
                <span class="material-symbols-outlined text-2xl text-blue-500"
                  >payments</span
                >
              </div>
              <p
                class="text-3xl font-bold text-blue-500"
                th:text="${todayCount}"
              >
                0
              </p>
            </div>

            <!-- Today's Revenue -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg"
            >
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-medium text-gray-600 dark:text-gray-400"
                >
                  Ingresos Hoy
                </h3>
                <span class="material-symbols-outlined text-2xl text-primary"
                  >payments</span
                >
              </div>
              <p class="text-3xl font-bold text-primary">
                $<span th:text="${#numbers.formatDecimal(todayRevenue, 1, 2)}"
                  >0.00</span
                >
              </p>
            </div>

            <!-- Pending Orders -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg"
            >
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-medium text-gray-600 dark:text-gray-400"
                >
                  Pendientes
                </h3>
                <span class="material-symbols-outlined text-2xl text-yellow-500"
                  >pending</span
                >
              </div>
              <p
                class="text-3xl font-bold text-yellow-500"
                th:text="${pendingCount}"
              >
                0
              </p>
            </div>

            <!-- In Preparation -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg"
            >
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-medium text-gray-600 dark:text-gray-400"
                >
                  En Preparación
                </h3>
                <span class="material-symbols-outlined text-2xl text-orange-500"
                  >restaurant</span
                >
              </div>
              <p
                class="text-3xl font-bold text-orange-500"
                th:text="${inPreparationCount}"
              >
                0
              </p>
            </div>

            <!-- Active Orders -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg"
            >
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-medium text-gray-600 dark:text-gray-400"
                >
                  Activos
                </h3>
                <span class="material-symbols-outlined text-2xl text-purple-500"
                  >task_alt</span
                >
              </div>
              <p
                class="text-3xl font-bold text-purple-500"
                th:text="${activeCount}"
              >
                0
              </p>
            </div>
          </div>

          <!-- FILTERS CARD -->
          <div
            class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg mb-6"
          >
            <div class="flex items-center gap-2 mb-4">
              <span class="material-symbols-outlined text-primary text-2xl"
                >filter_alt</span
              >
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                Filtros de Búsqueda
              </h3>
            </div>

            <div
              class="flex flex-col lg:flex-row justify-between items-start lg:items-end gap-4"
            >
              <div
                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 flex-1"
              >
                <!-- Table Filter -->
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Mesa</label
                  >
                  <select
                    id="filterTable"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  >
                    <option value="">Todas las mesas</option>
                    <option
                      th:each="table : ${tables}"
                      th:value="${table.id}"
                      th:text="${'Mesa #' + table.tableNumber}"
                      th:selected="${selectedTableId != null && selectedTableId == table.id}"
                    ></option>
                  </select>
                </div>

                <!-- Status Filter -->
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Estado</label
                  >
                  <select
                    id="filterStatus"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  >
                    <option value="">Todos los estados</option>
                    <option
                      th:each="status : ${statuses}"
                      th:value="${status}"
                      th:text="${status.displayName}"
                      th:selected="${selectedStatus != null && selectedStatus == status}"
                    ></option>
                  </select>
                </div>

                <!-- Order Type Filter -->
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Tipo</label
                  >
                  <select
                    id="filterOrderType"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  >
                    <option value="">Todos los tipos</option>
                    <option
                      th:each="type : ${orderTypes}"
                      th:value="${type}"
                      th:text="${type.displayName}"
                      th:selected="${selectedOrderType != null && selectedOrderType == type}"
                    ></option>
                  </select>
                </div>

                <!-- Date Filter -->
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Fecha</label
                  >
                  <input
                    type="date"
                    id="filterDate"
                    th:value="${selectedDate}"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  />
                </div>
              </div>

              <!-- Filter Actions -->
              <div class="flex gap-2">
                <button
                  onclick="applyFilters()"
                  class="flex items-center gap-2 px-6 py-2.5 rounded-xl bg-gradient-to-r from-primary to-primary-dark text-white font-semibold hover:shadow-lg hover:shadow-primary/30 transition-all"
                >
                  <span class="material-symbols-outlined text-lg">search</span>
                  Filtrar
                </button>
                <button
                  onclick="clearFilters()"
                  class="flex items-center gap-2 px-6 py-2.5 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 transition-all"
                >
                  <span class="material-symbols-outlined text-lg">close</span>
                  Limpiar
                </button>
              </div>
            </div>
          </div>

          <!-- ORDERS TABLE -->
          <div
            class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-lg overflow-hidden"
          >
            <div
              class="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-800"
            >
              <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-primary text-2xl"
                  >receipt_long</span
                >
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                  Lista de Pedidos
                </h3>
              </div>
            </div>

            <div class="table-responsive">
              <table class="w-full text-sm text-left">
                <thead
                  class="text-xs uppercase bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300"
                >
                  <tr>
                    <th class="px-6 py-4 font-semibold">Nº Pedido</th>
                    <th class="px-6 py-4 font-semibold">Fecha/Hora</th>
                    <th class="px-6 py-4 font-semibold">Mesa</th>
                    <th class="px-6 py-4 font-semibold">Tipo</th>
                    <th class="px-6 py-4 font-semibold">Cliente</th>
                    <th class="px-6 py-4 font-semibold">Total</th>
                    <th class="px-6 py-4 font-semibold">Estado</th>
                    <th class="px-6 py-4 font-semibold">Atendido por</th>
                    <th class="px-6 py-4 font-semibold text-center">
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:if="${orders.empty}">
                    <td
                      colspan="9"
                      class="px-6 py-12 text-center text-gray-500 dark:text-gray-400"
                    >
                      <span
                        class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-700 mb-4 block"
                        >receipt_long</span
                      >
                      <p class="text-lg font-medium">
                        No hay pedidos registrados
                      </p>
                    </td>
                  </tr>
                  <tr
                    th:each="order : ${orders}"
                    th:data-order-id="${order.idOrder}"
                    class="border-b border-gray-200 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors"
                  >
                    <!-- Order Number -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="flex items-center gap-2">
                        <span
                          class="text-sm font-mono font-semibold text-primary"
                          th:text="${order.orderNumber}"
                        ></span>
                        <!-- New Items Indicator -->
                        <span
                          th:if="${order.hasNewItems()}"
                          class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-bold bg-gradient-to-r from-amber-400 to-orange-500 text-white shadow-md animate-pulse"
                          title="Este pedido tiene items nuevos agregados"
                        >
                          <span class="material-symbols-outlined !text-xs"
                            >fiber_new</span
                          >
                          NUEVOS
                        </span>
                      </div>
                    </td>

                    <!-- Date/Time -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div
                        class="text-sm text-gray-900 dark:text-white"
                        th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy')}"
                      ></div>
                      <div
                        class="text-xs text-gray-500 dark:text-gray-400"
                        th:text="${#temporals.format(order.createdAt, 'HH:mm')}"
                      ></div>
                    </td>

                    <!-- Table -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span
                        th:if="${order.table != null}"
                        class="text-sm text-gray-900 dark:text-white"
                        th:text="${'Mesa #' + order.table.tableNumber}"
                      ></span>
                      <span
                        th:if="${order.table == null}"
                        class="text-sm text-gray-400"
                        >N/A</span
                      >
                    </td>

                    <!-- Order Type -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span
                        class="px-3 py-1 text-xs rounded-full font-medium"
                        th:classappend="${order.orderType.name() == 'DINE_IN'} ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400' : (${order.orderType.name() == 'TAKEOUT'} ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400' : 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400')"
                        th:text="${order.orderType.displayName}"
                      >
                      </span>
                    </td>

                    <!-- Customer -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div
                        class="text-sm text-gray-900 dark:text-white"
                        th:text="${order.customerName}"
                      ></div>
                      <div
                        class="text-xs text-gray-500 dark:text-gray-400"
                        th:text="${order.customerPhone}"
                      ></div>
                    </td>

                    <!-- Total -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="text-sm font-semibold text-primary"
                        >$<span
                          th:text="${#numbers.formatDecimal(order.total, 1, 2)}"
                        ></span
                      ></span>
                    </td>

                    <!-- Status -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span
                        class="status-badge px-3 py-1 text-xs rounded-full font-medium transition-all duration-300"
                        th:classappend="${order.status.name() == 'PENDING'} ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400' : 
                                                     (${order.status.name() == 'IN_PREPARATION'} ? 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400' : 
                                                     (${order.status.name() == 'READY'} ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400' :
                                                     (${order.status.name() == 'ON_THE_WAY'} ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400' :
                                                     (${order.status.name() == 'DELIVERED'} ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' :
                                                     (${order.status.name() == 'PAID'} ? 'bg-primary/20 text-primary' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400')))))"
                        th:text="${order.status.displayName}"
                      >
                      </span>
                    </td>

                    <!-- Employee -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div
                        class="text-sm text-gray-900 dark:text-white"
                        th:text="${order.employee != null ? (order.employee.nombre + ' ' + order.employee.apellido) : 'Pedido Web'}"
                      ></div>
                    </td>

                    <!-- Actions -->
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                      <div class="flex items-center justify-center gap-2">
                        <!-- View -->
                        <a
                          th:href="@{/admin/orders/view/{id}(id=${order.idOrder})}"
                          class="p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-all"
                          title="Ver detalles"
                        >
                          <i class="fas fa-eye"></i>
                        </a>

                        <!-- Add Items (only for DINE_IN and TAKEOUT orders that can accept new items) -->
                        <a
                          th:if="${order.canAcceptNewItems()}"
                          th:href="@{/admin/orders/{id}/add-items(id=${order.idOrder})}"
                          class="p-2 rounded-lg bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-all"
                          title="Agregar items al pedido"
                        >
                          <i class="fas fa-plus-circle"></i>
                        </a>

                        <!-- Edit (disabled for PAID and CANCELLED) -->
                        <a
                          th:if="${order.status.name() != 'PAID' && order.status.name() != 'CANCELLED'}"
                          th:href="@{/admin/orders/edit/{id}(id=${order.idOrder})}"
                          class="p-2 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400 hover:bg-yellow-100 dark:hover:bg-yellow-900/40 transition-all"
                          title="Editar"
                        >
                          <i class="fas fa-edit"></i>
                        </a>

                        <!-- Change Status (not CANCELLED or PAID) -->
                        <button
                          th:if="${order.status.name() != 'CANCELLED' && order.status.name() != 'PAID'}"
                          class="btn-change-status p-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary hover:bg-primary/20 dark:hover:bg-primary/30 transition-all"
                          th:data-order-id="${order.idOrder}"
                          th:data-order-number="${order.orderNumber}"
                          th:data-order-status="${order.status.name()}"
                          title="Cambiar estado"
                        >
                          <i class="fas fa-exchange-alt"></i>
                        </button>

                        <!-- Pay (only DELIVERED) -->
                        <a
                          th:if="${order.status.name() == 'DELIVERED'}"
                          th:href="@{/admin/payments/form/{id}(id=${order.idOrder})}"
                          class="p-2 rounded-lg bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900/40 transition-all"
                          title="Procesar Pago"
                        >
                          <i class="fas fa-dollar-sign"></i>
                        </a>

                        <!-- Cancel (only if can be cancelled) -->
                        <button
                          th:if="${order.status.canBeCancelled()}"
                          class="btn-cancel-order p-2 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/40 transition-all"
                          th:data-order-id="${order.idOrder}"
                          th:data-order-number="${order.orderNumber}"
                          title="Cancelar pedido"
                        >
                          <i class="fas fa-times-circle"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script th:inline="javascript">
      // Filter functions
      function applyFilters() {
        const tableId = document.getElementById("filterTable").value;
        const status = document.getElementById("filterStatus").value;
        const orderType = document.getElementById("filterOrderType").value;
        const date = document.getElementById("filterDate").value;

        let url = "/admin/orders?";
        if (tableId) url += `tableId=${tableId}&`;
        if (status) url += `status=${status}&`;
        if (orderType) url += `orderType=${orderType}&`;
        if (date) url += `date=${date}&`;

        window.location.href = url;
      }

      function clearFilters() {
        window.location.href = "/admin/orders";
      }

      // Cancel order with AJAX
      function confirmCancel(orderId, orderNumber) {
        Swal.fire({
          title: "¿Cancelar pedido?",
          html:
            `<p>¿Estás seguro de que deseas cancelar el pedido <strong>${orderNumber}</strong>?</p>` +
            `<p class="text-sm text-gray-600 dark:text-gray-400 mt-3">` +
            `El sistema analizará cada item y devolverá el stock según corresponda.` +
            `</p>`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#38e07b",
          cancelButtonColor: "#ef4444",
          confirmButtonText: "Sí, cancelar",
          cancelButtonText: "No",
          reverseButtons: true,
          showLoaderOnConfirm: true,
          customClass: {
            popup: "rounded-2xl",
            confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
            cancelButton: "rounded-xl px-6 py-2.5 font-semibold",
          },
          preConfirm: () => {
            return fetch(`/admin/orders/${orderId}/cancel`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (!data.success) {
                  throw new Error(data.message);
                }
                return data;
              })
              .catch((error) => {
                Swal.showValidationMessage(`Error: ${error.message}`);
              });
          },
          allowOutsideClick: () => !Swal.isLoading(),
        }).then((result) => {
          if (result.isConfirmed && result.value) {
            let message = result.value.message;

            // Add stock info if available
            if (result.value.stockInfo) {
              message += `<br><br><p class="text-sm mt-2">${result.value.stockInfo}</p>`;
            }

            if (result.value.warning) {
              message +=
                '<br><br><strong class="text-orange-600">⚠️ ' +
                result.value.warning +
                "</strong>";
            }

            Swal.fire({
              icon: "success",
              title: "¡Pedido Cancelado!",
              html: message,
              confirmButtonColor: "#38e07b",
              confirmButtonText: "Aceptar",
              customClass: {
                popup: "rounded-2xl",
                confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
              },
            }).then(() => {
              window.location.reload();
            });
          }
        });
      }

      // Change status modal with AJAX
      function showStatusModal(orderId, orderNumber, currentStatus) {
        // First, get valid statuses from backend
        fetch(`/admin/orders/${orderId}/valid-statuses`)
          .then((response) => response.json())
          .then((data) => {
            if (!data.success || data.validStatuses.length === 0) {
              Swal.fire({
                icon: "info",
                title: "Información",
                text: "No hay cambios de estado disponibles para este pedido",
                confirmButtonColor: "#38e07b",
                customClass: {
                  popup: "rounded-2xl",
                  confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
                },
              });
              return;
            }

            // Build options HTML
            let optionsHtml =
              '<option value="">Seleccionar nuevo estado</option>';
            data.validStatuses.forEach((status) => {
              optionsHtml += `<option value="${status.value}">${status.label}</option>`;
            });

            // Show modal
            Swal.fire({
              title: "Cambiar Estado del Pedido",
              html: `
                <div class="text-left mb-4">
                    <p class="mb-2 text-gray-700">Pedido: <strong class="text-primary">${orderNumber}</strong></p>
                    <p class="mb-2 text-gray-700">Tipo: <strong>${
                      data.orderType === "DELIVERY"
                        ? "Entrega a Domicilio"
                        : data.orderType === "TAKEOUT"
                        ? "Para Llevar"
                        : "Para Comer Aquí"
                    }</strong></p>
                    <p class="mb-4 text-gray-700">Estado Actual: <span class="px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${
                      data.currentStatusLabel
                    }</span></p>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nuevo Estado:</label>
                    <select id="newStatus" class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-primary">
                        ${optionsHtml}
                    </select>
                </div>
              `,
              icon: "question",
              showCancelButton: true,
              confirmButtonColor: "#38e07b",
              cancelButtonColor: "#6b7280",
              confirmButtonText: "Cambiar Estado",
              cancelButtonText: "Cancelar",
              reverseButtons: true,
              showLoaderOnConfirm: true,
              customClass: {
                popup: "rounded-2xl",
                confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
                cancelButton: "rounded-xl px-6 py-2.5 font-semibold",
              },
              preConfirm: () => {
                const newStatus = document.getElementById("newStatus").value;
                if (!newStatus) {
                  Swal.showValidationMessage("Debes seleccionar un estado");
                  return false;
                }

                return fetch(
                  `/admin/orders/${orderId}/change-status?newStatus=${newStatus}`,
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/x-www-form-urlencoded",
                    },
                  }
                )
                  .then((response) => response.json())
                  .then((data) => {
                    if (!data.success) {
                      throw new Error(data.message);
                    }
                    return data;
                  })
                  .catch((error) => {
                    Swal.showValidationMessage(`Error: ${error.message}`);
                  });
              },
              allowOutsideClick: () => !Swal.isLoading(),
            }).then((result) => {
              if (result.isConfirmed && result.value) {
                Swal.fire({
                  icon: "success",
                  title: "¡Estado Actualizado!",
                  text: result.value.message,
                  timer: 2000,
                  showConfirmButton: false,
                  customClass: {
                    popup: "rounded-2xl",
                  },
                });

                setTimeout(() => {
                  window.location.reload();
                }, 2100);
              }
            });
          })
          .catch((error) => {
            Swal.fire({
              icon: "error",
              title: "Error",
              text:
                "No se pudieron cargar los estados disponibles: " +
                error.message,
              confirmButtonColor: "#38e07b",
              customClass: {
                popup: "rounded-2xl",
                confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
              },
            });
          });
      }

      // Event listeners for action buttons
      document.addEventListener("DOMContentLoaded", function () {
        // Cancel order buttons
        document.querySelectorAll(".btn-cancel-order").forEach((button) => {
          button.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            const orderNumber = this.getAttribute("data-order-number");
            confirmCancel(orderId, orderNumber);
          });
        });

        // Change status buttons
        document.querySelectorAll(".btn-change-status").forEach((button) => {
          button.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            const orderNumber = this.getAttribute("data-order-number");
            const orderStatus = this.getAttribute("data-order-status");
            showStatusModal(orderId, orderNumber, orderStatus);
          });
        });

        // Add items buttons
        document.querySelectorAll(".btn-add-items").forEach((button) => {
          button.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            const orderNumber = this.getAttribute("data-order-number");
            openAddItemsModal(orderId, orderNumber);
          });
        });
      });

      // ========== ADD ITEMS MODAL FUNCTIONS ==========
      let selectedItems = [];
      let menuItems = [];
      let currentOrderId = null;
      let currentOrderNumber = "";

      // Open modal and load menu items
      async function openAddItemsModal(orderId, orderNumber) {
        currentOrderId = orderId;
        currentOrderNumber = orderNumber;
        document.getElementById("addItemsModal").classList.remove("hidden");
        document.getElementById("modalOrderNumber").textContent = orderNumber;
        await loadMenuItems();
      }

      // Close modal
      function closeAddItemsModal() {
        document.getElementById("addItemsModal").classList.add("hidden");
        document.getElementById("searchMenuItems").value = "";
        selectedItems = [];
        updateSelectedItemsDisplay();
      }

      // Load menu items from server
      async function loadMenuItems() {
        try {
          const response = await fetch("/admin/orders/menu-items/available");
          const data = await response.json();

          if (data.success) {
            menuItems = data.data;
            renderMenuItems();
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: data.message || "No se pudieron cargar los items del menú",
            });
          }
        } catch (error) {
          console.error("Error loading menu items:", error);
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "Error al cargar los items del menú",
          });
        }
      }

      // Render menu items in grid
      function renderMenuItems(searchTerm = "") {
        const grid = document.getElementById("menuItemsGrid");
        const noResults = document.getElementById("noResultsMessage");
        const itemsCount = document.getElementById("itemsFoundCount");
        grid.innerHTML = "";

        // Filter items based on search term
        const filteredItems = menuItems.filter((item) => {
          if (!item.available) return false;
          if (!searchTerm) return true;

          // Search in name (case insensitive)
          return item.name.toLowerCase().includes(searchTerm.toLowerCase());
        });

        // Update count
        itemsCount.textContent = filteredItems.length;

        // Show/hide no results message
        if (filteredItems.length === 0) {
          grid.classList.add("hidden");
          noResults.classList.remove("hidden");
          return;
        } else {
          grid.classList.remove("hidden");
          noResults.classList.add("hidden");
        }

        filteredItems.forEach((item) => {
          const card = document.createElement("div");
          card.className =
            "bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 cursor-pointer hover:shadow-lg transition-all hover:-translate-y-1";
          card.onclick = () => toggleItemSelection(item);

          card.innerHTML = `
            <div class="flex flex-col gap-2">
              <h4 class="font-semibold text-gray-900 dark:text-white text-sm line-clamp-2">${
                item.name
              }</h4>
              <p class="text-xs text-gray-500 dark:text-gray-400 line-clamp-1">${
                item.category || ""
              }</p>
              <p class="text-lg font-bold text-primary">${formatCurrency(
                item.price
              )}</p>
              <button class="mt-2 px-3 py-1.5 bg-primary text-white text-xs rounded-lg hover:bg-primary-dark transition-all">
                Seleccionar
              </button>
            </div>
          `;

          grid.appendChild(card);
        });
      }

      // Filter menu items based on search input
      function filterMenuItems() {
        const searchTerm = document.getElementById("searchMenuItems").value;
        renderMenuItems(searchTerm);
      }

      // Toggle item selection
      function toggleItemSelection(item) {
        const existingIndex = selectedItems.findIndex(
          (si) => si.idItemMenu === item.idItemMenu
        );

        if (existingIndex >= 0) {
          showQuantityModal(item, existingIndex);
        } else {
          showQuantityModal(item, -1);
        }
      }

      // Show quantity and comments modal
      async function showQuantityModal(item, existingIndex) {
        const isEdit = existingIndex >= 0;
        const currentQty = isEdit ? selectedItems[existingIndex].quantity : 1;
        const currentComments = isEdit
          ? selectedItems[existingIndex].comments
          : "";

        const { value: formValues } = await Swal.fire({
          title: item.name,
          html: `
            <div class="text-left space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad</label>
                <input type="number" id="swal-quantity" value="${currentQty}" min="1" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Comentarios</label>
                <textarea id="swal-comments" rows="3" 
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                          placeholder="Ej: Sin cebolla, picante aparte...">${currentComments}</textarea>
              </div>
              <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                <p class="text-sm text-blue-800 dark:text-blue-300">
                  <strong>Precio:</strong> ${formatCurrency(item.price)} c/u
                </p>
              </div>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: isEdit ? "Actualizar" : "Agregar",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#38e07b",
          cancelButtonColor: "#6b7280",
          showDenyButton: isEdit,
          denyButtonText: "Eliminar",
          denyButtonColor: "#ef4444",
          preConfirm: () => {
            const quantity = parseInt(
              document.getElementById("swal-quantity").value
            );
            const comments = document
              .getElementById("swal-comments")
              .value.trim();

            if (!quantity || quantity < 1) {
              Swal.showValidationMessage("La cantidad debe ser al menos 1");
              return false;
            }

            return { quantity, comments };
          },
        });

        if (formValues) {
          if (isEdit) {
            selectedItems[existingIndex].quantity = formValues.quantity;
            selectedItems[existingIndex].comments = formValues.comments;
          } else {
            selectedItems.push({
              idItemMenu: item.idItemMenu,
              name: item.name,
              price: item.price,
              quantity: formValues.quantity,
              comments: formValues.comments,
            });
          }
          updateSelectedItemsDisplay();
        } else if (isEdit && Swal.isDenied()) {
          selectedItems.splice(existingIndex, 1);
          updateSelectedItemsDisplay();
        }
      }

      // Update selected items display
      function updateSelectedItemsDisplay() {
        const summary = document.getElementById("selectedItemsSummary");
        const count = document.getElementById("selectedItemsCount");
        const list = document.getElementById("selectedItemsList");
        const btnConfirm = document.getElementById("btnConfirmAddItems");

        if (selectedItems.length === 0) {
          summary.classList.add("hidden");
          btnConfirm.disabled = true;
          return;
        }

        summary.classList.remove("hidden");
        count.textContent = selectedItems.length;
        btnConfirm.disabled = false;

        list.innerHTML = selectedItems
          .map(
            (item, index) => `
          <div class="flex items-center justify-between bg-white dark:bg-gray-800 p-3 rounded-lg">
            <div class="flex-1">
              <p class="font-semibold text-gray-900 dark:text-white text-sm">${
                item.name
              } x${item.quantity}</p>
              ${
                item.comments
                  ? `<p class="text-xs text-gray-500 dark:text-gray-400 italic">${item.comments}</p>`
                  : ""
              }
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm font-bold text-primary">${formatCurrency(
                item.price * item.quantity
              )}</span>
              <button onclick="editSelectedItem(${index})" class="text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/30 p-1 rounded">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="removeSelectedItem(${index})" class="text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/30 p-1 rounded">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `
          )
          .join("");
      }

      // Edit selected item
      function editSelectedItem(index) {
        const item = selectedItems[index];
        const menuItem = menuItems.find(
          (mi) => mi.idItemMenu === item.idItemMenu
        );
        if (menuItem) {
          showQuantityModal(menuItem, index);
        }
      }

      // Remove selected item
      function removeSelectedItem(index) {
        selectedItems.splice(index, 1);
        updateSelectedItemsDisplay();
      }

      // Confirm and send items to server
      async function confirmAddItems() {
        if (selectedItems.length === 0) {
          Swal.fire({
            icon: "warning",
            title: "Sin items",
            text: "Selecciona al menos un item para agregar",
          });
          return;
        }

        const result = await Swal.fire({
          title: "¿Confirmar agregación?",
          html: `
            <p class="mb-2">¿Deseas agregar estos items al pedido <strong>${currentOrderNumber}</strong>?</p>
            <div class="text-left bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mt-4 max-h-48 overflow-y-auto">
              ${selectedItems
                .map(
                  (item) =>
                    `<p class="text-sm mb-1">• ${item.name} x${
                      item.quantity
                    } - ${formatCurrency(item.price * item.quantity)}</p>`
                )
                .join("")}
            </div>
          `,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Sí, agregar",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#38e07b",
          cancelButtonColor: "#6b7280",
        });

        if (!result.isConfirmed) return;

        const itemsData = selectedItems.map((item) => ({
          idItemMenu: item.idItemMenu,
          quantity: item.quantity,
          comments: item.comments || null,
        }));

        try {
          Swal.fire({
            title: "Agregando items...",
            text: "Por favor espere",
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
              Swal.showLoading();
            },
          });

          const response = await fetch(
            `/admin/orders/${currentOrderId}/add-items`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(itemsData),
            }
          );

          const data = await response.json();

          Swal.close();

          if (data.success) {
            Swal.fire({
              icon: "success",
              title: "Items agregados",
              text: `Los items fueron agregados exitosamente al pedido ${currentOrderNumber}`,
              timer: 2000,
              showConfirmButton: false,
              customClass: {
                popup: "rounded-2xl",
              },
            });

            closeAddItemsModal();
            setTimeout(() => {
              window.location.reload();
            }, 2100);
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: data.message || "No se pudieron agregar los items",
            });
          }
        } catch (error) {
          Swal.close();
          console.error("Error adding items:", error);
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "Error al agregar los items al pedido",
          });
        }
      }

      // Format currency
      function formatCurrency(amount) {
        return new Intl.NumberFormat("es-CO", {
          style: "currency",
          currency: "COP",
          minimumFractionDigits: 0,
        }).format(amount);
      }

      // Auto-download ticket PDF after payment
      document.addEventListener("DOMContentLoaded", function () {
        const downloadTicket = /*[[${downloadTicket}]]*/ false;
        if (downloadTicket) {
          // Trigger download after a short delay
          setTimeout(function () {
            window.location.href = "/admin/payments/download-ticket";
          }, 500);
        }
      });
    </script>

    <!-- WebSocket for Real-time Updates -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
      let stompClient = null;
      let statsUpdateTimeout = null;
      let pendingStatsUpdate = false;
      const STATS_UPDATE_DELAY = 2000; // Wait 2 seconds before updating stats

      // Reconnection control
      let reconnectAttempts = 0;
      let maxReconnectAttempts = 10;
      let reconnectDelay = 1000;
      let maxReconnectDelay = 30000;
      let isIntentionalDisconnect = false;

      function connectAdminOrdersWebSocket() {
        if (reconnectAttempts >= maxReconnectAttempts) {
          console.warn("⛔ ADMIN Orders: Máximo de intentos alcanzado");
          return;
        }

        console.log(`🔄 ADMIN Orders: Intento #${reconnectAttempts + 1}`);
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // Disable console logging

        stompClient.connect(
          {},
          function (frame) {
            console.log("✅ Orders List WebSocket Connected");
            reconnectAttempts = 0;
            reconnectDelay = 1000;

            // Subscribe to admin kitchen channel for order updates
            stompClient.subscribe("/topic/admin/kitchen", function (message) {
              const notification = JSON.parse(message.body);
              console.log(
                "📦 Order notification - Type:",
                notification.notificationType,
                "ID:",
                notification.orderId
              );
              handleOrderListUpdate(notification);
            });
          },
          function (error) {
            if (isIntentionalDisconnect) {
              console.log("👋 ADMIN Orders: Desconexión intencional");
              return;
            }

            reconnectAttempts++;
            console.error(
              `❌ ADMIN Orders: Error (${reconnectAttempts}/${maxReconnectAttempts}):`,
              error
            );

            if (reconnectAttempts < maxReconnectAttempts) {
              const delay = Math.min(
                reconnectDelay * Math.pow(2, reconnectAttempts - 1),
                maxReconnectDelay
              );
              console.log(
                `⏱️ ADMIN Orders: Reintentando en ${delay / 1000}s...`
              );
              setTimeout(connectAdminOrdersWebSocket, delay);
            }
          }
        );
      }

      function handleOrderListUpdate(notification) {
        const orderId = notification.orderId;
        const newStatus = notification.status;

        // Immediately update the specific order row (no delay)
        const orderRow = document.querySelector(
          `tr[data-order-id="${orderId}"]`
        );

        if (orderRow) {
          const statusBadge = orderRow.querySelector(".status-badge");
          if (statusBadge) {
            updateStatusBadge(statusBadge, newStatus);
            console.log("🔄 Updated order", orderId, "status to", newStatus);
          }

          // Add subtle flash animation
          orderRow.classList.add("bg-primary/5");
          setTimeout(() => {
            orderRow.classList.remove("bg-primary/5");
          }, 1500);
        }

        // Debounce stats update to avoid excessive requests
        if (statsUpdateTimeout) {
          clearTimeout(statsUpdateTimeout);
        }

        pendingStatsUpdate = true;

        statsUpdateTimeout = setTimeout(() => {
          if (pendingStatsUpdate) {
            console.log("📊 Updating stats (debounced)...");
            pendingStatsUpdate = false;
            updateOrderStatsFromServer();
          }
        }, STATS_UPDATE_DELAY);
      }

      function updateOrderStatsFromServer() {
        fetch("/admin/orders/stats")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Stats fetch failed: " + response.status);
            }
            return response.json();
          })
          .then((data) => {
            updateOrderStats(data);
          })
          .catch((error) => console.error("❌ Error updating stats:", error));
      }

      function updateStatusBadge(badge, status) {
        // Remove all status classes
        badge.className =
          "status-badge px-3 py-1 text-xs rounded-full font-medium transition-all duration-300";

        // Add new status classes and text
        switch (status) {
          case "PENDING":
            badge.classList.add(
              "bg-yellow-100",
              "text-yellow-800",
              "dark:bg-yellow-900/30",
              "dark:text-yellow-400"
            );
            badge.textContent = "Pendiente";
            break;
          case "IN_PREPARATION":
            badge.classList.add(
              "bg-orange-100",
              "text-orange-800",
              "dark:bg-orange-900/30",
              "dark:text-orange-400"
            );
            badge.textContent = "En Preparación";
            break;
          case "READY":
            badge.classList.add(
              "bg-blue-100",
              "text-blue-800",
              "dark:bg-blue-900/30",
              "dark:text-blue-400"
            );
            badge.textContent = "Listo";
            break;
          case "ON_THE_WAY":
            badge.classList.add(
              "bg-purple-100",
              "text-purple-800",
              "dark:bg-purple-900/30",
              "dark:text-purple-400"
            );
            badge.textContent = "En Camino";
            break;
          case "DELIVERED":
            badge.classList.add(
              "bg-green-100",
              "text-green-800",
              "dark:bg-green-900/30",
              "dark:text-green-400"
            );
            badge.textContent = "Entregado";
            break;
          case "PAID":
            badge.classList.add("bg-primary/20", "text-primary");
            badge.textContent = "Pagado";
            break;
          case "CANCELLED":
            badge.classList.add(
              "bg-red-100",
              "text-red-800",
              "dark:bg-red-900/30",
              "dark:text-red-400"
            );
            badge.textContent = "Cancelado";
            break;
          default:
            badge.classList.add(
              "bg-gray-100",
              "text-gray-800",
              "dark:bg-gray-900/30",
              "dark:text-gray-400"
            );
            badge.textContent = status;
        }
      }

      function updateOrderStats(stats) {
        let updatedCount = 0;

        // Update Today's Orders count
        const todayCountEl = document.querySelector(
          '[th\\:text*="todayCount"]'
        );
        if (todayCountEl && stats.todayCount != null) {
          todayCountEl.textContent = stats.todayCount;
          updatedCount++;
        }

        // Update Today's Revenue
        const todayRevenueEl = document.querySelector(
          '[th\\:text*="todayRevenue"]'
        );
        if (todayRevenueEl && stats.todayRevenue != null) {
          const formatted = new Intl.NumberFormat("es-CO", {
            style: "currency",
            currency: "COP",
            minimumFractionDigits: 0,
          }).format(stats.todayRevenue);
          todayRevenueEl.textContent = formatted;
          updatedCount++;
        }

        // Update Pending count
        const pendingCountEl = document.querySelector(
          '[th\\:text*="pendingCount"]'
        );
        if (pendingCountEl && stats.pendingCount != null) {
          pendingCountEl.textContent = stats.pendingCount;
          updatedCount++;
        }

        // Update In Preparation count
        const inPrepCountEl = document.querySelector(
          '[th\\:text*="inPreparationCount"]'
        );
        if (inPrepCountEl && stats.inPreparationCount != null) {
          inPrepCountEl.textContent = stats.inPreparationCount;
          updatedCount++;
        }

        // Update Active count
        const activeCountEl = document.querySelector(
          '[th\\:text*="activeCount"]'
        );
        if (activeCountEl && stats.activeCount != null) {
          activeCountEl.textContent = stats.activeCount;
          updatedCount++;
        }

        if (updatedCount > 0) {
          console.log("✅ Stats updated -", updatedCount, "fields changed");
        }
      }

      // Connect on page load
      document.addEventListener("DOMContentLoaded", function () {
        connectAdminOrdersWebSocket();
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", function () {
        console.log("👋 ADMIN Orders: Página cerrándose...");
        isIntentionalDisconnect = true;

        if (statsUpdateTimeout) {
          clearTimeout(statsUpdateTimeout);
        }
        if (stompClient !== null && stompClient.connected) {
          stompClient.disconnect();
        }
      });
    </script>

    <!-- Script del Sistema de Temas -->
    <div th:replace="~{fragments/theme :: themeScript}"></div>
  </body>
</html>
