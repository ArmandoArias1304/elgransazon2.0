<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title
      th:text="${itemMenu.idItemMenu != null ? 'Editar Item del Menú' : 'Nuevo Item del Menú'}"
    >
      Item del Menú
    </title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700"
      rel="stylesheet"
    />

    <!-- Sistema de Temas (Modo Claro/Oscuro) -->
    <div th:replace="~{fragments/theme :: themeResources}"></div>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#38e07b",
              "primary-dark": "#2bc866",
              "background-light": "#f8faf9",
              "background-dark": "#0f1713",
            },
            fontFamily: {
              display: ["Work Sans"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              xl: "1rem",
              "2xl": "1.5rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      .ingredient-row {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-background-light to-gray-50 font-display text-gray-800 min-h-screen"
  >
    <!-- Main Content Centered -->
    <div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
          <a
            th:href="@{/admin/menu-items}"
            class="inline-flex items-center gap-2 text-gray-600 hover:text-primary transition-colors mb-4"
          >
            <span class="material-symbols-outlined">arrow_back</span>
            <span class="font-medium">Volver al menú</span>
          </a>
          <h1
            class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2"
            th:text="${itemMenu.idItemMenu != null ? 'Editar Item del Menú' : 'Nuevo Item del Menú'}"
          >
            Item del Menú
          </h1>
          <p class="text-base text-gray-600">
            Complete la información del item y su receta de ingredientes
          </p>
        </div>

        <!-- Alert Messages -->
        <div
          th:if="${successMessage}"
          class="mb-6 p-4 rounded-xl bg-green-100 border border-green-200 flex items-center gap-3"
        >
          <span class="material-symbols-outlined text-green-600"
            >check_circle</span
          >
          <p class="text-green-800 font-medium" th:text="${successMessage}"></p>
        </div>

        <div
          th:if="${errorMessage}"
          class="mb-6 p-4 rounded-xl bg-red-100 border border-red-200 flex items-center gap-3"
        >
          <span class="material-symbols-outlined text-red-600">error</span>
          <p class="text-red-800 font-medium" th:text="${errorMessage}"></p>
        </div>

        <!-- Form -->
        <form
          th:action="${formAction}"
          method="post"
          th:object="${itemMenu}"
          class="space-y-6"
        >
          <!-- Hidden ID Field -->
          <input type="hidden" th:field="*{idItemMenu}" />

          <!-- Sección 1: Información Básica -->
          <div
            class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6"
          >
            <h2
              class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2"
            >
              <div
                class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center"
              >
                <span class="material-symbols-outlined text-primary">info</span>
              </div>
              <span>Información Básica</span>
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Nombre -->
              <div class="md:col-span-2">
                <label
                  for="name"
                  class="block text-sm font-semibold text-gray-700 mb-2"
                >
                  Nombre del Platillo <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="name"
                  th:field="*{name}"
                  required
                  maxlength="200"
                  placeholder="Ej: Hamburguesa Clásica, Coca-Cola 355ml"
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 bg-white text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>

              <!-- Descripción -->
              <div class="md:col-span-2">
                <label
                  for="description"
                  class="block text-sm font-semibold text-gray-700 mb-2"
                >
                  Descripción
                </label>
                <textarea
                  id="description"
                  th:field="*{description}"
                  rows="3"
                  maxlength="1000"
                  placeholder="Descripción del platillo, ingredientes destacados, etc."
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 bg-white text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-transparent resize-none transition-all"
                ></textarea>
              </div>

              <!-- Precio -->
              <div>
                <label
                  for="price"
                  class="block text-sm font-semibold text-gray-700 mb-2"
                >
                  Precio <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <span
                    class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-semibold"
                    >$</span
                  >
                  <input
                    type="number"
                    id="price"
                    th:field="*{price}"
                    required
                    step="0.01"
                    min="0"
                    placeholder="0.00"
                    class="w-full pl-8 pr-4 py-3 rounded-xl border border-gray-300 bg-white text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  />
                </div>
              </div>

              <!-- URL de Imagen -->
              <div>
                <label
                  for="imageUrl"
                  class="block text-sm font-semibold text-gray-700 mb-2"
                >
                  URL de la Imagen
                </label>
                <input
                  type="url"
                  id="imageUrl"
                  th:field="*{imageUrl}"
                  maxlength="500"
                  placeholder="https://ejemplo.com/imagen.jpg"
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 bg-white text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>

              <!-- Estado Activo -->
              <div class="md:col-span-2">
                <div
                  class="flex items-center gap-3 p-4 rounded-xl bg-gray-50 border border-gray-200"
                >
                  <input
                    type="checkbox"
                    id="active"
                    th:field="*{active}"
                    class="w-5 h-5 text-primary bg-white border-gray-300 rounded focus:ring-2 focus:ring-primary"
                  />
                  <label for="active" class="text-sm font-medium text-gray-700">
                    Item activo y visible en el menú
                  </label>
                </div>
              </div>

              <!-- Requiere Preparación del Chef -->
              <div class="md:col-span-2">
                <div
                  class="flex items-center gap-3 p-4 rounded-xl bg-orange-50 border border-orange-200"
                >
                  <!-- Spring MVC checkbox convention: hidden field with prefix _ -->
                  <input type="hidden" name="_requiresPreparation" value="on" />
                  <input
                    type="checkbox"
                    id="requiresPreparation"
                    name="requiresPreparation"
                    th:checked="${itemMenu.requiresPreparation}"
                    class="w-5 h-5 text-orange-600 bg-white border-gray-300 rounded focus:ring-2 focus:ring-orange-500"
                  />
                  <div>
                    <label
                      for="requiresPreparation"
                      class="text-sm font-semibold text-gray-900 block"
                    >
                      ¿Requiere preparación del chef?
                    </label>
                    <p class="text-xs text-gray-600 mt-1">
                      <span class="font-medium">Marcado:</span> El chef debe
                      preparar este item (pizzas, hamburguesas, platos
                      calientes).
                      <br />
                      <span class="font-medium">Desmarcado:</span> Item listo
                      para servir (refrescos, bebidas embotelladas, postres
                      comprados).
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección 2: Categoría -->
          <div
            class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6"
          >
            <h2
              class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2"
            >
              <div
                class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center"
              >
                <span class="material-symbols-outlined text-purple-600"
                  >category</span
                >
              </div>
              <span>Categoría</span>
            </h2>

            <div>
              <label
                for="categorySelect"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                Seleccione la Categoría <span class="text-red-500">*</span>
              </label>
              <select
                id="categorySelect"
                th:field="*{category.idCategory}"
                required
                class="w-full px-4 py-3 rounded-xl border border-gray-300 bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
              >
                <option value="">-- Seleccione una categoría --</option>
                <option
                  th:each="category : ${categories}"
                  th:value="${category.idCategory}"
                  th:text="${category.name}"
                  th:selected="${itemMenu.category != null && itemMenu.category.idCategory == category.idCategory}"
                >
                  Categoría
                </option>
              </select>
            </div>
          </div>

          <!-- Sección 3: Ingredientes (Receta) -->
          <div
            class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6"
          >
            <div class="flex items-center justify-between mb-6">
              <h2
                class="text-xl font-bold text-gray-900 flex items-center gap-2"
              >
                <div
                  class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center"
                >
                  <span class="material-symbols-outlined text-orange-600"
                    >restaurant</span
                  >
                </div>
                <span>Ingredientes de la Receta</span>
              </h2>
              <button
                type="button"
                onclick="addIngredientRow()"
                class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-primary to-primary-dark text-white font-semibold rounded-xl hover:shadow-lg hover:shadow-primary/30 transition-all"
              >
                <span class="material-symbols-outlined text-lg">add</span>
                <span>Agregar Ingrediente</span>
              </button>
            </div>

            <!-- Container de ingredientes -->
            <div id="ingredientsContainer" class="space-y-3">
              <!-- Mensaje cuando no hay ingredientes -->
              <div
                id="noIngredientsMessage"
                class="text-center py-8 text-gray-500"
              >
                <span class="material-symbols-outlined text-5xl mb-2"
                  >restaurant</span
                >
                <p>
                  No hay ingredientes agregados. Haz clic en "Agregar
                  Ingrediente"
                </p>
              </div>

              <!-- Ingredientes existentes (en edición) -->
              <div
                th:if="${recipe != null && !#lists.isEmpty(recipe)}"
                th:each="recipeItem : ${recipe}"
              >
                <div
                  class="ingredient-row flex flex-col sm:flex-row gap-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600"
                >
                  <div class="flex-1">
                    <label
                      class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1"
                      >Ingrediente</label
                    >
                    <select
                      name="ingredientIds"
                      required
                      class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="">Seleccionar...</option>
                      <option
                        th:each="ing : ${ingredients}"
                        th:value="${ing.idIngredient}"
                        th:selected="${recipeItem.ingredient.idIngredient == ing.idIngredient}"
                        th:text="${ing.name + ' (Stock: ' + ing.currentStock + ' ' + ing.unitOfMeasure + ')'}"
                      ></option>
                    </select>
                  </div>
                  <div class="w-full sm:w-28">
                    <label
                      class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1"
                      >Cantidad</label
                    >
                    <input
                      type="number"
                      name="quantities"
                      th:value="${recipeItem.quantity}"
                      step="0.001"
                      min="0"
                      required
                      placeholder="0.000"
                      class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <div class="w-full sm:w-28">
                    <label
                      class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1"
                      >Unidad</label
                    >
                    <input
                      type="text"
                      name="units"
                      th:value="${recipeItem.unit}"
                      required
                      readonly
                      placeholder="Automático"
                      class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 text-sm cursor-not-allowed"
                    />
                  </div>
                  <div class="flex items-end">
                    <button
                      type="button"
                      onclick="removeIngredientRow(this)"
                      class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
                    >
                      <span class="material-symbols-outlined">delete</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Template para nuevos ingredientes (hidden) -->
              <div
                id="ingredientTemplate"
                class="ingredient-row hidden grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-gray-50 rounded-xl border border-gray-200"
              >
                <div class="md:col-span-5">
                  <label class="block text-xs font-medium text-gray-700 mb-1"
                    >Ingrediente</label
                  >
                  <select
                    name="ingredientIds"
                    onchange="loadIngredientUnit(this)"
                    class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-white text-gray-900 text-sm focus:ring-2 focus:ring-primary focus:border-transparent"
                  >
                    <option value="">Seleccionar...</option>
                    <option
                      th:each="ing : ${ingredients}"
                      th:value="${ing.idIngredient}"
                      th:text="${ing.name + ' (Stock: ' + ing.currentStock + ' ' + ing.unitOfMeasure + ')'}"
                    >
                      Ingrediente
                    </option>
                  </select>
                </div>

                <div class="md:col-span-3">
                  <label class="block text-xs font-medium text-gray-700 mb-1"
                    >Cantidad</label
                  >
                  <input
                    type="number"
                    name="quantities"
                    step="0.01"
                    min="0.01"
                    placeholder="0.00"
                    class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-white text-gray-900 text-sm focus:ring-2 focus:ring-primary focus:border-transparent"
                  />
                </div>

                <div class="md:col-span-3">
                  <label class="block text-xs font-medium text-gray-700 mb-1"
                    >Unidad</label
                  >
                  <input
                    type="text"
                    name="units"
                    readonly
                    placeholder="kg, L, pz"
                    class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 text-sm"
                  />
                </div>

                <div class="md:col-span-1 flex items-end">
                  <button
                    type="button"
                    onclick="removeIngredientRow(this)"
                    class="w-full p-2 rounded-lg hover:bg-red-100 transition-colors"
                    title="Eliminar"
                  >
                    <span class="material-symbols-outlined text-red-600"
                      >delete</span
                    >
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones de Acción -->
          <div class="flex flex-col sm:flex-row gap-3 justify-center pt-4">
            <button
              type="submit"
              class="flex-1 sm:flex-none px-8 py-3 bg-gradient-to-r from-primary to-primary-dark text-white font-bold rounded-xl hover:shadow-lg hover:shadow-primary/30 transition-all flex items-center justify-center gap-2"
            >
              <span class="material-symbols-outlined">save</span>
              <span
                th:text="${itemMenu.idItemMenu != null ? 'Actualizar Item' : 'Crear Item'}"
                >Guardar</span
              >
            </button>

            <a
              th:href="@{/admin/menu-items}"
              class="flex-1 sm:flex-none px-8 py-3 bg-white border-2 border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold rounded-xl transition-colors flex items-center justify-center gap-2"
            >
              <span class="material-symbols-outlined">cancel</span>
              <span>Cancelar</span>
            </a>
          </div>
        </form>
      </div>
    </div>

    <script>
      // ========== Cargar Unidad de Medida al seleccionar Ingrediente ==========
      function loadIngredientUnit(selectElement) {
        const ingredientId = selectElement.value;
        const row = selectElement.closest(".ingredient-row");
        const unitInput = row.querySelector('input[name="units"]');

        if (!ingredientId) {
          unitInput.value = "";
          return;
        }

        // Mostrar loading
        unitInput.value = "Cargando...";

        // Fetch ingredient details
        fetch(`/admin/menu-items/ingredient/${ingredientId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              unitInput.value = data.unitOfMeasure || "N/A";
            } else {
              unitInput.value = "Error";
              console.error("Error loading ingredient unit:", data.error);
            }
          })
          .catch((error) => {
            console.error("Error loading ingredient unit:", error);
            unitInput.value = "Error";
          });
      }

      // ========== Gestión de Ingredientes ==========
      function addIngredientRow() {
        const container = document.getElementById("ingredientsContainer");
        const template = document.getElementById("ingredientTemplate");
        const noMessage = document.getElementById("noIngredientsMessage");

        // Ocultar mensaje de "no hay ingredientes"
        if (noMessage) {
          noMessage.style.display = "none";
        }

        // Clonar el template
        const newRow = template.cloneNode(true);
        newRow.id = "";
        newRow.classList.remove("hidden");

        // Agregar atributo required a los campos clonados
        const ingredientSelect = newRow.querySelector(
          'select[name="ingredientIds"]'
        );
        const quantityInput = newRow.querySelector('input[name="quantities"]');
        const unitInput = newRow.querySelector('input[name="units"]');

        if (ingredientSelect) {
          ingredientSelect.setAttribute("required", "required");
          ingredientSelect.addEventListener("change", function () {
            loadIngredientUnit(this);
          });
        }

        if (quantityInput) {
          quantityInput.setAttribute("required", "required");
        }

        if (unitInput) {
          unitInput.setAttribute("required", "required");
        }

        // Agregar al contenedor
        container.appendChild(newRow);
      }

      function removeIngredientRow(button) {
        const row = button.closest(".ingredient-row");
        const container = document.getElementById("ingredientsContainer");
        const noMessage = document.getElementById("noIngredientsMessage");

        row.remove();

        // Mostrar mensaje si no quedan ingredientes
        const remainingRows = container.querySelectorAll(
          ".ingredient-row:not(#ingredientTemplate)"
        );
        if (remainingRows.length === 0 && noMessage) {
          noMessage.style.display = "block";
        }
      }

      // ========== Inicialización ==========
      window.addEventListener("DOMContentLoaded", function () {
        const categorySelect = document.getElementById("categorySelect");
        const container = document.getElementById("ingredientsContainer");
        const noMessage = document.getElementById("noIngredientsMessage");
        const existingRows = container.querySelectorAll(
          ".ingredient-row:not(#ingredientTemplate)"
        );

        // Cargar presentaciones si ya hay categoría seleccionada (en edición)
        if (categorySelect.value) {
          categorySelect.dispatchEvent(new Event("change"));
        }

        // Agregar eventos a filas existentes (modo edición)
        existingRows.forEach((row) => {
          const ingredientSelect = row.querySelector(
            'select[name="ingredientIds"]'
          );
          if (ingredientSelect) {
            ingredientSelect.addEventListener("change", function () {
              loadIngredientUnit(this);
            });
          }
        });

        // Si no hay ingredientes existentes (modo crear), agregar una fila por defecto
        if (existingRows.length === 0) {
          addIngredientRow();
        } else {
          // Ocultar mensaje si hay ingredientes
          if (noMessage) {
            noMessage.style.display = "none";
          }
        }
      });

      // ========== Validación antes de enviar ==========
      document.querySelector("form").addEventListener("submit", function (e) {
        const container = document.getElementById("ingredientsContainer");
        const ingredientRows = container.querySelectorAll(
          ".ingredient-row:not(#ingredientTemplate)"
        );

        if (ingredientRows.length === 0) {
          e.preventDefault();
          alert("Debe agregar al menos un ingrediente a la receta");
          return false;
        }
      });

      // Auto-hide alerts
      document.addEventListener("DOMContentLoaded", function () {
        const alerts = document.querySelectorAll(".bg-green-100, .bg-red-100");

        alerts.forEach((alert) => {
          setTimeout(() => {
            alert.style.transition =
              "opacity 0.5s ease-out, transform 0.5s ease-out";
            alert.style.opacity = "0";
            alert.style.transform = "translateY(-20px)";
            setTimeout(() => {
              alert.remove();
            }, 500);
          }, 3000);
        });
      });
    </script>

    <!-- Script del Sistema de Temas -->
    <div th:replace="~{fragments/theme :: themeScript}"></div>
  </body>
</html>
