<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Gran Saz√≥n - Mis Pedidos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700"
      rel="stylesheet"
    />

    <!-- Sistema de Temas (Modo Claro/Oscuro) -->
    <div th:replace="~{fragments/theme :: themeResources}"></div>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#38e07b",
              "primary-dark": "#2bc866",
              "background-light": "#f8faf9",
              "background-dark": "#0f1713",
            },
            fontFamily: {
              display: ["Work Sans"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              xl: "1rem",
              "2xl": "1.5rem",
              full: "9999px",
            },
          },
        },
      };
    </script>

    <style>
      .table-responsive {
        overflow-x: auto;
        max-width: 100%;
      }

      .table-responsive::-webkit-scrollbar {
        height: 8px;
      }

      .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      .table-responsive::-webkit-scrollbar-thumb {
        background: #38e07b;
        border-radius: 10px;
      }

      .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #2bc866;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-background-light to-gray-50 dark:from-background-dark dark:to-gray-900 font-display text-gray-800 dark:text-gray-200"
  >
    <div class="min-h-screen">
      <!-- MAIN CONTENT -->
      <main class="w-full">
        <div class="p-4 sm:p-6 lg:p-8">
          <!-- HEADER -->
          <div
            class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 sm:mb-8"
          >
            <div class="flex items-center gap-3">
              <a
                th:href="@{/waiter/dashboard}"
                class="flex h-10 w-10 sm:h-11 sm:w-11 shrink-0 items-center justify-center rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700 transition-colors"
              >
                <span class="material-symbols-outlined">arrow_back</span>
              </a>
              <div>
                <h2
                  class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white mb-1"
                >
                  Mis Pedidos
                </h2>
                <p
                  class="text-sm sm:text-base text-gray-600 dark:text-gray-400"
                >
                  Gestiona tus pedidos asignados
                </p>
              </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
              <a
                th:href="@{/{role}/orders/select-table(role=${currentRole})}"
                class="flex items-center justify-center gap-2 px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl bg-gradient-to-r from-primary to-primary-dark text-white font-semibold hover:shadow-lg hover:shadow-primary/30 transition-all shadow-md text-sm sm:text-base"
              >
                <span class="material-symbols-outlined text-2xl">add</span>
                <span>Nuevo Pedido</span>
              </a>
            </div>
          </div>
          <div
            th:if="${successMessage}"
            class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl"
          >
            <p
              class="text-green-800 dark:text-green-300"
              th:text="${successMessage}"
            ></p>
          </div>

          <div
            th:if="${errorMessage}"
            class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl"
          >
            <p
              class="text-red-800 dark:text-red-300"
              th:text="${errorMessage}"
            ></p>
          </div>

          <!-- STATS -->
          <div
            class="mb-6 sm:mb-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 sm:gap-6"
          >
            <!-- Paid Orders -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg"
            >
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-medium text-gray-600 dark:text-gray-400"
                >
                  Pedidos Pagados
                </h3>
                <span class="material-symbols-outlined text-2xl text-blue-500"
                  >payments</span
                >
              </div>
              <p
                class="text-3xl font-bold text-blue-500"
                th:text="${todayCount}"
              >
                0
              </p>
            </div>

            <!-- Today's Revenue -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg"
            >
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-medium text-gray-600 dark:text-gray-400"
                >
                  Ingresos Hoy
                </h3>
                <span class="material-symbols-outlined text-2xl text-primary"
                  >payments</span
                >
              </div>
              <p class="text-3xl font-bold text-primary">
                $<span th:text="${#numbers.formatDecimal(todayRevenue, 1, 2)}"
                  >0.00</span
                >
              </p>
            </div>

            <!-- Pending Orders -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg"
            >
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-medium text-gray-600 dark:text-gray-400"
                >
                  Pendientes
                </h3>
                <span class="material-symbols-outlined text-2xl text-yellow-500"
                  >pending</span
                >
              </div>
              <p
                class="text-3xl font-bold text-yellow-500"
                th:text="${pendingCount}"
              >
                0
              </p>
            </div>

            <!-- In Preparation -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg"
            >
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-medium text-gray-600 dark:text-gray-400"
                >
                  En Preparaci√≥n
                </h3>
                <span class="material-symbols-outlined text-2xl text-orange-500"
                  >restaurant</span
                >
              </div>
              <p
                class="text-3xl font-bold text-orange-500"
                th:text="${inPreparationCount}"
              >
                0
              </p>
            </div>

            <!-- Active Orders -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg"
            >
              <div class="flex items-center justify-between mb-3">
                <h3
                  class="text-sm font-medium text-gray-600 dark:text-gray-400"
                >
                  Activos
                </h3>
                <span class="material-symbols-outlined text-2xl text-purple-500"
                  >task_alt</span
                >
              </div>
              <p
                class="text-3xl font-bold text-purple-500"
                th:text="${activeCount}"
              >
                0
              </p>
            </div>
          </div>

          <!-- FILTERS CARD -->
          <div
            class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 sm:p-6 shadow-lg mb-6"
          >
            <div class="flex items-center gap-2 mb-4">
              <span class="material-symbols-outlined text-primary text-2xl"
                >filter_alt</span
              >
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                Filtros de B√∫squeda
              </h3>
            </div>

            <div
              class="flex flex-col lg:flex-row justify-between items-start lg:items-end gap-4"
            >
              <div
                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 flex-1"
              >
                <!-- Table Filter -->
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Mesa</label
                  >
                  <select
                    id="filterTable"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  >
                    <option value="">Todas las mesas</option>
                    <option
                      th:each="table : ${tables}"
                      th:value="${table.id}"
                      th:text="${'Mesa #' + table.tableNumber}"
                      th:selected="${selectedTableId != null && selectedTableId == table.id}"
                    ></option>
                  </select>
                </div>

                <!-- Status Filter -->
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Estado</label
                  >
                  <select
                    id="filterStatus"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  >
                    <option value="">Todos los estados</option>
                    <option
                      th:each="status : ${statuses}"
                      th:value="${status}"
                      th:text="${status.displayName}"
                      th:selected="${selectedStatus != null && selectedStatus == status}"
                    ></option>
                  </select>
                </div>

                <!-- Order Type Filter -->
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Tipo</label
                  >
                  <select
                    id="filterOrderType"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  >
                    <option value="">Todos los tipos</option>
                    <option
                      th:each="type : ${orderTypes}"
                      th:value="${type}"
                      th:text="${type.displayName}"
                      th:selected="${selectedOrderType != null && selectedOrderType == type}"
                    ></option>
                  </select>
                </div>

                <!-- Date Filter -->
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Fecha</label
                  >
                  <input
                    type="date"
                    id="filterDate"
                    th:value="${selectedDate}"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  />
                </div>
              </div>

              <!-- Filter Actions -->
              <div class="flex gap-2">
                <button
                  onclick="applyFilters()"
                  class="flex items-center gap-2 px-6 py-2.5 rounded-xl bg-gradient-to-r from-primary to-primary-dark text-white font-semibold hover:shadow-lg hover:shadow-primary/30 transition-all"
                >
                  <span class="material-symbols-outlined text-lg">search</span>
                  Filtrar
                </button>
                <button
                  onclick="clearFilters()"
                  class="flex items-center gap-2 px-6 py-2.5 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 transition-all"
                >
                  <span class="material-symbols-outlined text-lg">close</span>
                  Limpiar
                </button>
              </div>
            </div>
          </div>

          <!-- ORDERS TABLE -->
          <div
            class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-lg overflow-hidden"
          >
            <div
              class="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-800"
            >
              <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-primary text-2xl"
                  >receipt_long</span
                >
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                  Lista de Pedidos
                </h3>
              </div>
            </div>

            <div class="table-responsive">
              <table class="w-full text-sm text-left">
                <thead
                  class="text-xs uppercase bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300"
                >
                  <tr>
                    <th class="px-6 py-4 font-semibold">N¬∫ Pedido</th>
                    <th class="px-6 py-4 font-semibold">Fecha/Hora</th>
                    <th class="px-6 py-4 font-semibold">Mesa</th>
                    <th class="px-6 py-4 font-semibold">Tipo</th>
                    <th class="px-6 py-4 font-semibold">Cliente</th>
                    <th class="px-6 py-4 font-semibold">Total</th>
                    <th class="px-6 py-4 font-semibold">Pago</th>
                    <th class="px-6 py-4 font-semibold">Estado</th>
                    <th class="px-6 py-4 font-semibold text-center">
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:if="${orders.empty}">
                    <td
                      colspan="9"
                      class="px-6 py-12 text-center text-gray-500 dark:text-gray-400"
                    >
                      <span
                        class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-700 mb-4 block"
                        >receipt_long</span
                      >
                      <p class="text-lg font-medium">
                        No tienes pedidos registrados
                      </p>
                    </td>
                  </tr>
                  <tr
                    th:each="order : ${orders}"
                    th:data-order-id="${order.idOrder}"
                    class="border-b border-gray-200 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors"
                  >
                    <!-- Order Number -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="flex items-center gap-2">
                        <span
                          class="text-sm font-mono font-semibold text-primary"
                          th:text="${order.orderNumber}"
                        ></span>
                        <!-- New Items Indicator -->
                        <span
                          th:if="${order.hasNewItems()}"
                          class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-bold bg-gradient-to-r from-amber-400 to-orange-500 text-white shadow-md animate-pulse"
                          title="Este pedido tiene items nuevos agregados"
                        >
                          <span class="material-symbols-outlined !text-xs"
                            >fiber_new</span
                          >
                          NUEVOS
                        </span>
                      </div>
                    </td>

                    <!-- Date/Time -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div
                        class="text-sm text-gray-900 dark:text-white"
                        th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy')}"
                      ></div>
                      <div
                        class="text-xs text-gray-500 dark:text-gray-400"
                        th:text="${#temporals.format(order.createdAt, 'HH:mm')}"
                      ></div>
                    </td>

                    <!-- Table -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span
                        th:if="${order.table != null}"
                        class="text-sm text-gray-900 dark:text-white"
                        th:text="${'Mesa #' + order.table.tableNumber}"
                      ></span>
                      <span
                        th:if="${order.table == null}"
                        class="text-sm text-gray-400"
                        >N/A</span
                      >
                    </td>

                    <!-- Order Type -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span
                        class="px-3 py-1 text-xs rounded-full font-medium"
                        th:classappend="${order.orderType.name() == 'DINE_IN'} ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400' : (${order.orderType.name() == 'TAKEOUT'} ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400' : 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400')"
                        th:text="${order.orderType.displayName}"
                      >
                      </span>
                    </td>

                    <!-- Customer -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div
                        class="text-sm text-gray-900 dark:text-white"
                        th:text="${order.customerName}"
                      ></div>
                      <div
                        class="text-xs text-gray-500 dark:text-gray-400"
                        th:text="${order.customerPhone}"
                      ></div>
                    </td>

                    <!-- Total -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="text-sm font-semibold text-primary"
                        >$<span
                          th:text="${#numbers.formatDecimal(order.total, 1, 2)}"
                        ></span
                      ></span>
                    </td>

                    <!-- Payment Method -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span
                        class="px-3 py-1 text-xs rounded-full font-medium"
                        th:classappend="${order.paymentMethod.name() == 'CASH'} ? 'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400' : 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400'"
                        th:text="${order.paymentMethod.displayName}"
                      >
                      </span>
                    </td>

                    <!-- Status -->
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span
                        class="status-badge px-3 py-1 text-xs rounded-full font-medium"
                        th:classappend="${order.status.name() == 'PENDING'} ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400' : 
                                                     (${order.status.name() == 'IN_PREPARATION'} ? 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400' : 
                                                     (${order.status.name() == 'READY'} ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400' :
                                                     (${order.status.name() == 'ON_THE_WAY'} ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400' :
                                                     (${order.status.name() == 'DELIVERED'} ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' :
                                                     (${order.status.name() == 'PAID'} ? 'bg-primary/20 text-primary' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400')))))"
                        th:text="${order.status.displayName}"
                      >
                      </span>
                    </td>

                    <!-- Actions -->
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                      <div class="flex items-center justify-center gap-2">
                        <!-- View -->
                        <a
                          th:href="@{/{role}/orders/view/{id}(role=${currentRole},id=${order.idOrder})}"
                          class="p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-all"
                          title="Ver detalles"
                        >
                          <i class="fas fa-eye"></i>
                        </a>

                        <!-- Add Items (only for DINE_IN and TAKEOUT orders that can accept new items) -->
                        <a
                          th:if="${order.canAcceptNewItems()}"
                          th:href="@{/{role}/orders/{id}/add-items(role=${currentRole},id=${order.idOrder})}"
                          class="p-2 rounded-lg bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-all"
                          title="Agregar items al pedido"
                        >
                          <i class="fas fa-plus-circle"></i>
                        </a>

                        <!-- Edit (disabled for PAID and CANCELLED) -->
                        <a
                          th:if="${order.status.name() != 'PAID' && order.status.name() != 'CANCELLED'}"
                          th:href="@{/{role}/orders/edit/{id}(role=${currentRole},id=${order.idOrder})}"
                          class="p-2 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400 hover:bg-yellow-100 dark:hover:bg-yellow-900/40 transition-all"
                          title="Editar"
                        >
                          <i class="fas fa-edit"></i>
                        </a>

                        <!-- Change Status (not CANCELLED or PAID) -->
                        <button
                          th:if="${order.status.name() != 'CANCELLED' && order.status.name() != 'PAID'}"
                          class="btn-change-status p-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary hover:bg-primary/20 dark:hover:bg-primary/30 transition-all"
                          th:data-order-id="${order.idOrder}"
                          th:data-order-number="${order.orderNumber}"
                          th:data-order-status="${order.status.name()}"
                          th:data-payment-method="${order.paymentMethod.name()}"
                          title="Cambiar estado"
                        >
                          <i class="fas fa-exchange-alt"></i>
                        </button>

                        <!-- Pay (only DELIVERED and NON-CASH) -->
                        <a
                          th:if="${order.status.name() == 'DELIVERED' && order.paymentMethod.name() != 'CASH'}"
                          th:href="@{/waiter/payments/form/{id}(id=${order.idOrder})}"
                          class="p-2 rounded-lg bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900/40 transition-all"
                          title="Procesar Pago"
                        >
                          <i class="fas fa-dollar-sign"></i>
                        </a>

                        <!-- Cash Payment - Disabled (show message) -->
                        <button
                          th:if="${order.status.name() == 'DELIVERED' && order.paymentMethod.name() == 'CASH'}"
                          class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-400 dark:text-gray-600 cursor-not-allowed"
                          disabled
                          title="Los pagos en efectivo solo pueden ser procesados por el cajero"
                        >
                          <i class="fas fa-ban"></i>
                        </button>

                        <!-- Cancel (only PENDING status) -->
                        <button
                          th:if="${order.status == T(com.aatechsolutions.elgransazon.domain.entity.OrderStatus).PENDING}"
                          class="btn-cancel-order p-2 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/40 transition-all"
                          th:data-order-id="${order.idOrder}"
                          th:data-order-number="${order.orderNumber}"
                          title="Cancelar pedido"
                        >
                          <i class="fas fa-times-circle"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      const currentRole = /*[[${currentRole}]]*/ "waiter";
      /*]]>*/

      // Filter functions
      function applyFilters() {
        const tableId = document.getElementById("filterTable").value;
        const status = document.getElementById("filterStatus").value;
        const orderType = document.getElementById("filterOrderType").value;
        const date = document.getElementById("filterDate").value;

        let url = `/${currentRole}/orders?`;
        if (tableId) url += `tableId=${tableId}&`;
        if (status) url += `status=${status}&`;
        if (orderType) url += `orderType=${orderType}&`;
        if (date) url += `date=${date}&`;

        window.location.href = url;
      }

      function clearFilters() {
        window.location.href = `/${currentRole}/orders`;
      }

      // Cancel order with AJAX
      function confirmCancel(orderId, orderNumber) {
        Swal.fire({
          title: "¬øCancelar pedido?",
          html:
            `<p>¬øEst√°s seguro de que deseas cancelar el pedido <strong>${orderNumber}</strong>?</p>` +
            `<p class="text-sm text-gray-600 dark:text-gray-400 mt-3">` +
            `El sistema analizar√° cada item y devolver√° el stock seg√∫n corresponda.` +
            `</p>`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#38e07b",
          cancelButtonColor: "#ef4444",
          confirmButtonText: "S√≠, cancelar",
          cancelButtonText: "No",
          reverseButtons: true,
          showLoaderOnConfirm: true,
          customClass: {
            popup: "rounded-2xl",
            confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
            cancelButton: "rounded-xl px-6 py-2.5 font-semibold",
          },
          preConfirm: () => {
            return fetch(`/${currentRole}/orders/${orderId}/cancel`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (!data.success) {
                  throw new Error(data.message);
                }
                return data;
              })
              .catch((error) => {
                Swal.showValidationMessage(`Error: ${error.message}`);
              });
          },
          allowOutsideClick: () => !Swal.isLoading(),
        }).then((result) => {
          if (result.isConfirmed && result.value) {
            let message = result.value.message;

            // Add stock info if available
            if (result.value.stockInfo) {
              message += `<br><br><p class="text-sm mt-2">${result.value.stockInfo}</p>`;
            }

            if (result.value.warning) {
              message +=
                '<br><br><strong class="text-orange-600">‚ö†Ô∏è ' +
                result.value.warning +
                "</strong>";
            }

            Swal.fire({
              icon: "success",
              title: "¬°Pedido Cancelado!",
              html: message,
              confirmButtonColor: "#38e07b",
              confirmButtonText: "Aceptar",
              customClass: {
                popup: "rounded-2xl",
                confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
              },
            }).then(() => {
              window.location.reload();
            });
          }
        });
      }

      // Change status modal with AJAX
      function showStatusModal(
        orderId,
        orderNumber,
        currentStatus,
        paymentMethod
      ) {
        // First, get valid statuses from backend
        fetch(`/${currentRole}/orders/${orderId}/valid-statuses`)
          .then((response) => response.json())
          .then((data) => {
            if (!data.success || data.validStatuses.length === 0) {
              Swal.fire({
                icon: "info",
                title: "Informaci√≥n",
                text: "No hay cambios de estado disponibles para este pedido",
                confirmButtonColor: "#38e07b",
                customClass: {
                  popup: "rounded-2xl",
                  confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
                },
              });
              return;
            }

            // Build options HTML
            let optionsHtml =
              '<option value="">Seleccionar nuevo estado</option>';
            data.validStatuses.forEach((status) => {
              optionsHtml += `<option value="${status.value}">${status.label}</option>`;
            });

            // Add warning for CASH payments if PAID status is not available
            let warningHtml = "";
            if (paymentMethod === "CASH" && !data.canMarkAsPaid) {
              warningHtml =
                '<div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800"><i class="fas fa-exclamation-triangle mr-2"></i>Los pagos en efectivo solo pueden ser procesados por el cajero</div>';
            }

            // Show modal
            Swal.fire({
              title: "Cambiar Estado del Pedido",
              html: `
                <div class="text-left mb-4">
                    <p class="mb-2 text-gray-700">Pedido: <strong class="text-primary">${orderNumber}</strong></p>
                    <p class="mb-2 text-gray-700">Tipo: <strong>${
                      data.orderType === "DELIVERY"
                        ? "Entrega a Domicilio"
                        : data.orderType === "TAKEOUT"
                        ? "Para Llevar"
                        : "Para Comer Aqu√≠"
                    }</strong></p>
                    <p class="mb-4 text-gray-700">Estado Actual: <span class="px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${
                      data.currentStatusLabel
                    }</span></p>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nuevo Estado:</label>
                    <select id="newStatus" class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-primary">
                        ${optionsHtml}
                    </select>
                    ${warningHtml}
                </div>
              `,
              icon: "question",
              showCancelButton: true,
              confirmButtonColor: "#38e07b",
              cancelButtonColor: "#6b7280",
              confirmButtonText: "Cambiar Estado",
              cancelButtonText: "Cancelar",
              reverseButtons: true,
              showLoaderOnConfirm: true,
              customClass: {
                popup: "rounded-2xl",
                confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
                cancelButton: "rounded-xl px-6 py-2.5 font-semibold",
              },
              preConfirm: () => {
                const newStatus = document.getElementById("newStatus").value;
                if (!newStatus) {
                  Swal.showValidationMessage("Debes seleccionar un estado");
                  return false;
                }

                return fetch(
                  `/${currentRole}/orders/${orderId}/change-status?newStatus=${newStatus}`,
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/x-www-form-urlencoded",
                    },
                  }
                )
                  .then((response) => response.json())
                  .then((data) => {
                    if (!data.success) {
                      throw new Error(data.message);
                    }
                    return data;
                  })
                  .catch((error) => {
                    Swal.showValidationMessage(`Error: ${error.message}`);
                  });
              },
              allowOutsideClick: () => !Swal.isLoading(),
            }).then((result) => {
              if (result.isConfirmed && result.value) {
                Swal.fire({
                  icon: "success",
                  title: "¬°Estado Actualizado!",
                  text: result.value.message,
                  timer: 2000,
                  showConfirmButton: false,
                  customClass: {
                    popup: "rounded-2xl",
                  },
                });

                setTimeout(() => {
                  window.location.reload();
                }, 2100);
              }
            });
          })
          .catch((error) => {
            Swal.fire({
              icon: "error",
              title: "Error",
              text:
                "No se pudieron cargar los estados disponibles: " +
                error.message,
              confirmButtonColor: "#38e07b",
              customClass: {
                popup: "rounded-2xl",
                confirmButton: "rounded-xl px-6 py-2.5 font-semibold",
              },
            });
          });
      }

      // Event listeners for action buttons
      document.addEventListener("DOMContentLoaded", function () {
        // Cancel order buttons
        document.querySelectorAll(".btn-cancel-order").forEach((button) => {
          button.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            const orderNumber = this.getAttribute("data-order-number");
            confirmCancel(orderId, orderNumber);
          });
        });

        // Change status buttons
        document.querySelectorAll(".btn-change-status").forEach((button) => {
          button.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            const orderNumber = this.getAttribute("data-order-number");
            const orderStatus = this.getAttribute("data-order-status");
            const paymentMethod = this.getAttribute("data-payment-method");
            showStatusModal(orderId, orderNumber, orderStatus, paymentMethod);
          });
        });
      });

      // Format currency
      function formatCurrency(amount) {
        return new Intl.NumberFormat("es-CO", {
          style: "currency",
          currency: "COP",
          minimumFractionDigits: 0,
        }).format(amount);
      }
    </script>

    <!-- WebSocket for Real-time Updates -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
      let stompClient = null;
      let statsUpdateTimeout = null;
      let pendingStatsUpdate = false;
      const STATS_UPDATE_DELAY = 2000; // 2 seconds

      // Reconnection control
      let reconnectAttempts = 0;
      let maxReconnectAttempts = 10;
      let reconnectDelay = 1000; // Start with 1 second
      let maxReconnectDelay = 30000; // Max 30 seconds
      let isIntentionalDisconnect = false;

      function connectWaiterOrdersWebSocket() {
        if (reconnectAttempts >= maxReconnectAttempts) {
          console.warn(
            "‚õî WAITER: M√°ximo de intentos de reconexi√≥n alcanzado. Deteniendo..."
          );
          return;
        }

        console.log(`üîÑ WAITER: Intento de conexi√≥n #${reconnectAttempts + 1}`);
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect(
          {},
          function (frame) {
            console.log("‚úÖ WAITER: WebSocket Conectado Exitosamente");
            console.log("üì° WAITER: Frame de conexi√≥n:", frame);

            stompClient.subscribe(
              "/topic/admin/kitchen",
              function (notification) {
                console.log(
                  "üîî WAITER: Notificaci√≥n RAW recibida:",
                  notification
                );
                const message = JSON.parse(notification.body);
                console.log("üì¶ WAITER: Mensaje parseado:", message);
                console.log("üÜî WAITER: Order ID:", message.orderId);
                console.log("üìä WAITER: Tipo:", message.type);
                console.log("üè∑Ô∏è WAITER: Nuevo Estado:", message.newStatus);
                handleOrderUpdate(message);
              }
            );
            console.log("üëÇ WAITER: Suscrito a /topic/admin/kitchen");
          },
          function (error) {
            console.error("‚ùå WAITER: Error de WebSocket:", error);
            setTimeout(connectWaiterOrdersWebSocket, 5000);
          }
        );
      }

      function handleOrderUpdate(notification) {
        console.log(
          "üîß WAITER: Iniciando handleOrderUpdate con:",
          notification
        );
        const orderId = notification.orderId;
        const newStatus = notification.status || notification.newStatus; // FIX: el mensaje usa 'status', no 'newStatus'

        console.log("üîç WAITER: Buscando fila con data-order-id:", orderId);
        console.log("üéØ WAITER: Estado extra√≠do:", newStatus);

        // Update specific order row badge immediately
        const orderRow = document.querySelector(
          `tr[data-order-id="${orderId}"]`
        );
        console.log("üéØ WAITER: Fila encontrada:", orderRow);

        if (orderRow && newStatus) {
          const badge = orderRow.querySelector(".status-badge");
          console.log("üè∑Ô∏è WAITER: Badge encontrado:", badge);
          console.log(
            "üîÑ WAITER: Badge actual className:",
            badge ? badge.className : "N/A"
          );
          console.log(
            "üìù WAITER: Badge actual text:",
            badge ? badge.textContent : "N/A"
          );

          if (badge) {
            console.log("‚ö° WAITER: Actualizando badge a estado:", newStatus);
            updateStatusBadge(badge, newStatus);
            console.log(
              "‚úÖ WAITER: Badge actualizado - Nueva className:",
              badge.className
            );
            console.log(
              "‚úÖ WAITER: Badge actualizado - Nuevo text:",
              badge.textContent
            );

            // Flash animation
            orderRow.classList.add("bg-primary/5");
            console.log("üí´ WAITER: Animaci√≥n flash iniciada");
            setTimeout(() => {
              orderRow.classList.remove("bg-primary/5");
              console.log("üí´ WAITER: Animaci√≥n flash completada");
            }, 1500);
          } else {
            console.warn("‚ö†Ô∏è WAITER: No se encontr√≥ badge en la fila");
          }
        } else {
          if (!orderRow) {
            console.warn(
              "‚ö†Ô∏è WAITER: No se encontr√≥ fila para Order ID:",
              orderId
            );
            console.log("üìã WAITER: Todas las filas en la tabla:");
            document.querySelectorAll("tr[data-order-id]").forEach((row) => {
              console.log("  - Row ID:", row.getAttribute("data-order-id"));
            });
          }
          if (!newStatus) {
            console.warn("‚ö†Ô∏è WAITER: newStatus es null o undefined");
          }
        }

        // Debounce stats update
        console.log(
          "üìä WAITER: Programando actualizaci√≥n de estad√≠sticas (debounce 2s)"
        );
        if (statsUpdateTimeout) {
          clearTimeout(statsUpdateTimeout);
          console.log("‚è±Ô∏è WAITER: Timeout anterior cancelado");
        }

        pendingStatsUpdate = true;

        statsUpdateTimeout = setTimeout(() => {
          if (pendingStatsUpdate) {
            console.log("üìà WAITER: Ejecutando actualizaci√≥n de estad√≠sticas");
            pendingStatsUpdate = false;
            updateOrderStatsFromServer();
          }
        }, STATS_UPDATE_DELAY);
      }

      function updateStatusBadge(badge, status) {
        console.log("üé® WAITER: updateStatusBadge llamado con estado:", status);
        console.log(
          "üé® WAITER: Badge antes:",
          badge.className,
          "|",
          badge.textContent
        );

        // Remove all previous classes and set base classes
        badge.className =
          "status-badge px-3 py-1 text-xs rounded-full font-medium";

        // Add new status-specific classes and text
        switch (status) {
          case "PENDING":
            badge.className +=
              " bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400";
            badge.textContent = "Pendiente";
            console.log("üü° WAITER: Estado actualizado a PENDING");
            break;
          case "IN_PREPARATION":
            badge.className +=
              " bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400";
            badge.textContent = "En Preparaci√≥n";
            console.log("üü† WAITER: Estado actualizado a IN_PREPARATION");
            break;
          case "READY":
            badge.className +=
              " bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400";
            badge.textContent = "Listo";
            console.log("üîµ WAITER: Estado actualizado a READY");
            break;
          case "ON_THE_WAY":
            badge.className +=
              " bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400";
            badge.textContent = "En Camino";
            console.log("üü£ WAITER: Estado actualizado a ON_THE_WAY");
            break;
          case "DELIVERED":
            badge.className +=
              " bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400";
            badge.textContent = "Entregado";
            console.log("üü¢ WAITER: Estado actualizado a DELIVERED");
            break;
          case "PAID":
            badge.className += " bg-primary/20 text-primary";
            badge.textContent = "Pagado";
            console.log("üíö WAITER: Estado actualizado a PAID");

            // Play payment success sound
            playPaymentSound();
            console.log("üîä WAITER: Reproduciendo sonido de pago exitoso");
            break;
          case "CANCELLED":
            badge.className +=
              " bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400";
            badge.textContent = "Cancelado";
            console.log("üî¥ WAITER: Estado actualizado a CANCELLED");
            break;
          default:
            console.warn("‚ö†Ô∏è WAITER: Estado desconocido:", status);
        }

        console.log(
          "üé® WAITER: Badge despu√©s:",
          badge.className,
          "|",
          badge.textContent
        );
      }

      function updateOrderStatsFromServer() {
        console.log("üåê WAITER: Fetching stats desde /waiter/orders/stats");
        fetch("/waiter/orders/stats")
          .then((response) => {
            console.log("üì° WAITER: Response recibido:", response.status);
            return response.json();
          })
          .then((data) => {
            console.log("üìä WAITER: Stats data:", data);
            updateOrderStats(data);
          })
          .catch((error) => {
            console.error("‚ùå WAITER: Error fetching stats:", error);
          });
      }

      function updateOrderStats(stats) {
        console.log("üìà WAITER: Actualizando estad√≠sticas con:", stats);
        let updatedCount = 0;

        // Update stats cards - using exact class selectors matching the HTML structure
        const todayCountEl = document.querySelector(
          ".text-3xl.font-bold.text-blue-500"
        );
        console.log("üîç WAITER: todayCountEl:", todayCountEl);
        if (todayCountEl && stats.todayCount != null) {
          console.log("üìù WAITER: Actualizando todayCount:", stats.todayCount);
          todayCountEl.textContent = stats.todayCount;
          updatedCount++;
        }

        const todayRevenueSpan = document.querySelector(
          ".text-3xl.font-bold.text-primary span"
        );
        console.log("üîç WAITER: todayRevenueSpan:", todayRevenueSpan);
        if (todayRevenueSpan && stats.todayRevenue != null) {
          console.log(
            "üí∞ WAITER: Actualizando todayRevenue:",
            stats.todayRevenue
          );
          todayRevenueSpan.textContent = stats.todayRevenue.toFixed(2);
          updatedCount++;
        }

        const pendingCountEl = document.querySelector(
          ".text-3xl.font-bold.text-yellow-500"
        );
        console.log("üîç WAITER: pendingCountEl:", pendingCountEl);
        if (pendingCountEl && stats.pendingCount != null) {
          console.log(
            "üü° WAITER: Actualizando pendingCount:",
            stats.pendingCount
          );
          pendingCountEl.textContent = stats.pendingCount;
          updatedCount++;
        }

        const inPreparationCountEl = document.querySelector(
          ".text-3xl.font-bold.text-orange-500"
        );
        console.log("üîç WAITER: inPreparationCountEl:", inPreparationCountEl);
        if (inPreparationCountEl && stats.inPreparationCount != null) {
          console.log(
            "üü† WAITER: Actualizando inPreparationCount:",
            stats.inPreparationCount
          );
          inPreparationCountEl.textContent = stats.inPreparationCount;
          updatedCount++;
        }

        const activeCountEl = document.querySelector(
          ".text-3xl.font-bold.text-purple-500"
        );
        console.log("üîç WAITER: activeCountEl:", activeCountEl);
        if (activeCountEl && stats.activeCount != null) {
          console.log(
            "üü£ WAITER: Actualizando activeCount:",
            stats.activeCount
          );
          activeCountEl.textContent = stats.activeCount;
          updatedCount++;
        }

        console.log(
          "‚úÖ WAITER: Stats actualizadas -",
          updatedCount,
          "campos cambiados"
        );
      }

      // Connect on page load
      window.addEventListener("DOMContentLoaded", connectWaiterOrdersWebSocket);

      // Cleanup on page unload
      window.addEventListener("beforeunload", function () {
        console.log("üëã WAITER: P√°gina cerr√°ndose, desconectando WebSocket...");
        isIntentionalDisconnect = true;

        if (statsUpdateTimeout) {
          clearTimeout(statsUpdateTimeout);
        }
        if (stompClient && stompClient.connected) {
          stompClient.disconnect();
        }
      });

      // Function to play payment success sound
      function playPaymentSound() {
        try {
          const audio = new Audio("/sounds/payment.mp3");
          audio.volume = 0.6;

          console.log("üîä Attempting to play payment sound...");

          audio
            .play()
            .then(() => {
              console.log("‚úÖ Payment sound played successfully");
            })
            .catch((error) => {
              console.warn(
                "‚ö†Ô∏è Payment sound playback prevented:",
                error.message
              );
            });

          audio.onerror = function (e) {
            console.error("‚ùå Payment audio file not found:", e);
            console.log("üìÅ Make sure payment.mp3 exists in /static/sounds/");
          };
        } catch (e) {
          console.error("‚ùå Error creating payment audio:", e);
        }
      }
    </script>

    <!-- Script del Sistema de Temas -->
    <div th:replace="~{fragments/theme :: themeScript}"></div>
  </body>
</html>
