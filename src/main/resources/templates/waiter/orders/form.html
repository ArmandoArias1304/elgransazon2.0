<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title
      th:text="${order.idOrder != null ? 'Editar Pedido' : 'Nuevo Pedido'}"
    >
      Pedido
    </title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700"
      rel="stylesheet"
    />

    <!-- Sistema de Temas (Modo Claro/Oscuro) -->
    <div th:replace="~{fragments/theme :: themeResources}"></div>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#38e07b",
              "primary-dark": "#2bc866",
              "background-light": "#f8faf9",
              "background-dark": "#0f1713",
            },
            fontFamily: {
              display: ["Work Sans"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              xl: "1rem",
              "2xl": "1.5rem",
              full: "9999px",
            },
          },
        },
      };
    </script>

    <style>
      /* Animaciones suaves */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fadeIn {
        animation: fadeIn 0.4s ease-out;
      }

      /* Estilos personalizados para inputs */
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #38e07b;
        box-shadow: 0 0 0 3px rgba(56, 224, 123, 0.1);
      }

      /* Transiciones suaves */
      * {
        transition-property: background-color, border-color, color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-background-light to-gray-50 dark:from-background-dark dark:to-gray-900 font-display text-gray-800 dark:text-gray-200"
  >
    <div class="container mx-auto px-4 py-6 sm:py-8 max-w-7xl">
      <!-- HEADER -->
      <div class="mb-6 sm:mb-8">
        <a
          th:href="@{/waiter/orders}"
          class="inline-flex items-center gap-2 text-primary hover:text-primary-dark font-semibold mb-4 transition-colors"
        >
          <span class="material-symbols-outlined">arrow_back</span>
          Volver a Pedidos
        </a>
        <div
          class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
        >
          <div>
            <h1
              class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white mb-1"
              th:text="${order.idOrder != null ? 'Editar Pedido' : 'Nuevo Pedido'}"
            ></h1>
            <p class="text-sm sm:text-base text-gray-600 dark:text-gray-400">
              Complete la información del pedido
            </p>
          </div>
        </div>
      </div>

      <!-- Error Messages -->
      <div
        th:if="${errorMessage}"
        class="mb-6 rounded-2xl border border-red-300 dark:border-red-800 bg-red-50 dark:bg-red-900/20 p-4 animate-fadeIn"
      >
        <div class="flex items-center gap-3">
          <span class="material-symbols-outlined text-red-600 dark:text-red-400"
            >error</span
          >
          <span
            class="text-red-800 dark:text-red-300 font-medium"
            th:text="${errorMessage}"
          ></span>
        </div>
      </div>

      <!-- Form -->
      <form th:action="${formAction}" method="post" id="orderForm">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Left Column: Order Info -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Order Type & Table -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-lg animate-fadeIn"
            >
              <div class="flex items-center gap-2 mb-4">
                <span
                  class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-2xl"
                  >info</span
                >
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                  Información del Pedido
                </h3>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Order Type -->
                <div>
                  <label
                    class="block text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-2"
                  >
                    Tipo de Pedido <span class="text-red-500">*</span>
                  </label>
                  <select
                    name="orderType"
                    id="orderType"
                    required
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-xl focus:ring-2 focus:ring-primary transition-all"
                  >
                    <option
                      th:each="type : ${orderTypes}"
                      th:value="${type}"
                      th:text="${type.displayName}"
                      th:selected="${order.orderType == type}"
                    ></option>
                  </select>
                </div>

                <!-- Table (only for DINE_IN) -->
                <div id="tableSection">
                  <label
                    class="block text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-2"
                  >
                    Mesa <span class="text-red-500">*</span>
                  </label>
                  <select
                    name="tableId"
                    id="tableId"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-xl focus:ring-2 focus:ring-primary transition-all"
                  >
                    <option value="">Seleccionar mesa</option>
                    <option
                      th:each="table : ${availableTables}"
                      th:value="${table.id}"
                      th:text="${'Mesa #' + table.tableNumber + ' (' + table.capacity + ' personas)'}"
                      th:selected="${order.table != null && order.table.id == table.id}"
                    ></option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Customer Info -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-lg animate-fadeIn"
              style="animation-delay: 0.1s"
            >
              <div class="flex items-center gap-2 mb-4">
                <span class="material-symbols-outlined text-primary text-2xl"
                  >person</span
                >
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                  Información del Cliente
                </h3>
              </div>

              <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <!-- Customer Name -->
                  <div>
                    <label
                      class="block text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-2"
                    >
                      Nombre
                      <span class="text-red-500" id="nameRequired">*</span>
                    </label>
                    <input
                      type="text"
                      name="customerName"
                      id="customerName"
                      th:value="${order.customerName}"
                      class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-xl focus:ring-2 focus:ring-primary transition-all"
                      placeholder="Nombre del cliente"
                    />
                  </div>

                  <!-- Customer Phone -->
                  <div>
                    <label
                      class="block text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-2"
                    >
                      Teléfono
                      <span class="text-red-500" id="phoneRequired">*</span>
                    </label>
                    <input
                      type="tel"
                      name="customerPhone"
                      id="customerPhone"
                      th:value="${order.customerPhone}"
                      class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-xl focus:ring-2 focus:ring-primary transition-all"
                      placeholder="Teléfono"
                    />
                  </div>
                </div>

                <!-- Delivery Address -->
                <div id="deliverySection">
                  <label
                    class="block text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-2"
                  >
                    Dirección de Entrega <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    name="deliveryAddress"
                    th:value="${order.deliveryAddress}"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-xl focus:ring-2 focus:ring-primary transition-all"
                    placeholder="Dirección completa"
                  />
                </div>

                <!-- Delivery References -->
                <div id="referencesSection">
                  <label
                    class="block text-xs uppercase text-gray-500 dark:text-gray-400 font-medium mb-2"
                  >
                    Referencias
                  </label>
                  <textarea
                    name="deliveryReferences"
                    th:text="${order.deliveryReferences}"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-xl focus:ring-2 focus:ring-primary transition-all"
                    rows="2"
                    placeholder="Referencias adicionales"
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- Order Items -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-lg animate-fadeIn"
              style="animation-delay: 0.2s"
            >
              <div class="flex items-center gap-2 mb-4">
                <span
                  class="material-symbols-outlined text-orange-600 dark:text-orange-400 text-2xl"
                  >restaurant_menu</span
                >
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                  Items del Pedido
                </h3>
              </div>

              <div id="itemsContainer" class="space-y-3">
                <!-- Items will be added here dynamically -->
              </div>

              <!-- Add Item Button (only for new orders) -->
              <button
                type="button"
                onclick="addItem()"
                id="addItemButton"
                th:if="${order.idOrder == null}"
                class="mt-4 w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-gradient-to-r from-primary to-primary-dark text-white font-semibold hover:shadow-lg hover:shadow-primary/30 transition-all"
              >
                <span class="material-symbols-outlined">add_circle</span>
                Agregar Item
              </button>

              <!-- Info message for editing -->
              <div
                th:if="${order.idOrder != null}"
                class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl"
              >
                <div
                  class="flex items-center gap-2 text-blue-800 dark:text-blue-300 text-sm"
                >
                  <span class="material-symbols-outlined text-lg">info</span>
                  <span
                    >Los items no pueden ser modificados al editar. Use "Agregar
                    Items al Pedido" en la vista del pedido para agregar más
                    items.</span
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column: Summary & Payment -->
          <div class="space-y-6">
            <!-- Payment Method -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-lg animate-fadeIn"
              style="animation-delay: 0.15s"
            >
              <div class="flex items-center gap-2 mb-4">
                <span
                  class="material-symbols-outlined text-purple-600 dark:text-purple-400 text-2xl"
                  >payments</span
                >
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                  Método de Pago
                </h3>
              </div>

              <select
                name="paymentMethod"
                required
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-xl focus:ring-2 focus:ring-primary transition-all"
              >
                <option
                  th:each="method : ${paymentMethods}"
                  th:value="${method}"
                  th:text="${method.displayName}"
                  th:selected="${order.paymentMethod == method}"
                ></option>
              </select>
            </div>

            <!-- Order Summary -->
            <div
              class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-lg sticky top-4 animate-fadeIn"
              style="animation-delay: 0.25s"
            >
              <div class="flex items-center gap-2 mb-4">
                <span
                  class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-2xl"
                  >receipt_long</span
                >
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                  Resumen del Pedido
                </h3>
              </div>

              <div class="space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-600 dark:text-gray-400"
                    >Subtotal:</span
                  >
                  <span
                    class="font-semibold text-gray-900 dark:text-white"
                    id="subtotalDisplay"
                    >$0.00</span
                  >
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-600 dark:text-gray-400">
                    Impuesto (<span th:text="${taxRate}">0</span>%):
                  </span>
                  <span
                    class="font-semibold text-gray-900 dark:text-white"
                    id="taxDisplay"
                    >$0.00</span
                  >
                </div>
                <div
                  class="border-t border-gray-200 dark:border-gray-700 pt-3 flex justify-between items-center"
                >
                  <span class="font-bold text-lg text-gray-900 dark:text-white"
                    >Total:</span
                  >
                  <span
                    class="font-bold text-2xl text-primary"
                    id="totalDisplay"
                    >$0.00</span
                  >
                </div>
              </div>

              <div class="mt-6 space-y-3">
                <button
                  type="submit"
                  class="flex items-center justify-center gap-2 w-full px-6 py-3 rounded-xl bg-gradient-to-r from-primary to-primary-dark text-white font-semibold hover:shadow-lg hover:shadow-primary/30 transition-all shadow-md"
                >
                  <span class="material-symbols-outlined">save</span>
                  <span
                    th:text="${order.idOrder != null ? 'Actualizar Pedido' : 'Crear Pedido'}"
                  ></span>
                </button>
                <a
                  th:href="@{/waiter/orders}"
                  class="flex items-center justify-center gap-2 w-full px-6 py-3 rounded-xl bg-gray-600 dark:bg-gray-700 hover:bg-gray-700 dark:hover:bg-gray-600 text-white font-semibold transition-all shadow-md hover:shadow-lg"
                >
                  <span class="material-symbols-outlined">close</span>
                  Cancelar
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Hidden fields -->
        <input
          type="hidden"
          name="employeeId"
          th:value="${employee != null ? employee.idEmpleado : ''}"
        />
      </form>
    </div>

    <!-- Thymeleaf data injection -->
    <script th:inline="javascript">
      /*<![CDATA[*/
      window.APP_DATA = {
        availableItems: /*[[${availableItems}]]*/ [],
        taxRate: /*[[${taxRate}]]*/ 0,
        orderType: /*[[${order.orderType?.name()}]]*/ "DINE_IN",
        orderDetails: /*[[${orderDetails}]]*/ [],
        isEditMode: /*[[${order.idOrder != null}]]*/ false,
      };
      /*]]>*/
    </script>

    <!-- Application JavaScript -->
    <script>
      // Global variables
      let availableItems = [];
      let taxRate = 0;
      let orderType = "DINE_IN";
      let itemCounter = 0;
      let existingOrderDetails = [];
      let isEditMode = false;

      // Initialize data from backend
      if (window.APP_DATA) {
        const rawItems = window.APP_DATA.availableItems || [];
        availableItems = rawItems.map((item) => ({
          idItemMenu: item.idItemMenu,
          name: item.name,
          price: parseFloat(item.price) || 0,
        }));

        taxRate = parseFloat(window.APP_DATA.taxRate) || 0;
        orderType = window.APP_DATA.orderType || "DINE_IN";
        existingOrderDetails = window.APP_DATA.orderDetails || [];
        isEditMode = window.APP_DATA.isEditMode || false;

        console.log("Available Items:", availableItems.length);
        console.log("Tax Rate:", taxRate);
        console.log("Order Type:", orderType);
        console.log("Existing Order Details:", existingOrderDetails.length);
        console.log("Is Edit Mode:", isEditMode);
      }

      // Initialize form
      document.addEventListener("DOMContentLoaded", function () {
        updateOrderTypeFields();
        document
          .getElementById("orderType")
          .addEventListener("change", updateOrderTypeFields);

        // Load existing order details if editing
        if (existingOrderDetails && existingOrderDetails.length > 0) {
          console.log("Loading existing order details...");
          existingOrderDetails.forEach((detail) => {
            if (detail.itemMenu && detail.itemMenu.idItemMenu) {
              addItem(
                detail.itemMenu.idItemMenu,
                detail.quantity,
                detail.comments || ""
              );
            }
          });
        }

        calculateTotal();
      });

      function updateOrderTypeFields() {
        const type = document.getElementById("orderType").value;
        const tableSection = document.getElementById("tableSection");
        const tableSelect = document.getElementById("tableId");
        const deliverySection = document.getElementById("deliverySection");
        const deliveryInput = deliverySection.querySelector("input");
        const referencesSection = document.getElementById("referencesSection");

        // Customer fields
        const customerName = document.getElementById("customerName");
        const customerPhone = document.getElementById("customerPhone");
        const nameRequired = document.getElementById("nameRequired");
        const phoneRequired = document.getElementById("phoneRequired");

        if (type === "DINE_IN") {
          tableSection.style.display = "block";
          tableSelect.required = true;
          deliverySection.style.display = "none";
          deliveryInput.required = false;
          deliveryInput.value = "";
          referencesSection.style.display = "none";

          customerName.required = false;
          customerPhone.required = false;
          nameRequired.style.display = "none";
          phoneRequired.style.display = "none";
        } else if (type === "DELIVERY") {
          tableSection.style.display = "none";
          tableSelect.required = false;
          tableSelect.value = "";
          deliverySection.style.display = "block";
          deliveryInput.required = true;
          referencesSection.style.display = "block";

          customerName.required = true;
          customerPhone.required = true;
          nameRequired.style.display = "inline";
          phoneRequired.style.display = "inline";
        } else {
          tableSection.style.display = "none";
          tableSelect.required = false;
          tableSelect.value = "";
          deliverySection.style.display = "block";
          deliveryInput.required = false;
          referencesSection.style.display = "none";

          customerName.required = true;
          customerPhone.required = true;
          nameRequired.style.display = "inline";
          phoneRequired.style.display = "inline";
        }
      }

      function addItem(itemId = null, quantity = 1, comments = "") {
        console.log("Adding item...");
        const container = document.getElementById("itemsContainer");
        const index = itemCounter++;

        const itemDiv = document.createElement("div");
        itemDiv.id = `item-${index}`;

        // If in edit mode, create a READ-ONLY display
        if (isEditMode) {
          // Find the item details
          let itemName = "Item";
          let itemPrice = 0;

          const item = availableItems.find((i) => i.idItemMenu == itemId);
          if (item) {
            itemName = item.name;
            itemPrice = item.price;
          }

          const subtotal = itemPrice * quantity;

          itemDiv.className =
            "flex flex-col sm:flex-row gap-3 items-stretch sm:items-start p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700";

          itemDiv.innerHTML = `
            <div class="flex-1 flex items-center gap-3">
              <span class="material-symbols-outlined text-orange-500">restaurant</span>
              <div>
                <p class="font-semibold text-gray-900 dark:text-white">${itemName}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">$${itemPrice.toFixed(
                  2
                )} c/u</p>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-center">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Cantidad</p>
                <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-400 rounded-full font-bold">
                  ${quantity}
                </div>
              </div>
              <div class="text-right">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Subtotal</p>
                <p class="font-bold text-lg text-gray-900 dark:text-white">$${subtotal.toFixed(
                  2
                )}</p>
              </div>
            </div>
            ${
              comments
                ? `
            <div class="w-full sm:col-span-3 flex items-start gap-2 mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
              <span class="material-symbols-outlined text-sm text-gray-400">comment</span>
              <p class="text-sm text-gray-600 dark:text-gray-400 italic">${comments}</p>
            </div>
            `
                : ""
            }
            <!-- Hidden inputs to preserve data -->
            <input type="hidden" name="itemIds" value="${itemId}">
            <input type="hidden" name="quantities" value="${quantity}">
            <input type="hidden" name="comments" value="${comments}">
          `;
        } else {
          // CREATE MODE - Editable item
          itemDiv.className =
            "flex flex-col sm:flex-row gap-3 items-stretch sm:items-start p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition-colors";

          let optionsHtml = '<option value="">Seleccionar item</option>';
          availableItems.forEach((item) => {
            const selected = itemId == item.idItemMenu ? "selected" : "";
            optionsHtml += `<option value="${item.idItemMenu}" data-price="${
              item.price
            }" ${selected}>
                      ${item.name} - $${item.price.toFixed(2)}
                  </option>`;
          });

          itemDiv.innerHTML = `
                  <div class="flex-1">
                      <select name="itemIds" class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg text-sm item-select focus:ring-2 focus:ring-primary transition-all" required onchange="calculateTotal()">
                          ${optionsHtml}
                      </select>
                  </div>
                  <div class="w-full sm:w-28">
                      <input type="number" name="quantities" value="${quantity}" min="1" required
                             class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg text-sm text-center quantity-input focus:ring-2 focus:ring-primary transition-all font-semibold"
                             onchange="calculateTotal()" placeholder="Cant.">
                  </div>
                  <div class="flex-1">
                      <input type="text" name="comments" value="${comments}" 
                             class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-primary transition-all"
                             placeholder="Comentarios">
                  </div>
                  <button type="button" onclick="removeItem(${index})" 
                          class="sm:self-start flex items-center justify-center w-full sm:w-auto px-4 py-2.5 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all">
                      <span class="material-symbols-outlined">delete</span>
                  </button>
              `;
        }

        container.appendChild(itemDiv);
        calculateTotal();
      }

      function removeItem(index) {
        const item = document.getElementById(`item-${index}`);
        if (item) {
          item.remove();
          calculateTotal();
        }
      }

      function calculateTotal() {
        let subtotal = 0;

        if (isEditMode) {
          // In edit mode, calculate from hidden inputs
          const itemIds = document.querySelectorAll('input[name="itemIds"]');
          const quantities = document.querySelectorAll(
            'input[name="quantities"]'
          );

          itemIds.forEach((input, index) => {
            const itemId = input.value;
            const qty = parseInt(quantities[index].value || 0);
            const item = availableItems.find((i) => i.idItemMenu == itemId);
            if (item) {
              subtotal += item.price * qty;
            }
          });
        } else {
          // In create mode, calculate from selects
          const selects = document.querySelectorAll(".item-select");
          const quantities = document.querySelectorAll(".quantity-input");

          selects.forEach((select, index) => {
            if (select.value && quantities[index]) {
              const option = select.options[select.selectedIndex];
              const price = parseFloat(option.dataset.price || 0);
              const qty = parseInt(quantities[index].value || 0);
              subtotal += price * qty;
            }
          });
        }

        const taxAmount = subtotal * (taxRate / 100);
        const total = subtotal + taxAmount;

        document.getElementById("subtotalDisplay").textContent =
          "$" + subtotal.toFixed(2);
        document.getElementById("taxDisplay").textContent =
          "$" + taxAmount.toFixed(2);
        document.getElementById("totalDisplay").textContent =
          "$" + total.toFixed(2);
      }

      // Form validation and submission
      document
        .getElementById("orderForm")
        .addEventListener("submit", function (e) {
          // In edit mode, items are already validated (they exist)
          if (!isEditMode) {
            const items = document.querySelectorAll(".item-select");
            if (items.length === 0) {
              e.preventDefault();
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "Debe agregar al menos un item al pedido",
                confirmButtonColor: "#38e07b",
              });
              return false;
            }
          }

          // Debugging: Log form data
          console.log("=== FORM SUBMISSION DEBUG ===");

          const formData = new FormData(e.target);
          const itemIds = formData.getAll("itemIds");
          const quantities = formData.getAll("quantities");
          const comments = formData.getAll("comments");

          console.log("Is Edit Mode:", isEditMode);
          console.log("Total items:", itemIds.length);
          console.log("Item IDs:", itemIds);
          console.log("Quantities:", quantities);
          console.log("Comments:", comments);
          console.log("Order Type:", formData.get("orderType"));
          console.log("Table ID:", formData.get("tableId"));
          console.log("Customer Name:", formData.get("customerName"));
          console.log("Customer Phone:", formData.get("customerPhone"));
          console.log("Payment Method:", formData.get("paymentMethod"));
          console.log("Delivery Address:", formData.get("deliveryAddress"));
          console.log("Employee ID:", formData.get("employeeId"));
          console.log("==============================");

          return true;
        });
    </script>

    <!-- Script del Sistema de Temas -->
    <div th:replace="~{fragments/theme :: themeScript}"></div>
  </body>
</html>
